<div style="color:blue" align=center>CAS实现单点登录（SSO）数据库查询认证机制自定义编码方式（四）</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">&nbsp; &nbsp; 通过</span><span lang="en-US">xml</span><span lang="zh-CN">配置方式实现数据库查询认证，的确简单但是不够灵活。但是如果登录验证逻辑稍微复杂些，可能通过这种</span><span lang="zh-CN">配置方式就不能满足需求了，比如：当用户登录时，需要判断该用户是否绑定了邮箱，如果未绑定，拒绝登录并给出提示信息。</span><span lang="en-US">&nbsp;</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN" style="font-size:14.0pt">&nbsp; &nbsp; 遇到类&#20284;的情况，就需要使用自定义登录来完成，并且给出的提示信息也需要是自定义的。</span><span lang="en-US" style="font-size:16.0pt"><strong>&nbsp;</strong></span></span></p>
<h1 style="margin-top:13pt; margin-bottom:13pt; font-size:16.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><strong>自定义登录验证（</strong></span><span lang="en-US"><strong></strong></span><span lang="zh-CN"><strong>默认实现</strong></span><span lang="en-US"><strong>QueryDatabaseAuthenticationHandler</strong></span><span lang="zh-CN"><strong>）</strong></span></span></h1>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">&nbsp; &nbsp; CAS</span><span lang="zh-CN">内置了一些</span><span lang="en-US">AuthenticationHandler</span><span lang="zh-CN">实现类，如下图所示，在</span><span lang="en-US">cas-server-support-jdbc</span><span lang="zh-CN">包中提供了基于</span><span lang="en-US">jdbc</span><span lang="zh-CN">的用户认证类。</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><img src="20198866180019" alt=""><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">&nbsp; &nbsp;如果需要实现自定义登录，只需要实现</span><span lang="en-US">org.jasig.cas.authentication.handler.AuthenticationHandler</span><span lang="zh-CN">接口即可，当然也可以利用已有的实现，比如创建一个继承自</span><span lang="en-US">org.jasig.cas.adaptors.jdbc.AbstractJdbcUsernamePasswordAuthenticationHandler</span><span lang="zh-CN">的类，实现方法可以参考</span><span lang="en-US">org.jasig.cas.adaptors.jdbc.QueryDatabaseAuthenticationHandler</span><span lang="zh-CN">类：</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">&nbsp;&nbsp;&nbsp;</span></span></p>
<p lang="en-US" style="margin:0in; font-size:14pt"><img src="30218678562628" alt="">&nbsp; &nbsp;</p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">修改</span><span lang="en-US">authenticateUsernamePasswordInternal</span><span lang="zh-CN">方法中的代码为自己的认证逻辑即可。</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">操作步骤：</span></p>
<p style="margin:0in; font-size:14pt">&nbsp;</p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">1</span><span lang="zh-CN">，</span><span lang="en-US">Eclipse</span><span lang="zh-CN">中引入cas-server-webapp项目，并在</span><span lang="en-US">lib</span><span lang="zh-CN">下添加两个</span><span lang="en-US">jar</span><span lang="zh-CN">包</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><img src="29794736319440" alt=""><br>
</span></span></p>
<img src="29737218857791" alt=""><br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin-top:13pt; margin-bottom:13pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">2</span><span lang="zh-CN">，自定义一个类，这个类的内容可以是复制</span><span lang="en-US">QueryDatabaseAuthenticationHandler</span></span></p>
<img src="43599899570107" alt=""><br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">类中的核心方法：</span></span></p>
<pre code_snippet_id="646992" snippet_file_name="blog_20150418_1_750157" name="code" class="java">@Override
    protected final boolean authenticateUsernamePasswordInternal(final UsernamePasswordCredentials credentials) throws AuthenticationException {
        //获取前台传递过来的值，用户名和密码
    	final String username = getPrincipalNameTransformer().transform(credentials.getUsername());
        final String password = credentials.getPassword();
        final String encryptedPassword = this.getPasswordEncoder().encode(
            password);
        
        try {
        	/**
        	 * 以下的代码为CAS的数据库认证默认实现，如果想编写自己的实现方式，可以删除一下代码实现自己的登录认证
        	 */        	
        	//sql为配置文件中配置的sql语句   	
        	final String dbPassword = getJdbcTemplate().queryForObject(this.sql, String.class, username);
            return dbPassword.equals(encryptedPassword);
                        
            } catch (final IncorrectResultSizeDataAccessException e) {
            // this means the username was not found.
            return false;
        }
    }
</pre><br>
<span lang="en-US" style="font-size:14pt; font-family:KaiTi_GB2312">3</span><span lang="zh-CN" style="font-size:14pt; font-family:KaiTi_GB2312">，根据业务需求编写自己的自定义登录方法，修改如下代码即可</span>
<p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<pre code_snippet_id="646992" snippet_file_name="blog_20150418_2_7812645" name="code" class="java">final String dbPassword = getJdbcTemplate().queryForObject(this.sql, String.class, username);
return dbPassword.equals(encryptedPassword);
</pre><br>
<span style="font-size:14pt; font-family:KaiTi_GB2312">当然也可以访问进行</span>
<p style="margin-top:13pt; margin-bottom:13pt; font-size:14pt"><a target="_blank" target="_blank" href="http://localhost:8080/cas-server-webapp/login">http://localhost:8080/cas-server-webapp/login</a>&nbsp;<span style="font-size:14pt"><span style="font-family:KaiTi_GB2312">调试。</span></span></p>
<p style="margin-top:13pt; margin-bottom:13pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">4<span lang="zh-CN">，配置使自定义登录认证生效</span></span></p>
<pre code_snippet_id="646992" snippet_file_name="blog_20150418_3_6369633" name="code" class="html">&lt;!-- 注释掉默认的配置，使用自定义类配置 --&gt;
				&lt;!-- &lt;bean class=&quot;org.jasig.cas.adaptors.jdbc.QueryDatabaseAuthenticationHandler&quot;&gt;
					&lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; &gt;&lt;/property&gt;
					&lt;property name=&quot;sql&quot; value=&quot;select password from t_user where login_name=?&quot; &gt;&lt;/property&gt;
					&lt;property name=&quot;passwordEncoder&quot; ref=&quot;MD5PasswordEncoder&quot; &gt;&lt;/property&gt;
				&lt;/bean&gt; --&gt;
				&lt;bean class=&quot;com.tgb.handler.CustomQueryDBHandler&quot;&gt;
					&lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; &gt;&lt;/property&gt;
					&lt;property name=&quot;sql&quot; value=&quot;select password from t_user where login_name=?&quot; &gt;&lt;/property&gt;
					&lt;!-- &lt;property name=&quot;passwordEncoder&quot; ref=&quot;MD5PasswordEncoder&quot; &gt;&lt;/property&gt; --&gt;
				&lt;/bean&gt;</pre>
<p><img src="45713648765426" alt=""><br>
</p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"></span></p>
<p style="margin-top:13pt; margin-bottom:13pt; font-size:14pt"><span style="font-family:KaiTi_GB2312">完成以上步骤，自定义登录即可实现！</span></p>
<p style="margin-top:13pt; margin-bottom:13pt; font-size:14pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<h1 style="margin-top:13pt; margin-bottom:13pt; font-size:16pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN" style="font-weight:bold">自定义错误提示消息（默认实现IncorrectResultSizeDataAccessException</span><span lang="en-US" style="font-weight:bold"></span><span lang="zh-CN" style="font-weight:bold">继承自RuntimeException）</span></span></h1>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US"><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">CAS AuthenticationException</span><span lang="zh-CN">结构如下图，</span><span lang="en-US">CAS</span><span lang="zh-CN">已经内置了一些异常，比如用户名密码错误、未知的用户名错误等。</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br>
</span></span></p>
<img src="28496158878899" alt=""><br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">当用户名输入正确，而密码错误时提示“密码错误”</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">只需要在自定义的</span><span lang="en-US">AuthenticationHandler</span><span lang="zh-CN">类的验证方法中，验证失败的地方抛出异常即可。</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">密码错误的异常类：</span></span></p>
<img src="32709968406906" alt=""><br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">请注意代码中的CODE私有属性，该属性定义了一个本地化资源文件中的键，通过该键获取本地化资源中对应语言的文字，这里只实现中文错误消息提示，修改WEB-INF/classes/messages_zh_CN.properties文件，添加</span></span><span style="font-family:KaiTi_GB2312; font-size:14pt">CODE定义的键&#20540;对，如下示例：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">error.authentication.credentials.bad.usernameorpassword.password=\u5bc6\u7801\u9519\u8bef</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<img src="27014618302771" alt=""><br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">后面的文字是使用jdk自带的native2ascii编码工具：native2ascii转换成utf-8&#26684;式。</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<img src="14144739469250" alt=""><br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">接下来只需要在自定义的AuthenticationHandler类的验证方法中，验证失败的地方抛出异常即可。</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">自定义AuthenticationHandler示例代码如下：</span></p>
<pre code_snippet_id="646992" snippet_file_name="blog_20150418_4_150875" name="code" class="java">@Override
    protected final boolean authenticateUsernamePasswordInternal(final UsernamePasswordCredentials credentials) throws AuthenticationException {
        //获取前台传递过来的值，用户名和密码
    	final String username = getPrincipalNameTransformer().transform(credentials.getUsername());
        final String password = credentials.getPassword();
        final String encryptedPassword = this.getPasswordEncoder().encode(
            password);
        
        try {
        	  final String dbPassword = null;
            if (dbPassword == null || dbPassword == &quot;&quot;) {
				throw new BadPasswordAuthenticationException();
			}
            return dbPassword.equals(encryptedPassword);
        } catch (final IncorrectResultSizeDataAccessException e) {
            // this means the username was not found.
            return false;
        }</pre>
<p style="margin:0in; font-size:14pt"><img src="27037545804353" alt="">&nbsp;</p>
<p style="margin:0in; font-size:14pt"><br>
</p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN" style="font-family:KaiTi_GB2312; font-size:19px">配置使自定义错误提示生效</span><span lang="en-US" style="font-family:KaiTi_GB2312; font-size:19px">&nbsp;</span><span lang="zh-CN" style="font-family:KaiTi_GB2312; font-size:19px">同上（配置自定义登录认证）！</span><br>
</p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN" style="font-family:KaiTi_GB2312; font-size:19px"><br>
</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">效果：</span></p>
<img src="32857249265128" alt=""><br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<h1 style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">总结：</span></h1>
<p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">通过以上的学习，我们知道</span><span lang="en-US">CAS</span><span lang="zh-CN">为我们提供了很多便利的扩展功能，它的这种方式也是我们在设计软件时必须要考虑和不断要加强的内容。</span></span></p>
<br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN" style="font-family:宋体"><br>
</span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN" style="font-family:宋体"><br>
</span></p>
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/45111703'>原文链接</a>