<div style="color:blue" align=center>AJAX写回分数简单理解AJAX</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

<p style="margin:0in; font-size:20.0pt"><span lang="en-US" style="font-family:Calibri">AJAX</span><span lang="zh-CN" style="font-family:SimSun">简介：</span></p>
<p style="margin:0in; font-family:SimSun; font-size:20.0pt">&nbsp;</p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">Ajax的全称是：</span><span lang="en-US">AsynchronousJavaScript&#43;XML</span><span lang="zh-CN">。Ajax不是一个技术，它实际上是几种技术，每种技术都有其独特之处，合在一起就成了一个功能强大的新技术。</span></span></p>
<p lang="en-US" style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">&nbsp;</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">使用</span><span lang="en-US">AJAX的异步模式，浏览器就不必等用户请求操作，也不必更新整个窗口就可以显示新获取的数据。只要来回传送采用XML&#26684;式的数据，在浏览器里面运行的JavaScript代码就可以与服务器进行联系。JavaScript代码还可以把样式表加到检索到的数据上，然后在现有网页的某个部分加以显示。</span></span></p>
<p lang="en-US" style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">&nbsp;</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">通过代码先理解一下</span><span lang="en-US">AJAX</span><span lang="zh-CN">是如何实现局部刷新滴！</span></span></p>
<p style="margin:0in; font-family:SimSun; font-size:10.5pt">
<pre code_snippet_id="95079" snippet_file_name="blog_20131203_1_6536084" name="code" class="csharp">        /// &lt;summary&gt;
        /// 显示一道试题的题干和答案以及答题记录
        /// &lt;/summary&gt;
        public void ShowOneExamOneTypeOneQuestion(int pageIndex)
        {

            //得到试题id
            DataTable dt=(DataTable)Session[&quot;dtOneTypeQuestionId&quot;];
            int indexQus=(int)Session[&quot;questionIndex&quot;];
            int intquestionIndex = (int)dt.Rows[indexQus][&quot;QuestionID&quot;];
            Session[&quot;questionIndexhjy&quot;] = intquestionIndex;
            //获取考试id值
            string ExamID = DropExam.SelectedItem.Value;
            //Session[&quot;ExamIDHJY&quot;] = ExamID;
            //查找试题记录--答题记录表
            string tableRecord = Convert.ToString(Session[&quot;tableRecord&quot;]);
            //题型的value
            string UserName = Session[&quot;UserNo&quot;].ToString();
            //string UserName = &quot;xvshu&quot;;
            string questionType = dropQuestionType.SelectedItem.Value;
            //调用王永俊的方法，查看答题记录前20条，并写入教师姓名
            string isCheck;
            if (chkIsChecked.Checked == true)
            {
                isCheck = &quot;是&quot;;
            }
            else
            {
                isCheck = &quot;否&quot;;
            }
            Session[&quot;isCheckhjy&quot;] = isCheck;
           //给hashtable赋值
            Hashtable map = new Hashtable();
            map.Add(&quot;TableNameRecord&quot;, tableRecord);//题型value和表名
            map.Add(&quot;QuestionType&quot;, questionType);
            map.Add(&quot;Teacher&quot;, UserName);
            map.Add(&quot;QuestionID&quot;, intquestionIndex);
            map.Add(&quot;ExamID&quot;, ExamID);
            map.Add(&quot;IsCheck&quot;, isCheck);

            QuestionContextBLL awardingBLL = new QuestionContextBLL(map);
        
            //查出答题记录
            DataTable dtOneQuestionRecords = awardingBLL.SelectRecordTopbyQuestionID(map);

            if (dtOneQuestionRecords.Rows.Count == 0) {
                Session[&quot;questionType&quot;] = null;
                //MessageBox.Show(this, &quot;已判完此题！&quot;);
                lblMessage.Text = &quot;已判完此题！&quot;;
                return;
            }
            Session[&quot;record&quot;] = dtOneQuestionRecords;
            //循环写入教师姓名
            for (int i = 0; i &lt; dtOneQuestionRecords.Rows.Count; i++)
            {
                string id = dtOneQuestionRecords.Rows[i][0].ToString();
                Hashtable hmap = new Hashtable();
                hmap.Add(&quot;TableNameRecord&quot;, tableRecord);//题型value和表名
                hmap.Add(&quot;QuestionType&quot;, questionType);
                hmap.Add(&quot;Teacher&quot;, UserName);
                hmap.Add(&quot;ExamID&quot;, ExamID);
                hmap.Add(&quot;ID&quot;, id);
                bool bolTeacher = awardingBLL.UpdateRecordTeacherByID(hmap);
            }
           

            //得到试题id集合--所有达此试题id的答题记录
            DataTable dtOneTypeQuestionId = (DataTable)(Session[&quot;dtOneTypeQuestionId&quot;]);

            //DataTable dtOneTypeQuestionId = dtOneQuestionRecords.Columns[&quot;QuestionID&quot;];
            //获取题库表名
            string tableName = Convert.ToString(Session[&quot;tableName&quot;]);
           
           
            if (dtOneTypeQuestionId == null || dtOneTypeQuestionId.Rows.Count &lt;= 0)
            {
                return;
            }
            if (dropQuestionType.SelectedItem.Value.Trim() == &quot;请选择&quot;)
            { return; }

            //查找试题
            Hashtable mapQuestion = new Hashtable();
            int questionID = Convert.ToInt32(dtOneTypeQuestionId.Rows[indexQus][&quot;QuestionID&quot;]);
            mapQuestion.Add(&quot;TableName&quot;, tableName);
            mapQuestion.Add(&quot;QuestionID&quot;,questionID);
            mapQuestion.Add(&quot;QuestionType&quot;, questionType);
            QuestionContextBLL contentBLL = new QuestionContextBLL(mapQuestion);
            DataTable dtOneQuestion = contentBLL.SelectQuestionContentbyRecordQuestionID(mapQuestion);
           

            fenzhi = dtOneQuestion.Rows[0][&quot;Fraction&quot;].ToString();

            //显示题干
            web_class_mark.CreatQuestion createQuestion = new web_class_mark.CreatQuestion();
            web_class_mark.QuestionsPage questionPage = new web_class_mark.QuestionsPage();
            DataSet dsAllQuestion = new DataSet();
            dsAllQuestion.DataSetName = &quot;T_hejingyuan&quot;;
            dtOneQuestion.TableName = dropQuestionType.SelectedItem.Value.Trim();
            dsAllQuestion.Tables.Add(dtOneQuestion.Copy());
            questionPage = createQuestion.StuCreateQuestion(dsAllQuestion, questionBody, &quot;0&quot;, &quot;00000&quot;, &quot;00000&quot;,&quot;000&quot;);
            questionPage.ShowPage();


            //显示答案
          
            Session[&quot;Fraction&quot;] = dtOneQuestion.Rows[0][&quot;Fraction&quot;].ToString();
           
            lblQuestionAnswer.Text = dtOneQuestion.Rows[0][&quot;CorrectAnswer&quot;].ToString();
          

            ///何静媛2013年11月22日
            Session[&quot;answerRecordCount&quot;] = dtOneQuestionRecords.Rows.Count;

            //界面上显示出共有多少条答题记录
            lblRecordCount.Text = dtOneQuestionRecords.Rows.Count.ToString();
            //显示答题记录
            ShowAnswerRecord(dtOneQuestionRecords, tableRecord, pageIndex);

           
        }

        /// &lt;summary&gt;
        /// 显示某道试题的答题记录，显示某一部分。
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;dtOneQuestionRecords&quot;&gt;查询出的要显示的所有答题记录集合&lt;/param&gt;
        /// &lt;param name=&quot;pageIndex&quot;&gt;要显示某个区间段的&lt;/param&gt;
        private void ShowAnswerRecord(DataTable dtOneQuestionRecords, string tableRecord, int pageIndex)
        {
            myframe.Attributes[&quot;src&quot;] = &quot;StuRecords.aspx&quot;;
        }
</pre>
<p>
<p style="margin:0in; font-family:SimSun; font-size:10.5pt"><br>
</p>
<span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="en-US">IFrame</span><span lang="zh-CN">页面代码</span><span lang="en-US">(</span><span lang="zh-CN">StuRecords.aspx</span><span lang="en-US">)</span><span lang="zh-CN">：</span></span>
<p style="margin:0in; font-family:SimSun; font-size:10.5pt">
<pre code_snippet_id="95079" snippet_file_name="blog_20131203_2_1203147" name="code" class="csharp">        /// &lt;summary&gt;
        /// 窗体加载时，判断session的值是否为空，空则加载子窗体空白页，否则执行子窗体的事件
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
        /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
        protected void Page_Load(object sender, EventArgs e)
        {
            if (Session[&quot;questionType&quot;] != null &amp;&amp; Session[&quot;ExamIDHJY&quot;]!=null)
            {
                lblFraction.Text = &quot;&quot;;
                ShowStuRecord();
            }
            else {
                tblAutoTable.Controls.Clear();
            }
        }

        public void ShowStuRecord() {

            //得到试题id
            int questionIndex = Convert.ToInt32(Session[&quot;questionIndexhjy&quot;]);

            //获取考试id值

            string ExamID = Session[&quot;ExamIDHJY&quot;].ToString();
           
            //查找试题记录--答题记录表
            string tableRecord = Convert.ToString(Session[&quot;tableRecord&quot;]);
            //题型的value
            string UserName = Session[&quot;UserNo&quot;].ToString();
            //string UserName = &quot;xvshu&quot;;
            string questionType = Session[&quot;questionType&quot;].ToString();

            //调用王永俊的方法，查看答题记录前20条，并写入教师姓名
            string isCheck = Session[&quot;isCheckhjy&quot;].ToString();
            Hashtable map = new Hashtable();
            map.Add(&quot;TableNameRecord&quot;, tableRecord);//题型value和表名
            map.Add(&quot;QuestionType&quot;, questionType);
            map.Add(&quot;Teacher&quot;, UserName);
            map.Add(&quot;QuestionID&quot;, questionIndex);
            map.Add(&quot;ExamID&quot;, ExamID);
            map.Add(&quot;IsCheck&quot;, isCheck);
            QuestionContextBLL awardingBLL = new QuestionContextBLL(map);

            //查出答题记录
            DataTable dtOneQuestionRecords = awardingBLL.SelectRecordTopbyQuestionID(map);

            Session[&quot;recordCountHJY&quot;]=dtOneQuestionRecords.Rows.Count;
            if (dtOneQuestionRecords.Rows.Count == 0)
            {
                if (isCheck == &quot;是&quot;)
                {
                    MessageBox.Show(this, &quot;没有已判的答题记录！&quot;);
                }
                else {
                    MessageBox.Show(this, &quot;此题已经判完，请点击下一试题！&quot;);
                }
            }

            lblFraction.Text = &quot;标准分数：&quot; + Session[&quot;Fraction&quot;];
            int pageIndex = 0;
            for (int i = 5000 * pageIndex; i &lt; 5000 * pageIndex + 5000 &amp;&amp; i &lt; dtOneQuestionRecords.Rows.Count; i++)
            {
                //显示答写的试题答案
                TableCell tc = new TableCell();
                tc.Text = (i + 1).ToString() + &quot;答案:&quot; + dtOneQuestionRecords.Rows[i][&quot;ExamAnswer&quot;].ToString();

                TableRow tr = new TableRow();
                //设置实例化的tr的宽度
                tr.Width = System.Web.UI.WebControls.Unit.Pixel(720);
                tr.Cells.Add(tc);
                tblAutoTable.Rows.Add(tr);

                TextBox textBox = new TextBox();
                //得到试题记录的id号
                string id = dtOneQuestionRecords.Rows[i][&quot;ID&quot;].ToString();
                textBox.Text = dtOneQuestionRecords.Rows[i][&quot;Fraction&quot;].ToString();
                //给评分控件设置id号
                textBox.ID = tableRecord.Trim() + dtOneQuestionRecords.Rows[i][&quot;ID&quot;].ToString();
	        //给textbox注册Onblur（失去焦点）事件
                textBox.Attributes.Add(&quot;Onblur&quot;, &quot;javascript:return CheckFraction(event.srcElement)&amp;&amp;JudgeQuestions(&#39;&quot; + tableRecord.Trim() + &quot;&#39;,&#39;&quot; + id + &quot;&#39;,&#39;&quot; + textBox.ID + &quot;&#39;)&quot;);
              
                TableCell tc1 = new TableCell();
                tc1.Controls.Add(textBox);
                TableRow tr1 = new TableRow();
                tr1.Cells.Add(tc1);
                tblAutoTable.Rows.Add(tr1);
               
            }

        }
</pre><br>
<p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="en-US">JS</span><span lang="zh-CN">代码：</span></span></p>
<p style="margin:0in; font-size:10.5pt"><span lang="zh-CN" style="font-family:SimSun"></span></p>
<pre code_snippet_id="95079" snippet_file_name="blog_20131203_3_6044933" name="code" class="javascript">//更新一道试题的得分
function JudgeQuestions(tableName, questionId, TextBoxId) {
    
    //读取所给分数ctl00$ContentPlaceHolder1$t_
    //TextBoxId = &quot;ContentPlaceHolder1_&quot; + TextBoxId;
    TextBoxId = TextBoxId;
    var fraction = document.getElementById(TextBoxId).value;
    //修改分数的正则表达式允许有小数
    var pattern = /^[0-9]+(.[0-9]{1})?|([0-9]|[1-9][0-9]|100)$/;
    //  var pattern = /^([0-9]|[1-9][0-9]|100)$/;
    var flag = pattern.test(fraction);
    if (flag == false) {

        alert(&quot;分数应该是数字类型&quot;);
        return false;
    }


    createXMLHTTP(); //创建XMLHttpRequest对象，XMLHttpRequest可以提供不重新加载页面的情况下更新网页
    var url = &quot;MarkToServer.aspx?tableName=&quot; + tableName + &quot;&amp;id=&quot; + questionId + &quot;&amp;fraction=&quot; + fraction + &quot;&amp;Event=&quot; + &quot;Judge&quot;;

    xmlHttp.open(&quot;Post&quot;, url, true);
    //发送一个请求后，客户端无法确定什么时候会完成这个请求，所以需要用事件机制来捕获请求的状态
    //onreadyStateChange事件可指定一个事件处理函数来处理XMLHttpRequest对象的执行结果
    xmlHttp.onreadystatechange = JudgeResult;
    //xmlhttp的send是传递参数用的,但是只有在使用post方式提交请求的时候才有用
    xmlHttp.send(null);


}

//readyState有五种可取值0：尚未初始化，1：正在加载，2：加载完毕，3：正在处理；4：处理完毕。一旦readyState属性的值变成了4，就可以从服务器返回的响应数据进行访问了。
//Status存储了服务器端返回的Http请求响应代码，它表示请求的处理结果，常见响应代码的含义如右。在Ajax开发中，最常用就是200这个响应码，代码如下：

//判断判卷是否成功
function JudgeResult() {
    if (xmlHttp.readyState == 4) {
        if (xmlHttp.status == 200) {
	//是后台返回到前台的消息
            if (xmlHttp.responseText == &quot;true&quot;) {
            }
            else {
                alert(&quot;评分失败，请重新评分或者联系管理员&quot;);

            }
        }
    }

}
</pre><br>
<p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">MarkToServer</span><span lang="en-US">.aspx</span><span lang="zh-CN">页面：</span></span></p>
<p style="margin:0in">
<pre code_snippet_id="95079" snippet_file_name="blog_20131203_4_7506412" name="code" class="csharp"> protected void Page_Load(object sender, EventArgs e)
        {
            //分别得到数据表名称、试题id、试题所得分数
            //调用王永俊的方法往回更新值
            //获取传来的参数值
            string questionType = Session[&quot;questionType&quot;].ToString();
            string tableName = Request.QueryString[&quot;tableName&quot;].ToString();
            int id = Convert.ToInt32(Request.QueryString[&quot;id&quot;].ToString());
            decimal fraction = Convert.ToDecimal(Request.QueryString[&quot;fraction&quot;].ToString());
            //获取时间戳
            PublicBLL pubBLL = new PublicBLL();
            string timestamp = pubBLL.GetTime();
            if (Request.QueryString[&quot;Event&quot;].ToString() == &quot;Judge&quot;)
            {
                Hashtable map=new Hashtable();
                //给hashtable赋值传参
                map.Add(&quot;TableNameRecord&quot;, tableName);
                map.Add(&quot;Fraction&quot;, fraction);
                map.Add(&quot;ID&quot;, id);
                map.Add(&quot;QuestionType&quot;, questionType);
                map.Add(&quot;Timestamp&quot;, timestamp);
                QuestionContextBLL questionContext = new QuestionContextBLL(map);

                //调用B层方法，返回是否成功
                if (questionContext.UpdateRecordFractionbyID(map))
                {
                    Response.Write(&quot;true&quot;);
                    Response.End();
                }
                else {
                    Response.Write(&quot;false&quot;);
                    Response.End();
                }
            }

        }</pre>
<p>
<br>
<span lang="zh-CN" style="font-family:SimSun"></span>
<p>
<p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">总结：</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">&nbsp;</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">Attributes.Add(&quot;javascript事件</span><span lang="en-US">&quot;,&quot;javascript语句&quot;);</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">例如：Button1.Attributes.Add(&quot;onclick&quot;, &quot;returncheckSame()&quot;);//为</span><span lang="en-US">Button1添加onclick()事件,Button为服务器控件</span></span></p>
<p lang="en-US" style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">&nbsp;</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">传统的</span><span lang="en-US"> web 应用程序会把数据提交到 web 服务器（使用 HTML 表单）。在 web服务器把数据处理完毕之后，会向用户返回一张完整的新网页。</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">由于每当用户提交输入，服务器就会返回新网页，传统的</span><span lang="en-US"> web 应用程序往往运行缓慢，且越来越不友好。</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">通过</span><span lang="en-US"> AJAX，web 应用程序无需重载网页，就可以发送并取回数据。完成这项工作，需要通过向服务器发送 HTTP请求（在幕后），并通过当服务器返回数据时使用 JavaScript 仅仅修改网页的某部分。</span></span></p>
<br>
<p style="margin:0in; font-family:SimSun; font-size:10.5pt"><br>
</p>
<p style="margin:0in; font-family:SimSun; font-size:10.5pt"><br>
</p>
<br>
<br>
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/17053751'>原文链接</a>