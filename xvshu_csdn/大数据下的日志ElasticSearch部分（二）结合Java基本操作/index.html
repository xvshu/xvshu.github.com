<div style="color:blue" align=center>大数据下的日志ElasticSearch部分（二）结合Java基本操作</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

ElasticSearch(名称太长，后面简称ES)作为一个搜索引擎，目前可谓是如日中天，几乎和solr齐驾并驱。关于他能做什么，跟云计算有什么关系，在此不再描述。但是ES的官方文档，特别是关于java的客户端文档，真是少的可怜，甚至连个完整的增删改的示例都没有。在此，我就献丑了。<br>
在开始讲解之前，还是先做个铺垫，为了能够有一个可以索引的模型，我们自定义了一个模型，暂时起个名称叫LogModel吧，这个模型有各种数据类型，int,long,String,list，但千万不要认为这是跟记录日志有关的一个模型。作为索引的一个最简单模型。代码如下：<br>
Java代码 &nbsp;收藏代码<br>
import java.util.ArrayList; &nbsp;<br>
import java.util.List; &nbsp;<br>
import java.util.Random; &nbsp;<br>
import java.util.UUID; &nbsp;<br>
/**&nbsp;<br>
&nbsp;* 瞎编的一个模型，跟日志基本没有关系&nbsp;<br>
&nbsp;* @author donlian&nbsp;<br>
&nbsp;*/ &nbsp;<br>
public class LogModel { &nbsp;<br>
&nbsp; &nbsp; //主ID &nbsp;<br>
&nbsp; &nbsp; private long id; &nbsp;<br>
&nbsp; &nbsp; //次ID &nbsp;<br>
&nbsp; &nbsp; private int subId; &nbsp;<br>
&nbsp; &nbsp; /**&nbsp;<br>
&nbsp; &nbsp; &nbsp;* 系统名称&nbsp;<br>
&nbsp; &nbsp; &nbsp;*/ &nbsp;<br>
&nbsp; &nbsp; private String systemName; &nbsp;<br>
&nbsp; &nbsp; private String host; &nbsp;<br>
&nbsp; &nbsp; &nbsp;&nbsp;<br>
&nbsp; &nbsp; //日志描述 &nbsp;<br>
&nbsp; &nbsp; private String desc; &nbsp;<br>
&nbsp; &nbsp; private List&lt;Integer&gt; catIds; &nbsp;<br>
&nbsp; &nbsp; public LogModel(){ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; Random random = new Random(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.id = Math.abs(random.nextLong()); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; int subId = Math.abs(random.nextInt()); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.subId = subId; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; List&lt;Integer&gt; list = new ArrayList&lt;Integer&gt;(5); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; for(int i=0;i&lt;5;i&#43;&#43;){ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list.add(Math.abs(random.nextInt())); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.catIds = list; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.systemName = subId%1 == 0?&quot;oa&quot;:&quot;cms&quot;; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.host = subId%1 == 0?&quot;10.0.0.1&quot;:&quot;10.2.0.1&quot;; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.desc = &quot;中文&quot; &#43; UUID.randomUUID().toString(); &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
&nbsp; &nbsp; public LogModel(long id,int subId,String sysName,String host,String desc,List&lt;Integer&gt; catIds){ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.id = id; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.subId = subId; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.systemName = sysName; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.host = host; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.desc = desc; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.catIds = catIds; &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
...//省去get,set方法 &nbsp;<br>
} &nbsp;<br>
&nbsp;同时，因为ES在索引的时候，一般都用json&#26684;式，因此，使用jackson定义了一个将对象转化成json的工具类，也很简单，代码：<br>
Java代码 &nbsp;收藏代码<br>
public class ESUtils { &nbsp;<br>
&nbsp; &nbsp; private static ObjectMapper objectMapper = new ObjectMapper(); &nbsp;<br>
&nbsp; &nbsp; public static String toJson(Object o){ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; try { &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return objectMapper.writeValueAsString(o); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; } catch (JsonProcessingException e) { &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; e.printStackTrace(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return &quot;&quot;; &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
} &nbsp;<br>
&nbsp;在开始进行操作ES服务器之前，我们必须得获得ES的API，简单介绍一下ES操作服务器的两种方式，一种是使用Node方式，即本机也启动一个ES，然后跟服务器的ES进行通信，这个node甚至还能存储（奇怪，一般需要这样的方式吗？），另一种，就是下面我介绍的这一种，通过一个对象使用http协议跟服务器进行交互。<br>
获得一个ES客户端API的代码如下：<br>
Java代码 &nbsp;收藏代码<br>
Settings settings = ImmutableSettings.settingsBuilder() &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //指定集群名称 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .put(&quot;cluster.name&quot;, &quot;elasticsearch&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //探测集群中机器状态 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .put(&quot;client.transport.sniff&quot;, true).build(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; /*&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* 创建客户端，所有的操作都由客户端开始，这个就好像是JDBC的Connection对象&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* 用完记得要关闭&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; Client client = new TransportClient(settings) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; .addTransportAddress(new InetSocketTransportAddress(&quot;192.168.1.106&quot;, 9300)); &nbsp;<br>
&nbsp;Client对象，可以理解为数据库的Connection对象。好了，准备工作完成，下面就开始增删改查。<br>
&nbsp;Index(增加）<br>
<br>
<br>
ES里面的增加对象不叫什么add,save等，叫index。但无论叫什么名称，反正就是向ES服务器里面加数据。上面说过一个对象转json的工具类，其实ES的API中，是自带构建json的工具类的。<br>
Java代码 &nbsp;收藏代码<br>
import org.elasticsearch.action.index.IndexResponse; &nbsp;<br>
import org.elasticsearch.client.Client; &nbsp;<br>
import org.elasticsearch.client.transport.TransportClient; &nbsp;<br>
import org.elasticsearch.common.settings.ImmutableSettings; &nbsp;<br>
import org.elasticsearch.common.settings.Settings; &nbsp;<br>
import org.elasticsearch.common.transport.InetSocketTransportAddress; &nbsp;<br>
&nbsp;&nbsp;<br>
import com.donlianli.es.ESUtils; &nbsp;<br>
import com.donlianli.es.model.LogModel; &nbsp;<br>
/**&nbsp;<br>
&nbsp;* 向ES添加索引对象&nbsp;<br>
&nbsp;* @author donlian&nbsp;<br>
&nbsp;*/ &nbsp;<br>
public class IndexTest { &nbsp;<br>
&nbsp; &nbsp; public static void main(String[] argv){ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; Settings settings = ImmutableSettings.settingsBuilder() &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //指定集群名称 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .put(&quot;cluster.name&quot;, &quot;elasticsearch&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //探测集群中机器状态 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .put(&quot;client.transport.sniff&quot;, true).build(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; /*&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* 创建客户端，所有的操作都由客户端开始，这个就好像是JDBC的Connection对象&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* 用完记得要关闭&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; Client client = new TransportClient(settings) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; .addTransportAddress(new InetSocketTransportAddress(&quot;192.168.1.106&quot;, 9300)); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; String json = ESUtils.toJson(new LogModel()); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; //在这里创建我们要索引的对象 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; IndexResponse response = client.prepareIndex(&quot;twitter&quot;, &quot;tweet&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //必须为对象单独指定ID &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .setId(&quot;1&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .setSource(json) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .execute() &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .actionGet(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; //多次index这个版本号会变 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; System.out.println(&quot;response.version():&quot;&#43;response.version()); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; client.close(); &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
} &nbsp;<br>
&nbsp;运行这个代码，就向ES插入了一条数据，你运行两遍，还是一条。ES根据你设置的ID来设置对象，如果没有则插入，有则更新。每更新一次，对应的version加1.<br>
好了，在次，使用以下命令，应该能够查询到一条记录了。<br>
Java代码 &nbsp;收藏代码<br>
curl -XGET 'http://localhost:9200/twitter/tweet/1' &nbsp;<br>
&nbsp;<br>
&nbsp;delete(删除）<br>
<br>
<br>
有了增加的例子，删除的例子也就好写了。增加是prepareIndex，删除是prepareDelete,查询就是PrepareGet。<br>
代码如下：<br>
Java代码 &nbsp;收藏代码<br>
import org.elasticsearch.action.delete.DeleteResponse; &nbsp;<br>
import org.elasticsearch.client.Client; &nbsp;<br>
import org.elasticsearch.client.transport.TransportClient; &nbsp;<br>
import org.elasticsearch.common.settings.ImmutableSettings; &nbsp;<br>
import org.elasticsearch.common.settings.Settings; &nbsp;<br>
import org.elasticsearch.common.transport.InetSocketTransportAddress; &nbsp;<br>
&nbsp;&nbsp;<br>
import com.donlianli.es.ESUtils; &nbsp;<br>
&nbsp;&nbsp;<br>
public class DeleteTest { &nbsp;<br>
&nbsp; &nbsp; public static void main(String[] argv){ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; Settings settings = ImmutableSettings.settingsBuilder() &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //指定集群名称 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .put(&quot;cluster.name&quot;, &quot;elasticsearch&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //探测集群中机器状态 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .put(&quot;client.transport.sniff&quot;, true).build(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; /*&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* 创建客户端，所有的操作都由客户端开始，这个就好像是JDBC的Connection对象&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* 用完记得要关闭&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; Client client = new TransportClient(settings) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; .addTransportAddress(new InetSocketTransportAddress(&quot;192.168.1.106&quot;, 9300)); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; //在这里创建我们要索引的对象 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; DeleteResponse response = client.prepareDelete(&quot;twitter&quot;, &quot;tweet&quot;, &quot;1&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .execute().actionGet(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; System.out.println(response.getId()); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; System.out.println(ESUtils.toJson(response.getHeaders())); &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
} &nbsp;<br>
&nbsp;<br>
GET(查询）<br>
<br>
<br>
Java代码 &nbsp;收藏代码<br>
import org.elasticsearch.action.get.GetResponse; &nbsp;<br>
import org.elasticsearch.client.Client; &nbsp;<br>
import org.elasticsearch.client.transport.TransportClient; &nbsp;<br>
import org.elasticsearch.common.settings.ImmutableSettings; &nbsp;<br>
import org.elasticsearch.common.settings.Settings; &nbsp;<br>
import org.elasticsearch.common.transport.InetSocketTransportAddress; &nbsp;<br>
&nbsp;&nbsp;<br>
public class GetTest { &nbsp;<br>
&nbsp; &nbsp; public static void main(String[] argv){ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; Settings settings = ImmutableSettings.settingsBuilder() &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //指定集群名称 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .put(&quot;cluster.name&quot;, &quot;elasticsearch&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //探测集群中机器状态 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .put(&quot;client.transport.sniff&quot;, true).build(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; /*&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* 创建客户端，所有的操作都由客户端开始，这个就好像是JDBC的Connection对象&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* 用完记得要关闭&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; Client client = new TransportClient(settings) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; .addTransportAddress(new InetSocketTransportAddress(&quot;192.168.1.106&quot;, 9300)); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; //在这里创建我们要索引的对象 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; GetResponse response = client.prepareGet(&quot;twitter&quot;, &quot;tweet&quot;, &quot;1&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .execute().actionGet(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; System.out.println(&quot;response.getId():&quot;&#43;response.getId()); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; System.out.println(&quot;response.getSourceAsString():&quot;&#43;response.getSourceAsString()); &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
} &nbsp;<br>
&nbsp;好了，增删改查的代码写完。至于搜索，那是一个比较深入的话题，我也在慢慢探索。我时间我会继续写下去。<br>
&nbsp;
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/xvshu/article/details/48916793'>原文链接</a>