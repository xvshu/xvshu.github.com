<div class="articleLocationOnion"><a href='../../index.html'>首页: </a> &gt; <a href='../index_s.html'>未分类</a> &gt; 【NoSql】Redis实践篇安全性与主从复制配置（二）</div><div style="color:blue" align=center>【NoSql】Redis实践篇安全性与主从复制配置（二）</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">
<p style="margin: 0in; font-size: 14pt;"><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><h1 style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">一：安全性</span></h1><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">为redis设置密码：设置客户端连接后进行任何其他指定前需要实用的密码。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">警告：因为redis速度非常快，所以在一台较好的服务器下，一个外部用户可以在一秒钟进行150k次的密码尝试，这意味着你需要指定非常非常强大的密码来防止暴力破解。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">修改密码的方法：</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">只需要在redis的配置文件redis.conf中开启requirepass就可以了，比如我设置我的访问密码是</span><span lang="en-US">hejingyuan</span></span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="en-US"><br></span></span></p><p style="margin:0in"><span style="font-family:KaiTi_GB2312;"><img src="47115685930541" alt=""><br></span></p><p style="margin:0in;font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312;"><br></span></span></p><p style="margin:0in;font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312;">requirepass hejingyuan</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">在redis.conf中加入这一行代码之后，需要重新启动</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">然后我们用客户端（redis-cli）发现还能登陆进来，但是当我们执行操作的时候，比如keys*就会如下错误：</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">如图：</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin:0in"><span style="font-family:KaiTi_GB2312;"><img src="51213767026375" alt=""><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">在这里redis支持两种授权方式，一种就是直接用auth命令进行授权：</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">输入正确的密码，返回ok，授权成功，之后就可以进行所有的操作。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">如果我们不想每次登录进来之后都要用auth进行授权，那么我们可以采用另一种授权方式，就是在登陆客户端的时候用-a来指定密码</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">如图：</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin:0in"><span style="font-family:KaiTi_GB2312;"><img src="17822797055675" alt=""><br></span></p><p style="margin:0in"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">上面的密码如果输错，也能进入，但是之后不能进行操作。需要用auth重新进行授权。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><h1 style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">二：主从复制</span></h1><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">Redis的主从复制功能非常强大，一个master可以拥有多个slave，而一个slave又可以拥有多个slave，如此下去，形成了强大的多级服务器集群架构。</span></p><p style="margin:0in"><span style="font-family:KaiTi_GB2312;"><img src="16370658841154" alt=""><br></span></p><h2 style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">执行过程：</span></h2><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">1.slave与master建立连接，发送sync同步命令。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">2.Master会启动一个后台进程，将数据库快照保存到文件中，同时master主进程会开始收集新的写命令并缓存。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">3.后台完成保存后，将文件发送给slave</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">4.slave将文件保存到硬盘上</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><h2 style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">特点：</span></h2><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">1.master可以有多个slave</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">2.除了多个slave连到相同的master外，slave也可以连接其他slave形成图状结构（这样做的原因是如果master</span><span lang="en-US"> </span><span lang="zh-CN">down掉之后其中的一台slave立马可以充当master的角色，这样整个服务流程不受影响）</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">3.主从复制不会阻塞master。也就是说当一个或多个slave与master进行初次同步数据时，master可以继续处理client发来的请求。相反slave在初次同步数据时则会阻塞不能处理client的请求。</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">4.主从复制可以用来提高系统的可伸缩性,我们可以用多个slave专门用于client的读请求，比如sort操作可以使用slave来处理（需要配置</span><span lang="en-US">slave</span><span lang="zh-CN">）。也可以用来做简单的数据冗余</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">5.可以在master禁用数据持久化，只需要注释掉master配置文件中的所有save配置，然后只在slave上配置数据持久化即Master可以将数据保存操作交给Slaves完成，从而避免了在Master中要有独立的进程来完成此操作。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><h2 style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">实战：</span></h2><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">通过上面的介绍，我们对redis的主从复制有了个大概了解，下面讲讲具体怎么配置master/slave。由于条件限制，这里用一台机器，启动两个进程来进行主从复制。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">master server配置文件master.conf， 主要配置如下：</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">port 6379&nbsp; </span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">#save 900 1&nbsp; </span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">#save 300 10&nbsp; </span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">#save 60 10000&nbsp; </span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">slave server配置文件slave.conf，主要配置如下：</span></p><p style="margin: 0in; font-size: 14pt;" lang="en-US"><span style="font-family:KaiTi_GB2312;">注：如果配置了安全认证一定要在slave的配置文件中设置masterauth hejingyuan&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;" lang="en-US"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="en-US">Slave</span><span lang="en-US">1</span><span lang="zh-CN">：</span></span></p><p style="margin: 0in; font-size: 14pt;" lang="en-US"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">port 6380&nbsp; </span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">save 900 1&nbsp; </span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">save 300 10&nbsp; </span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">save 60 10000&nbsp; </span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">slaveof 192.168.24.215 6379</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="en-US">Slave</span><span lang="en-US">2</span><span lang="zh-CN">：</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">port638</span><span lang="en-US">1</span><span lang="zh-CN">&nbsp; </span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">save 900 1&nbsp; </span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">save 300 10&nbsp; </span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">save 60 10000&nbsp; </span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">slaveof 192.168.24.215 6379</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span style="color:#cc0000;"><span lang="zh-CN">启动</span><span lang="en-US">master的server及客户端，然后启动两个slave的server及相应的客户端</span></span></span></p><p style="margin: 0in; font-size: 14pt;" lang="en-US"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">测试运行：&nbsp;</span><span style="font-family: KaiTi_GB2312; font-size: 14pt;">连接master 的客户端，写入数据；连接 slave 的客户端，读数据</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family: KaiTi_GB2312;"><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><img src="49600669516956" alt="">&nbsp;</span></p><p style="margin:0in"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">从测试结果看，数据确实自动复制了。通过复制功能，我们可以在master上只写数据，在slave上读数据，关闭master的持久化（或aof）功能（在salve上开启），从而分担master服务器读压力，提高master服务器性能，同时，master挂了，可以快速地用slave server来替换master server，提高系统的可用性。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">在实际环境中，我们可以根据redis复制特点，定制适合我们自己的复制架构。比如，采用master server -&gt;slave server -&gt;slave server -&gt;slave server这种一拖一【或一拖一再拖多】的方式，和常规的一拖多方式相比，这种方式更能减少master server在复制数据时的压力。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">又如，单台redis主会遇到单点故障的问题，为了解决redis的高可用。接下来我们想达到的目的是，一个master带一个slave，而slave又带了一个slave，这样的好处是，当master故障后，直接把slaver1改为master，其他的配置不需要修改，服务又可以正常使用。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><img src="50647749289104" alt="">&nbsp;</span></p><p style="margin:0in"><br></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">修改相应的配置</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">将slave</span><span lang="en-US">2</span><span lang="zh-CN">配置文件进行修改，其他不变</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">save 900 1</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">save 300 10</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">save 60 10000</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">slaveof 192.168.24.21</span><span lang="en-US">4</span><span lang="zh-CN"> 63</span><span lang="en-US">79</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">当master故障后，需要在slave1上首先执行slaveof no one命令，再次执行info Replication时，它已经转为master了，此时slave2不受影响。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:Calibri" lang="en-US"><br></span></p>   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/47614121'>原文链接</a>