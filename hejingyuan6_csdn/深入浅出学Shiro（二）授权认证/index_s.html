<div class="articleLocationOnion"><a href='../../index.html'>首页: </a> &gt; <a href='../index_s.html'>未分类</a> &gt; 深入浅出学Shiro（二）授权认证</div><div style="color:blue" align=center>深入浅出学Shiro（二）授权认证</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp; &nbsp; 授权即访问控制，它将判断用户在应用程序中对资源是否拥有相应的访问权限。如，判断一个用户有查看页面的权限，编辑数据的权限，拥有某一按钮的权限，以及是否拥有打印的权限等等。</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp; &nbsp; 认证通过后接受 Shiro授权检查，授权验证时，需要判断当前角色是否拥有该权限。只有授权通过，才可以访问受保护 URL 对应的资源，否则跳转到“未经授权页面”。</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><h1 style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">首先来结合一个实例来说明：</span></h1><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">上篇博客（<a target="_blank" target="_blank" href="http://blog.csdn.net/hejingyuan6/article/details/45441707">深入浅出学Shiro（一）--登录认证</a>）已经讲解了配置，下面我们直接来看代码实现</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">shiro</span><span lang="zh-CN">认证成功后，跳转到</span><span lang="en-US">main.jsp</span><span lang="zh-CN">页面</span></span></p><p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br></span></span></p><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">&nbsp;&nbsp;</span></span><img src="43276959796937" alt="" style="font-size:12px"><span style="font-family:KaiTi_GB2312; font-size:14pt">&nbsp;</span><span style="font-size:14pt; font-family:KaiTi_GB2312">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p><p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"></span></p><p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">Main.jsp页面内容：</span></p><pre code_snippet_id="659601" snippet_file_name="blog_20150505_1_3869533" name="code" class="html">&lt;body&gt;
		&lt;ul&gt;
			&lt;li&gt;
				&lt;h2&gt;
					&lt;a target=&quot;_self&quot; href=&quot;user.do?myjsp&quot;&gt;访问myjsp页面&lt;/a&gt;
				&lt;/h2&gt;
			&lt;/li&gt;
			&lt;li&gt;
				&lt;h2&gt;
					&lt;a target=&quot;_self&quot; href=&quot;user.do?notmyjsp&quot;&gt;访问notmyjsp页面(无权访问)&lt;/a&gt;
				&lt;/h2&gt;
			&lt;/li&gt;
			&lt;li&gt;
				&lt;h2&gt;
					&lt;a target=&quot;_self&quot; href=&quot;user.do?visitAdminPage&quot;&gt;访问admin页面&lt;/a&gt;
				&lt;/h2&gt;
			&lt;/li&gt;
			
			&lt;li&gt;
				&lt;h2&gt;
					&lt;a target=&quot;_self&quot; href=&quot;user.do?visitByAnnotation&quot;&gt;通过注解访问页面（无权访问）&lt;/a&gt;
				&lt;/h2&gt;
			&lt;/li&gt;
		&lt;/ul&gt;
	&lt;/body&gt;</pre><br><p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"></span></p><p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">当点击页面某个链接时，跳转到相应的</span><span lang="en-US">controller</span></span></p><pre code_snippet_id="659601" snippet_file_name="blog_20150505_2_3897625" name="code" class="java">@Controller
@RequestMapping(value=&quot;user&quot;)
public class UserController {
	/**
	 * 访问myjsp页面，有权限
	 * @return
	 */
	@RequestMapping(params = &quot;myjsp&quot;)
	public String home() {
		/*通过SecurityUtils工具类，获取当前的用户*/
		Subject currentUser = SecurityUtils.getSubject();
		
		// 回调 doGetAuthorizationInfo，进行授权验证
		if(currentUser.isPermitted(&quot;user.do?myjsp&quot;)){
			return &quot;my&quot;;
		}else{
			return &quot;error/noperms&quot;;
		}
	}</pre><br><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">当程序执行到currentUser.isPermitted方法时，调用到publicclass DelegatingSubject implements Subject类的isPermitted方法。</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">附源码：</span></p><pre code_snippet_id="659601" snippet_file_name="blog_20150505_3_5420216" name="code" class="java">public boolean isPermitted(String permission) {
        return hasPrincipals() &amp;&amp; securityManager.isPermitted(getPrincipals(), permission);
    }
</pre><br><br><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">通过上篇博客我们知道，这时SecurityManager会委托给Realm，故接下来执行我们自定义的</span><span lang="en-US">Realm</span><span lang="zh-CN">：</span><br></span></span></p><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></span></p><pre code_snippet_id="659601" snippet_file_name="blog_20150505_4_1676692" name="code" class="java">@Service(&quot;monitorRealm&quot;)
public class MonitorRealm extends AuthorizingRealm {

	//获取授权信息 
	@Override
	protected AuthorizationInfo doGetAuthorizationInfo(
			PrincipalCollection principals) {
		/* 这里编写授权代码 */
		Set&lt;String&gt; roleNames = new HashSet&lt;String&gt;();
	    Set&lt;String&gt; permissions = new HashSet&lt;String&gt;();
	    roleNames.add(&quot;admin&quot;);
	    permissions.add(&quot;user.do?myjsp&quot;);
	    permissions.add(&quot;login.do?main&quot;);
	    permissions.add(&quot;login.do?logout&quot;);
	    //对比的过程
		SimpleAuthorizationInfo info = new SimpleAuthorizationInfo(roleNames);
	    info.setStringPermissions(permissions);
		return info;
	}
}</pre><p><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></span></p><p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">对比的过程中如果存在则正确返回，否则返回</span><span lang="en-US">error</span><span lang="zh-CN">。</span></span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><h1 style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">补充：</span></h1><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">结合上篇博客的配置还想要多说两句</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><h2 style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">其一：SpringMVC拦截</span></h2><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">这部分配置，是配置</span><span lang="en-US">Spring</span><span lang="en-US">MVC</span><span lang="zh-CN">的拦截页面，看了这个配置相信大家也就明白了为什么我们访问的页面要加上</span><span lang="en-US">.do</span><span lang="en-US">(</span><span lang="zh-CN">user.do?notmyjsp</span><span lang="en-US">)</span><span lang="zh-CN">吧！</span></span></p><pre code_snippet_id="659601" snippet_file_name="blog_20150505_5_7169017" name="code" class="html">&lt;servlet-mapping&gt;
		&lt;servlet-name&gt;springMvc&lt;/servlet-name&gt;
		&lt;!-- 只拦截带do后缀的 --&gt;
		&lt;!-- &lt;url-pattern&gt;*.do&lt;/url-pattern&gt; --&gt;
		&lt;!-- 将springmvc的匹配表达式修改为所有的页面均拦截 --&gt;
		&lt;url-pattern&gt;/&lt;/url-pattern&gt; 

&lt;/servlet-mapping&gt;</pre><p><br></p><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></span></p><h2 style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">其二：ShiroFilter拦截</span></h2><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">这部分配置是配置的ShiroFilter，也就是</span><span lang="en-US">shiro</span><span lang="en-US"></span><span lang="zh-CN">拦截哪些页面。</span></span></p><pre code_snippet_id="659601" snippet_file_name="blog_20150505_6_8442003" name="code" class="html">&lt;!-- Shiro主过滤器本身功能十分强大,其强大之处就在于它支持任何基于URL路径表达式的、自定义的过滤器的执行--&gt;  
	&lt;!-- Shiro Filter --&gt;  
	&lt;filter&gt;
		&lt;filter-name&gt;shiroFilter&lt;/filter-name&gt;
		&lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
		&lt;init-param&gt;
			&lt;param-name&gt;targetFilterLifecycle&lt;/param-name&gt;
			&lt;param-value&gt;true&lt;/param-value&gt;
		&lt;/init-param&gt;
	&lt;/filter&gt;
	&lt;!-- shiro只拦截如下的后缀 --&gt;
	&lt;filter-mapping&gt;
		&lt;filter-name&gt;shiroFilter&lt;/filter-name&gt;
		&lt;url-pattern&gt;*.action&lt;/url-pattern&gt;
	&lt;/filter-mapping&gt;
	&lt;filter-mapping&gt;
		&lt;filter-name&gt;shiroFilter&lt;/filter-name&gt;
		&lt;url-pattern&gt;*.do&lt;/url-pattern&gt;
	&lt;/filter-mapping&gt;
	&lt;filter-mapping&gt;
		&lt;filter-name&gt;shiroFilter&lt;/filter-name&gt;
		&lt;url-pattern&gt;*.jsp&lt;/url-pattern&gt;
	&lt;/filter-mapping&gt;
</pre><br><br><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></span></p><h2 style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">其三：Shiro过滤链的定义（是否需要登录认证)</span></h2><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">以下这部分配置，是配置访问的页面是否需要验证，即登录后才可以访问。举例说明：访问后缀名为</span><span lang="en-US">.action</span><span lang="zh-CN">的页面，我可以直接访问到，那么如果我访问</span><span lang="en-US">.do</span><span lang="zh-CN">的页面，则会自动跳转到登录页，需要我们首先登录后才可以访问，这些就与我们配置的过滤链相关。</span></span></p><pre code_snippet_id="659601" snippet_file_name="blog_20150505_7_9441206" name="code" class="html">&lt;property name=&quot;filterChainDefinitions&quot;&gt;
			&lt;value&gt;
			 &lt;!-- Shiro 过滤链的定义--&gt;   
        &lt;!--此处可配合这篇文章来理解各个过滤连的作用http://blog.csdn.net/jadyer/article/details/12172839--&gt;
				&lt;!-- 
					Anon：不指定过滤器 
					Authc:验证，这些页面必须验证后才能访问，也就是我们说的登录后才能访问。
					--&gt;
					 &lt;!--下面value值的第一个'/'代表的路径是相对于HttpServletRequest.getContextPath()的值来的 --&gt;   
					&lt;!--anon：它对应的过滤器里面是空的,什么都没做,这里.do和.jsp后面的*表示参数,比方说login.jsp?main这种 --&gt;   
        &lt;!--authc：该过滤器下的页面必须验证后才能访问,它是Shiro内置的一个拦截器org.apache.shiro.web.filter.authc.FormAuthenticationFilter--&gt;   
				
				/login.jsp* = anon
				/login.do* = anon
				/index.jsp*= anon
				/error/noperms.jsp*= anon
				/*.jsp* = authc
				/*.do* = authc
			&lt;/value&gt;
		&lt;/property&gt;

</pre><br><span style="font-family:KaiTi_GB2312;font-size:18px;">这些过滤器分为两组，一组是认证过滤器，一组是授权过滤器。其中anon，authcBasic，auchc，user是第一组，<br></span><p><span style="font-family:KaiTi_GB2312;font-size:18px;">perms，roles，ssl，rest，port是第二组</span></p><p><span style="font-family:KaiTi_GB2312;font-size:18px;">可参考：http://blog.csdn.net/hxpjava1/article/details/7035724</span></p><p><span style="font-family:KaiTi_GB2312;font-size:18px;"><br></span></p><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></span></p><h1 style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">扩展：</span></h1><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">Shiro支持三种方式实现授权过程：</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><p style="margin:0in 0in 0in 0.375in; font-size:14pt"><span style="font-family:KaiTi_GB2312">编码实现</span></p><p style="margin:0in 0in 0in 0.375in; font-size:14pt"><span style="font-family:KaiTi_GB2312">注解实现</span></p><p style="margin:0in 0in 0in 0.375in; font-size:14pt"><span style="font-family:KaiTi_GB2312">JSPTaglig实现</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">编程式：通过写if/else授权代码块完成（以上实例即使用编程式完成）：</span>&nbsp;</p><pre code_snippet_id="659601" snippet_file_name="blog_20150505_8_5141275" name="code" class="java">Subject subject = SecurityUtils.getSubject();  
if(subject.hasRole(“admin”)) {  
    //有权限  
} else {  
    //无权限  
}   
</pre><br><br><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">注解式：通过在执行的Java方法上放置相应的注解完成：<br></span></span></span></p><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></span></p><pre code_snippet_id="659601" snippet_file_name="blog_20150505_9_7253293" name="code" class="java">@RequiresRoles(&quot;admin&quot;)  
public void hello() {  
    //有权限  
}   

没有权限将抛出相应的异常；</pre><br><p><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></span></p><p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">JSP标签：在JSP/GSP页面通过相应的标签完成：&nbsp;</span></p><pre code_snippet_id="659601" snippet_file_name="blog_20150505_10_1284139" name="code" class="html">&lt;shiro:hasPermission name=&quot;user:create&quot;&gt;  
	&lt;a href=&quot;createUser.jsp&quot;&gt;Create a new User&lt;/a&gt;  
&lt;/shiro:hasPermission&gt;  
</pre><br><br><h1 style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">总结：</span></span></span></span></h1><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br></span></span></span></span></p><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">&nbsp; &nbsp; 无论是</span><span lang="en-US">Shiro</span><span lang="zh-CN">的登录认证还是授权，其实都是结合Subject，SecurityManager和Realms这三者的关系来实现的，理解了三者的关系</span><span lang="en-US">Shiro</span><span lang="zh-CN">也就学会了。Subject，当前用户；SecurityManager，外观的作用，其内部为我们封装了实现好的功能；Realms，</span><span lang="en-US">Shiro</span><span lang="zh-CN">和真实</span><span lang="en-US">Dao</span><span lang="zh-CN">操作的桥梁，以下这张图很形象的展示了三者的关系。</span><br></span></span></span></p><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span lang="zh-CN"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="9280009908132" alt=""><br></span></span></span></span></p><p style="margin:0in; font-size:14.0pt"><span lang="zh-CN" style="font-family:宋体"><span lang="zh-CN" style="font-family:宋体"><span lang="zh-CN" style="font-family:宋体"><br></span></span></span></p>   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/45507535'>原文链接</a>