<div style="color:blue" align=center>JAVA并发编程应用篇</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">
<p style="margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; font-size: 15px; line-height: 35px;"><span style="font-family:KaiTi_GB2312;font-size:18px;"></span></p><p style="margin: 0px; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; padding: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; line-height: 35px; widows: 1; background-color: rgb(255, 255, 255);"><span style="font-family:KaiTi_GB2312;font-size:18px;">提到java多线程不免有些人会头大，很多概念都是很理解但是真正到了实战的时候又是不知道如何操作了，下面就结合实际项目来说说多线程的应用。</span></p><p style="margin: 0px; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; padding: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; line-height: 35px; widows: 1; background-color: rgb(255, 255, 255);"><span style="font-family:KaiTi_GB2312;font-size:18px;"><br></span></p><p style="margin: 0px; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; padding: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; line-height: 35px; widows: 1; background-color: rgb(255, 255, 255);"><span style="font-family:KaiTi_GB2312;font-size:18px;">业务需求：</span></p><p style="margin: 0px; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; padding: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; line-height: 35px; widows: 1; background-color: rgb(255, 255, 255);"><span style="font-family:KaiTi_GB2312;font-size:18px;">&nbsp; &nbsp; 举例：批量插入10万条用户的相关活动优惠券</span></p><p style="margin: 0px; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; padding: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; line-height: 35px; widows: 1; background-color: rgb(255, 255, 255);"><span style="font-family:KaiTi_GB2312;font-size:18px;">&nbsp; &nbsp; 操作方式：使用固定10个大小的线程池来做，并每次处理1000条插入数据</span></p><p style="margin: 0px; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; padding: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; line-height: 35px; widows: 1; background-color: rgb(255, 255, 255);"><span style="font-family:KaiTi_GB2312;font-size:18px;"><br></span></p><p style="margin: 0px; font-size: 15px; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; word-spacing: 0px; -webkit-text-size-adjust: auto; -webkit-text-stroke-width: 0px; padding: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; line-height: 35px; widows: 1; background-color: rgb(255, 255, 255);"><span style="font-family:KaiTi_GB2312;font-size:18px;">线程类：注实现Callable&lt;Integer&gt;接口的是能得到返回值的线程类</span></p><p style="margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; font-size: 15px; line-height: 35px;"><span style="font-family:KaiTi_GB2312;font-size:18px;"></span></p><p style="margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; font-size: 15px; line-height: 35px;"><span style="font-family:KaiTi_GB2312;font-size:18px;"></span></p><pre code_snippet_id="1594576" snippet_file_name="blog_20160302_1_2731102" name="code" class="java">public class InsertBatchThread implements Callable&lt;Integer&gt; {  
  
  
    private int vdate;  
    private int uid;  
    private int count;  
    private FundsInfoMapper fundsInfoMapper;  
    private WmpsDayInterMapper wmpsDayInterMapper;  
    private DataSource dataSource;  
  
  
    public WmpsDayInterMapper getWmpsDayInterMapper() {  
        if (null == wmpsDayInterMapper) {  
            synchronized (this) {  
                if (null == wmpsDayInterMapper) {  
                    wmpsDayInterMapper = SpringContextUtils.getBean(&quot;wmpsDayInterMapper&quot;);  
                }  
            }  
        }  
        return wmpsDayInterMapper;  
    }  
  
  
    public FundsInfoMapper getProCommFundsInfoMapper() {  
        if (null == fundsInfoMapper) {  
            synchronized (this) {  
                if (null == fundsInfoMapper) {  
                    fundsInfoMapper = SpringContextUtils.getBean(&quot;fundsInfoMapper&quot;);  
                }  
            }  
        }  
        return fundsInfoMapper;  
    }  
  
  
      
    /** 
     * 无参构造函数 
     */  
    public InsertBatchThread(){  
  
  
    }  
  
  
    /** 
     * 无参构造函数 
     */  
    public InsertBatchThread(int vdate,int uid,int count){  
        this.vdate=vdate;  
        this.uid=uid;  
        this.count=count;  
        this.fundsInfoMapper=getFundsInfoMapper();  
        this.wmpsDayInterMapper=getWmpsDayInterMapper();  
          
    }  
  
  
    /** 
     * 多线程规定好的方法，如果是继承Thread类则必须实现这个方法 
     */  
    public Integer call() {  
        int result = -1;  
        try {  
  
  
            //操作  
            List&lt;Integer&gt; listUsers = fundsInfoMapper.selectUserForInsertBatch(count * 1000, 1000);  
              
           //批量插入用户活动优惠券记录表  
            List&lt;WmpsDayInter&gt; listOnePageDayInner = wmpsDayInterMapper.selectByInsertBatch(vdate,listUsers.get(0),listUsers.get(listUsers.size() - 1));  
            wmpsDayInterInsertBatch(listOnePageDayInner);  
  
  
        }catch (Exception e){  
            result=count;  
        }  
        return  result;  
    }  
  
  
    //批量插入用户活动优惠券记录表--JDBC  
    public int[] wmpsDayInterInsertBatch(List&lt;WmpsDayInter&gt; listOnePage) throws Exception{  
        dataSource=  SpringContextUtils.getBean(&quot;dataSource&quot;);  
        PreparedStatement ps = dataSource.getConnection().prepareStatement(&quot;INSERT ignore INTO t_a (uid, inter, cdate) values(?,?,?)&quot; );  
        for(WmpsDayInter oneObj :listOnePage ){  
            ps.setInt(1,oneObj.getUid());  
            ps.setBigDecimal(2, oneObj.getInter());  
            ps.setBigDecimal(3,oneObj.getCdate());  
            ps.addBatch();  
        }  
        return ps.executeBatch();  
    }  
      
}  
</pre><br><br><p><p style="margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; font-size: 15px; line-height: 35px;"><span style="font-family:KaiTi_GB2312;font-size:18px;"><span style="font-family:KaiTi_GB2312;font-size:18px;color:#555555;line-height: 35px;">对应的业务实现类：</span><br></span></p><p style="margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; font-size: 15px; line-height: 35px;"><pre code_snippet_id="1594576" snippet_file_name="blog_20160302_2_3909174" name="code" class="java">/** 
 * 活动优惠券 
 */  
@Service(&quot;FundsInfoService&quot;)  
public class FundsInfoServiceImpl extends  BaseService&lt;ProCommFundsInfo, FundsInfoExample&gt; implements IFundsInfoService {  
    private final static Logger LOGGER = LoggerFactory.getLogger(FundsInfoServiceImpl.class);  
    @Autowired  
    private FundsInfoMapper fundsInfoMapper;  
  
    public FundsInfoServiceImpl() {  
    }  
  
    @Override  
    public void insertDayInter(Integer vdate, Integer uid) {  
          
        //活动优惠券条件判断  
        if (vdate == null || vdate.intValue() &lt;= 0 || uid == null || uid.intValue() &lt; 0) {  
            LOGGER.error(&quot;=insertDayInter=&gt;error,vdate=&quot; + vdate + &quot;,uid=&quot; + uid);  
        } else {  
              
            //统计符合条件用户  
            int totalNum = fundsInfoMapper.countForInsertBatchByUser();  
            List&lt;Integer&gt; listException = new ArrayList&lt;Integer&gt;();  
              
            //初始化第一批次起始值  
            int startRow = 0;  
            try {  
                  
                //固定大小线程池  
                ExecutorService fixedThreadPool = Executors.newFixedThreadPool(10);  
                 
                for (int i = 0; i &lt;= Math.floor(totalNum / 1000); i++) {  
                    Future&lt;Integer&gt; future = fixedThreadPool.submit(new InsertBatchThread(vdate, uid, i));  
                    if( future.get()&gt;=0 ){  
                        listException.add( future.get());  
                    }  
                }  
  
                //活动优惠券发完，验证是否有遗漏，如果有则修复  
                if(listException.size()&gt;0){  
                 
                    for (int i = 0; i &lt;= listException.size(); i++) {  
                        Future&lt;Integer&gt; future = fixedThreadPool.submit(new InsertBatchThread(vdate, uid, listException.get(i)));  
                        if( future.get()&gt;=0 ){  
                            listException.add( future.get());  
                        }  
                    }  
                }  
                 
            }catch (Exception e){  
                LOGGER.error(&quot;&lt;=insertDayInter=&gt;error&quot;,e);  
            }  
  
        }  
        LOGGER.info(&quot;&lt;=insertDayInter=&gt;&quot;);  
  
    }  
}  
</pre><br><br><p><p style="margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; font-size: 15px; line-height: 35px;"><span style="font-family:KaiTi_GB2312;font-size:18px;color:#555555;line-height: 35px;">问题在于，当我们需要使用多线程操作时，一般会先查询，再进行插入，但是此时如果我们没有一个合理的维度去分割数据的话，很容易造成死锁。例如如果我们没有将维度分配合理，就有可能批次一与批次二同时处理相同的数据，既要查询又要更新，互相均需要对方的锁释放才可以继续执行，导致死锁。</span></p><p style="margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; font-size: 15px; line-height: 35px;"><br></p><p style="margin-top: 0px; margin-bottom: 0px; padding-top: 0px; padding-bottom: 0px; color: rgb(85, 85, 85); font-family: 'microsoft yahei'; font-size: 15px; line-height: 35px;"><span style="font-family:KaiTi_GB2312;font-size:18px;color:#555555;line-height: 35px;"></span><br></p>   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/50332889'>原文链接</a>