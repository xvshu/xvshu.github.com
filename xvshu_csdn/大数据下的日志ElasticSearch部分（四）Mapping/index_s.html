<div class="articleLocationOnion"><a href='../../index.html'>首页: </a> &gt; <a href='../index_s.html'>未分类</a> &gt; 大数据下的日志ElasticSearch部分（四）Mapping</div><div style="color:blue" align=center>大数据下的日志ElasticSearch部分（四）Mapping</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

相当于数据库的表结构的定义，elasticsearch的mapping 也很重要。直接关系到性能及搜索结果的准确性。elasticsearch的java api的例子太少，我在这儿就献丑了。<br>
为了说明mapping的定义，我这里定义了一个简单的模型，就ID,type,和catIds 3个属性，重在说明如何使用java api来定义mapping,具体各field应该如何定义，这里不做讨论。<br>
Java代码 &nbsp;收藏代码<br>
public class TestModel implements Serializable { &nbsp;<br>
&nbsp; &nbsp; private static final long serialVersionUID = 3174577828007649745L; &nbsp;<br>
&nbsp; &nbsp; //主ID &nbsp;<br>
&nbsp; &nbsp; private long id; &nbsp;<br>
&nbsp; &nbsp; //类型，为types之一 &nbsp;<br>
&nbsp; &nbsp; private String type; &nbsp;<br>
&nbsp; &nbsp; /**&nbsp;<br>
&nbsp; &nbsp; &nbsp;* 这里是一个列表&nbsp;<br>
&nbsp; &nbsp; &nbsp;*/ &nbsp;<br>
&nbsp; &nbsp; private List&lt;Integer&gt; catIds; &nbsp;<br>
&nbsp; &nbsp; &nbsp;&nbsp;<br>
&nbsp; &nbsp; &nbsp;&nbsp;<br>
&nbsp; &nbsp; public long getId() { &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return id; &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
&nbsp; &nbsp; public void setId(long id) { &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.id = id; &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
&nbsp; &nbsp; public String getType() { &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return type; &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
&nbsp; &nbsp; public void setType(String type) { &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.type = type; &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
&nbsp; &nbsp; public List&lt;Integer&gt; getCatIds() { &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return catIds; &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
&nbsp; &nbsp; public void setCatIds(List&lt;Integer&gt; catIds) { &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; this.catIds = catIds; &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
} &nbsp;<br>
&nbsp;我们假设id就存储为long类型，type存储为字符串类型，catIds为一个列表，其实际类型为integer类型。定义的mapping如下：<br>
Java代码 &nbsp;收藏代码<br>
/**&nbsp;<br>
&nbsp; &nbsp; &nbsp;* mapping 一旦定义，之后就不能修改。&nbsp;<br>
&nbsp; &nbsp; &nbsp;* @return&nbsp;<br>
&nbsp; &nbsp; &nbsp;* @throws Exception&nbsp;<br>
&nbsp; &nbsp; &nbsp;*/ &nbsp;<br>
&nbsp; &nbsp; private static XContentBuilder getMapping() throws Exception{ &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; XContentBuilder mapping = jsonBuilder() &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.startObject() &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.startObject(&quot;test&quot;) &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.startObject(&quot;properties&quot;) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.startObject(&quot;id&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .field(&quot;type&quot;, &quot;long&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .field(&quot;store&quot;, &quot;yes&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endObject() &nbsp; &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.startObject(&quot;type&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .field(&quot;type&quot;, &quot;string&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .field(&quot;index&quot;, &quot;not_analyzed&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endObject() &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.startObject(&quot;catIds&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .field(&quot;type&quot;, &quot;integer&quot;) &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.endObject() &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.endObject() &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endObject() &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .endObject(); &nbsp; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return mapping; &nbsp;<br>
&nbsp; &nbsp; } &nbsp;<br>
&nbsp;注意：elasticsearch的field一旦定义后就无法修改，你想增加一个store属性，都不行。<br>
&nbsp;<br>
下面就是调用JAVA API了，注意，在定义mapping之前，还需要先创建一个index库。这里，我index库和mapping 写到一个方法里面了。<br>
Java代码 &nbsp;收藏代码<br>
Client client = ESUtils.getClient(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; //首先创建索引库 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; CreateIndexResponse &nbsp;indexresponse = client.admin().indices() &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; //这个索引库的名称还必须不包含大写字母 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; .prepareCreate(&quot;testindex&quot;).execute().actionGet(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; System.out.println(indexresponse.acknowledged());; &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; //如果是在两台机器上，下面直接putMapping可能会报异常 &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; PutMappingRequestBuilder builder = client.admin().indices().preparePutMapping(&quot;testindex&quot;); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; //testType就像当于数据的table &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; builder.setType(&quot;testType&quot;); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; XContentBuilder mapping = getMapping(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; builder.setSource(mapping); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; PutMappingResponse &nbsp;response = builder.execute().actionGet(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; System.out.println(response.isAcknowledged()); &nbsp;<br>
&nbsp;其中，这个代码在我本机出现一点问题，当我创建完index后，直接创建mapping 的时候，报index missing。我把两个es Node停掉一个就没有问题了。可见，ES将create index和putMapping放到了两个不同的es Node下面，导致了上面那个异常。<br>
&nbsp;<br>
好了，有时为了测试，可能需要删除某个索引，代码如下：<br>
Java代码 &nbsp;收藏代码<br>
Client client = ESUtils.getClient(); &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; client.admin().indices() &nbsp;<br>
&nbsp; &nbsp; &nbsp; &nbsp; //这个索引库的名称还必须不包含大写字母 &nbsp;<br>
<p>&nbsp; &nbsp; &nbsp; &nbsp; .prepareDelete(&quot;testindex&quot;).execute().actionGet(); &nbsp;</p>
<p><br>
</p>
<p>系列博客地址：</p>
<p>1，http://blog.csdn.net/xvshu/article/details/48845307<br>
2，http://blog.csdn.net/xvshu/article/details/48916793<br>
3，http://blog.csdn.net/xvshu/article/details/48917017<br>
4, http://blog.csdn.net/xvshu/article/details/48917059<br>
</p>
&nbsp;
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/xvshu/article/details/48917059'>原文链接</a>