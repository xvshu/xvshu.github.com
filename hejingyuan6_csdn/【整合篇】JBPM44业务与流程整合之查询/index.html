<div style="color:blue" align=center>【整合篇】JBPM44业务与流程整合之查询</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">&nbsp; &nbsp; 我们都知道在应用工作流的过程中业务与流程的整合必不可少，那么查询时流程结合业务的查询就更是在所难免了，如何实现这种效果呢，方式有多种，下面我先简单介绍一二（目前有</span><span lang="en-US">3</span><span lang="zh-CN">种方式解决，先简单介绍一种，剩下的两种会结合</span><span lang="en-US">Activiti</span><span lang="zh-CN">再来说明）。</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">第一种方式：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<p style="margin:0in; font-size:14pt">
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">Application（申请实体）：</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"></span></p>
<pre code_snippet_id="599029" snippet_file_name="blog_20150206_1_2317884" name="code" class="java">package com.hjy.ssh.beans;

import java.util.Date;
import java.util.HashSet;
import java.util.Set;

public class Application {

	/** 状态常量：审批中 */
	public static final String STATUS_RUNNING = &quot;审批中&quot;;

	/** 状态常量：已通过 */
	public static final String STATUS_APPROVED = &quot;已通过&quot;;

	/** 状态常量：未通过 */
	public static final String STATUS_REJECTED = &quot;未通过&quot;;

	private Long id;
	private Set&lt;ApproveInfo&gt; approveInfos = new HashSet&lt;ApproveInfo&gt;();
	private User applicant;// 申请人

	private String processDefinitionKey;//所使用的流程key
	public String getProcessDefinitionKey() {
		return processDefinitionKey;
	}

	public void setProcessDefinitionKey(String processDefinitionKey) {
		this.processDefinitionKey = processDefinitionKey;
	}

	private String title;// 标题
	private String applyTime;// 申请时间
	private String status; // 当前的状态
	private String reason;
	private String executeId;//当前启动的工作流实例id
	
	public String getExecuteId() {
		return executeId;
	}

	public void setExecuteId(String executeId) {
		this.executeId = executeId;
	}

	public String getReason() {
		return reason;
	}

	public void setReason(String reason) {
		this.reason = reason;
	}

	public Long getId() {
		return id;
	}

	public void setId(Long id) {
		this.id = id;
	}
	
	public User getApplicant() {
		return applicant;
	}

	public void setApplicant(User applicant) {
		this.applicant = applicant;
	}

	public String getApplyTime() {
		return applyTime;
	}

	public void setApplyTime(String string) {
		this.applyTime = string;
	}

	public String getTitle() {
		return title;
	}

	public void setTitle(String title) {
		this.title = title;		

	}

	public String getStatus() {
		return status;
	}

	public void setStatus(String status) {
		this.status = status;
	}

	public Set&lt;ApproveInfo&gt; getApproveInfos() {
		return approveInfos;
	}

	public void setApproveInfos(Set&lt;ApproveInfo&gt; approveInfos) {
		this.approveInfos = approveInfos;
	}

}
</pre><br>
<p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">ApproveInfo（审批实体）：<br>
</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"></span></p>
<pre code_snippet_id="599029" snippet_file_name="blog_20150206_2_7286821" name="code" class="java">package com.hjy.ssh.beans;


/**
 * 审批信息
 * 
 * @author hjy
 * 
 */
public class ApproveInfo {
	private Long id;
	private Application application; // 
	private User approver;// 审批人

	private String approveTime;// 审批时间
	private boolean approval; // 是否通过
	private String comment; // 审批意见

	public Long getId() {
		return id;
	}

	public void setId(Long id) {
		this.id = id;
	}

	public User getApprover() {
		return approver;
	}

	public void setApprover(User approver) {
		this.approver = approver;
	}

	public String getApproveTime() {
		return approveTime;
	}

	public void setApproveTime(String approveTime) {
		this.approveTime = approveTime;
	}

	public Application getApplication() {
		return application;
	}

	public void setApplication(Application application) {
		this.application = application;
	}

	public boolean isApproval() {
		return approval;
	}

	public void setApproval(boolean approval) {
		this.approval = approval;
	}

	public String getComment() {
		return comment;
	}

	public void setComment(String comment) {
		this.comment = comment;
	}

}
</pre><br>
<p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">TaskView（组合实体）：<br>
</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"></span></p>
<pre code_snippet_id="599029" snippet_file_name="blog_20150206_3_7022663" name="code" class="java">package com.hjy.ssh.beans;

import org.jbpm.api.task.Task;

public class TaskView {

	private Task task;
	private Application application;

	public TaskView(Task task, Application application) {
		this.task = task;
		this.application = application;
	}

	public Task getTask() {
		return task;
	}

	public void setTask(Task task) {
		this.task = task;
	}

	public Application getApplication() {
		return application;
	}

	public void setApplication(Application application) {
		this.application = application;
	}

}
</pre><br>
<p>
<p style="margin:0in; font-size:14pt">
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">查询我的待办任务：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"></span></p>
<pre code_snippet_id="599029" snippet_file_name="blog_20150206_4_4250251" name="code" class="java">/** 待我审批（我的任务列表） */
public String myTaskList() throws Exception {
			
	List&lt;TaskView&gt; taskViewList = applicationService.getMyTaskViewList(getCurrentUser());
	//List&lt;TaskView&gt; taskViewList = applicationService.getMyTaskViewList(user);
	ActionContext.getContext().put(&quot;taskViewList&quot;, taskViewList);
	return &quot;myTaskList&quot;;
}
</pre><br>
<pre code_snippet_id="599029" snippet_file_name="blog_20150206_5_82398" name="code" class="java">public List&lt;TaskView&gt; getMyTaskViewList(User currentUser) {
	// 查询我的任务列表
	String userId = currentUser.getUsername(); // 约定使用loginName作为JBPM用的用户标识符
	List&lt;Task&gt; taskList = processEngine.getTaskService().findPersonalTasks(userId);
		
	// 找出每个任务对应的申请信息
	List&lt;TaskView&gt; resultList = new ArrayList&lt;TaskView&gt;();
	for (Task task : taskList) {
		
		Application application = (Application) processEngine.getTaskService().getVariable(task.getId(), &quot;application&quot;);
		resultList.add(new TaskView(task, application));
	}

	// 返回“任务--申请信息”的结果
	return resultList;
}
</pre><br>
<p>
<p style="margin:0in; font-size:14pt">
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">此处的返回&#20540;为</span><span lang="en-US">TaskView</span><span lang="zh-CN">，这个</span><span lang="en-US">TaskVie</span><span lang="zh-CN">的既包含了业务的内容也包括流程的内容，获取启动流程时存入的流程变量，根据</span><span lang="en-US">taskid</span><span lang="zh-CN">和</span><span lang="en-US">map</span><span lang="zh-CN">的</span><span lang="en-US">key</span><span lang="zh-CN">&#20540;来查找即可！</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">我的任务列表：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"></span></p>
<pre code_snippet_id="599029" snippet_file_name="blog_20150206_6_3406290" name="code" class="html">&lt;!--显示数据列表--&gt;
        &lt;tbody id=&quot;TableData&quot; class=&quot;dataContainer&quot; datakey=&quot;formList&quot;&gt;
		
		 &lt;s:iterator value=&quot;#taskViewList&quot;&gt;
			&lt;tr class=&quot;TableDetail1 template&quot; align=&quot;CENTER&quot;&gt;
				&lt;td&gt;${application.title}&lt;/td&gt;
				&lt;td&gt;${application.applicant.username}&#160;&lt;/td&gt;
				&lt;td&gt;${task.activityName}&#160;&lt;/td&gt;				
				&lt;td&gt;${application.applyTime}&#160;&lt;/td&gt;
				&lt;td&gt;
					&lt;s:a action=&quot;flowAction_approveUI?applicationId=%{application.id}&amp;taskId=%{task.id}&quot;&gt;审批处理&lt;/s:a&gt;
					&lt;s:a action=&quot;flowAction_approveHistory?applicationId=%{application.id}&quot;&gt;查看流转记录&lt;/s:a&gt;					
				&lt;/td&gt;
			&lt;/tr&gt;
		&lt;/s:iterator&gt;	
			
        &lt;/tbody&gt;
</pre><br>
<br>
<p>
<p style="margin:0in; font-size:14pt">
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">总结：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp; &nbsp; 当然以上也仅仅是给我们提供了一种思路，这种结合的方式有多种，这些跟工作流不工作流没有什么关系，只需要我们在日常做项目的过程中，多多积累，所有的这些其实都是通用的，而且在项目中也很常见，所以还是要靠我们日常的积累！</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<span style="font-family:KaiTi_GB2312"><br>
</span><br>
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/42916211'>原文链接</a>