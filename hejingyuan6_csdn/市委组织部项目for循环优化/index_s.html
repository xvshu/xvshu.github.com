<div class="articleLocationOnion"><a href='../../index.html'>首页: </a> &gt; <a href='../index_s.html'>未分类</a> &gt; 市委组织部项目for循环优化</div><div style="color:blue" align=center>市委组织部项目for循环优化</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

<p style="margin:0in; font-family:宋体; font-size:16.0pt">
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><br>
</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">需求：</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><br>
</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">&nbsp; &nbsp; 在市委组织部考核项目中，共有</span><span lang="en-US">1500</span><span lang="zh-CN">条处级干部的基础信息，每个干部有如下</span><span lang="en-US">5</span><span lang="zh-CN">个指标要被考核，这</span><span lang="en-US">5</span><span lang="zh-CN">个指标有</span><span lang="en-US">5</span><span lang="zh-CN">或</span><span lang="en-US">6</span><span lang="zh-CN">个级别，每个级别会录入有相应的票数</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><br>
</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">计算公式：</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><br>
</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">例如：</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><br>
</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">&nbsp; &nbsp; 此考核指标有</span><span lang="en-US">5</span><span lang="zh-CN">个级别：优秀，良好，一般，较差，弃权</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">某干部的某一个定性指标成绩</span><span lang="en-US">=</span><span lang="zh-CN">优秀</span><span lang="en-US">/</span><span lang="zh-CN">总票数</span><span lang="en-US">*</span><span lang="zh-CN">优秀分数</span><span lang="en-US">&#43;</span><span lang="zh-CN">良好</span><span lang="en-US">/</span><span lang="zh-CN">总票数</span><span lang="en-US">*</span><span lang="zh-CN">良好分数</span><span lang="en-US">&#43;</span><span lang="zh-CN">一般</span><span lang="en-US">/</span><span lang="zh-CN">总票数</span><span lang="en-US">*</span><span lang="zh-CN">一般分数</span><span lang="en-US">&#43;</span><span lang="zh-CN">较差</span><span lang="en-US">/</span><span lang="zh-CN">总票数</span><span lang="en-US">*</span><span lang="zh-CN">较差分数</span><span lang="en-US">&#43;</span><span lang="zh-CN">弃权</span><span lang="en-US">/</span><span lang="zh-CN">总票数</span><span lang="en-US">*</span><span lang="zh-CN">弃权分数</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">当点击计算按钮时，需要将这</span><span lang="en-US">1500</span><span lang="zh-CN">个处级干部的每个指标的得分计算出来。</span></span></p>
<p style="margin:0in"><br>
</p>
<p style="margin:0in"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312; font-size:24px"><img src="4492928768616" alt=""><br>
</span></span></p>
<p style="margin:0in"><span lang="zh-CN"></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><br>
</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">优化前代码：</span></p>
<p style="font-size:16pt; font-family:宋体; margin:0in"><br>
</p>
<pre code_snippet_id="240204" snippet_file_name="blog_20140317_1_9654766" name="code" class="csharp" style="font-size: 16pt; font-family: 宋体;">  //计算处级干部定性指标得分
        public void CaculteScoresCadres(HttpContext context)
        {
            //声明并实例化计算得分业务处理类
            CadresScoresBLL cadresScoresBLL = new CadresScoresBLL();
            CadresScoresEntity cadresScoresEntity = new CadresScoresEntity();
            CadresCharacterizationVotesBLL cadresCharacterizationVotesBLL = new CadresCharacterizationVotesBLL();

            //获取所有录入数据的指标名称(根据干部来查出所有要考核的指标)
            DataSet dsTagetName = new DataSet();
            dsTagetName = cadresScoresBLL.GetAllCacultesTagetName();
            DataTable dtTagetName = dsTagetName.Tables[0];
            int countTagetName = dtTagetName.Rows.Count;

            for (int i = 0; i &lt; countTagetName; i++)
            {
                //var name = dtTagetName.Rows[i][&quot;TargetName&quot;].ToString();
                var name = dtTagetName.Rows[i][&quot;name&quot;].ToString();
                //调用方法来获取录入情况的boolean值

                //何静媛修改注释--当返回true时说明已经录入完成可以计算

                Boolean fag = cadresCharacterizationVotesBLL.GetNotInputGetCadresBoolean(name);

                //某一指标录入完成时才可以计算，否则不可计算
                if (fag)
                {
                    //select distinct CityID from V_ProcessCaculteCity where TargetName=&#39;民主测评&#39;
                    //需要对每个处级干部进行添加,首先获取某个指标的所有市直单位ID

                    //何静媛想--既然要求录入所有的数据才可以计算，也就是所有受考核的处级干部都要录入完成，那么这个根据指标
                    //查看处级干部的，和直接在处级干部基础表中所有受考核的干部应该一样，减少查询
                    //DataSet dsCadresID = cadresScoresBLL.GetVoteScoresCadresID(name);--需要查36000行
                    DataSet dsCadresID = cadresScoresBLL.GetVoteScoresCadresID();
                    DataTable dtCadresID = dsCadresID.Tables[0];
                    int countCadresID = dtCadresID.Rows.Count;

                    for (int m = 0; m &lt; countCadresID; m++)
                    {

                        //获取每个处级干部
                        var CadresID = dtCadresID.Rows[m][&quot;CadresID&quot;].ToString();

                        //获取某一处级干部的某一指标投票得分的情况
                        DataSet ds = cadresScoresBLL.GetVoteScores(name, CadresID);
                        DataTable dt = ds.Tables[0];
                        int count = dt.Rows.Count;


                        //获取票数该列的列明
                        string VotesName = dt.Columns[6].ColumnName;
                        //对该列进行求和
                        double AllVotes = ColumnSum(dt, VotesName);

                        double AddScores = 0;

                        //进行计算
                        //针对每行进行求比例 再乘以级别标准 最后再相加
                        for (int n = 0; n &lt; count; n++)
                        {
                            //票数/总票*标准分数
                            string Votes = dt.Rows[n][6].ToString();
                            string Scores = dt.Rows[n][7].ToString();


                            //已经将该指标的得分已经计算出来
                            AddScores += Convert.ToInt32(Votes) / AllVotes * Convert.ToInt32(Scores);

                        }

                        //将小数进行转换四舍五入 
                        string strScores = Convert.ToDouble(AddScores).ToString(&quot;0.00&quot;);

                        //获取需要往得分表中插入的字段文本
                        //获取指标ID
                        cadresScoresEntity.TargetID = dt.Rows[0][1].ToString();
                        //指标名字
                        cadresScoresEntity.IndicatorName = dt.Rows[0][2].ToString();
                        //获取处级干部ID
                        cadresScoresEntity.CadresID = dt.Rows[0][3].ToString();
                        //获取年份
                        cadresScoresEntity.YearTime = dt.Rows[0][8].ToString();
                        //获取得分
                        cadresScoresEntity.CalculateScores = strScores;

                        //进行各判断 当计算分数已经拥有后，那么就删除以前的添加新的 没有拥有的那么就直接添加
                        //条件为 指标id 处级干部ID  和时间
                        if (cadresScoresBLL.ExistsCadresScores(cadresScoresEntity))//当计算分数已经拥有后，那么就删除以前的添加新的
                        {
                            //删除
                            cadresScoresBLL.Delete(cadresScoresEntity);
                            //调用方法进行增加  //将计算结果插入得分表
                            cadresScoresBLL.Add(cadresScoresEntity);
                            if (cadresScoresBLL.Add(cadresScoresEntity))
                            {
                                context.Response.Write(&quot;T&quot;);
                            }
                            else
                            {
                                context.Response.Write(&quot;F&quot;);
                            }
                        }
                        else//没有拥有以前分数的那么就直接添加
                        {
                            //调用方法进行增加  //将计算结果插入得分表
                            cadresScoresBLL.Add(cadresScoresEntity);
                            //if (cadresScoresBLL.Add(cadresScoresEntity))
                            //{
                            //    context.Response.Write(&quot;T&quot;);
                            //}
                            //else
                            //{
                            //    context.Response.Write(&quot;F&quot;);
                            //}
                        }
                    }

                }
                //else//指标数据未录入完成，禁止计算 提示给前台
                //{
                //    context.Response.Write(&quot;N&quot;);
                //}

            }
            context.Response.Write(&quot;N&quot;);
        }
</pre><br>
<br>
<p style="margin:0in"><span lang="zh-CN"></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">优化后代码：</span></p>
<br>
<p style="margin:0in; font-size:16.0pt"><span lang="zh-CN" style="font-family:宋体"></span></p>
<pre code_snippet_id="240204" snippet_file_name="blog_20140317_2_1704890" name="code" class="csharp">//计算处级干部定性指标得分----何静媛
        public void CaculteScoresCadres(HttpContext context)
        {
            //声明并实例化计算得分业务处理类
            CadresScoresBLL cadresScoresBLL = new CadresScoresBLL();
            CadresScoresEntity cadresScoresEntity = new CadresScoresEntity();
            CadresCharacterizationVotesBLL cadresCharacterizationVotesBLL = new CadresCharacterizationVotesBLL();

            DataTable dtAll = new DataTable();
            dtAll = cadresCharacterizationVotesBLL.GetAll().Tables [0];

            DataTable dtScores=new DataTable();
            dtScores=cadresScoresBLL.GetTable().Tables [0];

            //调用将这些数据添加到一个新的datatable中的方法
            DataTable dtNewScores = new DataTable();
            dtNewScores = dtScores.Clone();



            //获取所有录入数据的指标名称(根据干部来查出所有要考核的指标)
            DataSet dsTagetName = new DataSet();
            dsTagetName = cadresScoresBLL.GetAllCacultesTagetName();
            DataTable dtTagetName = dsTagetName.Tables[0];
            int countTagetName = dtTagetName.Rows.Count;
            //指标
            for (int i = 0; i &lt; countTagetName; i++)
            {
                //var name = dtTagetName.Rows[i][&quot;TargetName&quot;].ToString();
                var name = dtTagetName.Rows[i][&quot;name&quot;].ToString();
                //调用方法来获取录入情况的boolean值

                //何静媛修改注释--当返回true时说明已经录入完成可以计算

                Boolean fag = cadresCharacterizationVotesBLL.GetNotInputGetCadresBoolean(name);

                //某一指标录入完成时才可以计算，否则不可计算
                if (fag)
                {
                    //select distinct CityID from V_ProcessCaculteCity where TargetName=&#39;民主测评&#39;
                    //需要对每个处级干部进行添加,首先获取某个指标的所有市直单位ID

                    //何静媛想--既然要求录入所有的数据才可以计算，也就是所有受考核的处级干部都要录入完成，那么这个根据指标
                    //查看处级干部的，和直接在处级干部基础表中所有受考核的干部应该一样，减少查询
                    //DataSet dsCadresID = cadresScoresBLL.GetVoteScoresCadresID(name);--需要查36000行
                    DataSet dsCadresID = cadresScoresBLL.GetVoteScoresCadresID();
                    DataTable dtCadresID = dsCadresID.Tables[0];
                    int countCadresID = dtCadresID.Rows.Count;

                    //人
                    for (int m = 0; m &lt; countCadresID; m++)
                    {

                        //获取每个处级干部
                        var CadresID = dtCadresID.Rows[m][&quot;CadresID&quot;].ToString();

                        //获取某一处级干部的某一指标投票得分的情况
                        //DataSet ds = cadresScoresBLL.GetVoteScores(name, CadresID);
                        DataSet ds = new DataSet();
                        DataRow[] drs = dtAll.Select(&quot;TargetName=&#39;&quot; + name + &quot;&#39; and CadresID=&#39;&quot; + CadresID + &quot;&#39;&quot;);
                        DataTable dttest = new DataTable();
                        dttest = dtAll.Clone();
                        ds.Tables.Add(dttest.Copy());
                        for (int h = 0; h &lt; drs.Length; h++)
                        {
                            ds.Tables[0].ImportRow(drs[h]);
                        }

                        DataTable dt = ds.Tables[0];
                        int count = dt.Rows.Count;


                        //获取票数该列的列明
                        string VotesName = dt.Columns[6].ColumnName;
                        //对该列进行求和
                        double AllVotes = ColumnSum(dt, VotesName);

                        double AddScores = 0;

                        //进行计算
                        //针对每行进行求比例 再乘以级别标准 最后再相加
                        for (int n = 0; n &lt; count; n++)
                        {
                            //票数/总票*标准分数
                            string Votes = dt.Rows[n][6].ToString();
                            string Scores = dt.Rows[n][7].ToString();


                            //已经将该指标的得分已经计算出来
                            AddScores += Convert.ToInt32(Votes) / AllVotes * Convert.ToInt32(Scores);

                        }

                        //将小数进行转换四舍五入 
                        string strScores = Convert.ToDouble(AddScores).ToString(&quot;0.00&quot;);

                        //获取需要往得分表中插入的字段文本
                        //获取指标ID
                        cadresScoresEntity.TargetID = dt.Rows[0][1].ToString();
                        //指标名字
                        cadresScoresEntity.IndicatorName = dt.Rows[0][2].ToString();
                        //获取处级干部ID
                        cadresScoresEntity.CadresID = dt.Rows[0][3].ToString();
                        //获取年份
                        cadresScoresEntity.YearTime = dt.Rows[0][8].ToString();
                        //获取得分
                        cadresScoresEntity.CalculateScores = strScores;

                        //进行各判断 当计算分数已经拥有后，那么就删除以前的添加新的 没有拥有的那么就直接添加
                        //条件为 指标id 处级干部ID  和时间


                        dtNewScores.Rows.Add(cadresScoresEntity.Id, cadresScoresEntity.CadresID, cadresScoresEntity.IndicatorName, cadresScoresEntity.CalculateScores, cadresScoresEntity.FactScores, cadresScoresEntity.YearTime,null,cadresScoresEntity.TargetID);
                            
              
                    }


                }
                

            }
            //删除

            cadresScoresBLL.Delete(cadresScoresEntity.YearTime);

            string tablename;
            tablename = &quot;T_CadresScores&quot;;
            Boolean flagImportScores = cadresScoresBLL.InsertAllTable(dtNewScores, tablename);

            if (flagImportScores)
            {
                context.Response.Write(&quot;T&quot;);
            }
            else 
            {
                context.Response.Write(&quot;F&quot;);
            }

            context.Response.Write(&quot;N&quot;);
        }
</pre><br>
<br>
<p>
<p style="margin:0in"><span lang="zh-CN"></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">数据量为</span><span lang="en-US">7500</span><span lang="zh-CN">次的查询</span><span lang="en-US">36000</span><span lang="zh-CN">条数据（这</span><span lang="en-US">36000</span><span lang="zh-CN">条数据是一个视图，包含所有的信息，也就是</span><span lang="en-US">1500</span><span lang="en-US">*5*4&#43;1500*1*4</span><span lang="zh-CN">），之后要计算分数，求和操作，然后向数据库中添加</span><span lang="en-US">7500</span><span lang="zh-CN">条数据。</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">优化前需要花费</span><span lang="en-US">3</span><span lang="zh-CN">分半钟，优化后需要</span><span lang="en-US">8</span><span lang="zh-CN">秒。</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><span lang="zh-CN">思想：减少与数据库的交互。将上万次的与数据库交互减少到几次！将</span><span lang="en-US">36000</span><span lang="zh-CN">条数据取出来，放在</span><span lang="en-US">D</span><span lang="en-US">ataTable</span><span lang="zh-CN">中，在</span><span lang="en-US">DataTable</span><span lang="zh-CN">中取数据而不需多次打开关闭数据库连接减少与数据库的交互！</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">&nbsp;</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">总结：</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px"><br>
</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">&nbsp; &nbsp; 优化很重要而且相当重要，优化的过程可能很煎熬，但优化成功后的喜悦是不可比拟的，现在的生活更注重效率，只有站在用户的角度去考虑问题，去设计程序，才能吸引更多的用户。</span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312; font-size:24px">&nbsp;</span></p>
<br>
<p style="margin:0in; margin-left:.375in; font-size:16.0pt"><span lang="zh-CN" style="font-family:宋体"><br>
</span></p>
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/20571525'>原文链接</a>