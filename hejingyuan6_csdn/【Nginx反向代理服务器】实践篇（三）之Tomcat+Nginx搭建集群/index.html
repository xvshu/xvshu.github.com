<div style="color:blue" align=center>【Nginx反向代理服务器】实践篇（三）之Tomcat+Nginx搭建集群</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">
<p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">继前面的博客，本篇博客来实践操作体会一下</span><span style="font-family: KaiTi_GB2312; font-size: 14pt;">&nbsp;</span></p><h1 style="margin-top:7pt;margin-bottom:7pt;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;">Nginx<span lang="zh-CN">配置过程如下：</span></span></h1><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin-top:7pt;margin-bottom:7pt"><span style="font-family:KaiTi_GB2312;"><span style="font-size: 14pt;">（1）到Nginx官网下载Nginx的Windows版本：<a target="_blank" target="_blank" href="http://nginx.org/en/download.html">点击打开链接</a></span><span style="font-size: 14pt;">（这里我们使用nginx/Windows-1.4.7版本进行实验）</span></span></p><p style="margin-top:7pt;margin-bottom:7pt;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">（2）解压到磁盘任意目录，例如这里我解压到虚拟机</span><span lang="en-US">1</span><span lang="zh-CN">中：C:\software\nginx-1.4.7</span></span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">（3）启动、停止和重新加载服务：通过cmd以守护进程方式启动nginx.exe：start nginx.exe，停止服务：nginx-s stop，重新加载配置：nginx -s</span><span lang="en-US">&nbsp; reload</span><span lang="zh-CN">；</span></span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><h2 style="margin-top:7pt;margin-bottom:7pt;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">修改</span><span lang="en-US">Nginx</span><span lang="zh-CN">核心配置文件</span><span lang="en-US">nginx.conf</span></span></h2><h3 style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">（1）进程数与每个进程的最大连接数：</span></h3><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;•nginx进程数，建议设置为等于CPU总核心数</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;•单个进程最大连接数，那么该服务器的最大连接数=连接数*进程数</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><img src="21307319221050" alt=""><br></span></p><p style="margin: 0in; font-size: 14pt;"><h3 style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">（2）Nginx的基本配置：</span></h3><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;•监听端口一般都为http端口：80;</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;•域名可以有多个，用空格隔开：例如&nbsp;</span><span lang="en-US">server_name </span><a target="_blank" target="_blank" href="http://www.sohu.com"><span lang="en-US">www.sohu.com</span></a><span lang="en-US"> </span><span lang="en-US">baidu.com</span><span lang="en-US">;</span></span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="en-US"><br></span></span></p><span style="font-family:KaiTi_GB2312;"><img src="50164897180070" alt=""><br></span><p style="margin: 0in; font-size: 14pt;"><h3 style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">（3）负载均衡列表基本配置：</span></h3><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">•location/ {}：对什么样的后缀进行负载均衡请求，假如我们要对所有的aspx后缀的文件进行负载均衡时，可以这样写：location ~ .*\.aspx$ {}</span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">•proxy_pass：请求转向自定义的服务器列表，这里我们将请求都转向标识为http://netitcast.com;的负载均衡服务器列表；</span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><img src="11577217873460" alt=""><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">•在负载均衡服务器列表的配置中，weight是权重，可以根据机器配置定义权重（如果某台服务器的硬件配置十分好，可以处理更多的请求，那么可以为其设置一个比较高的weight；而有一台的服务器的硬件配置比较差，那么可以将前一台的weight配置为weight=2，后一台差的配置为weight=1）。weigth参数表示权值，权值越高被分配到的几率越大；</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><span style="font-family:KaiTi_GB2312;"><img src="16051969664851" alt=""><br></span><p style="margin: 0in; font-size: 14pt;"><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN"><br></span></span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">以上仅仅是</span><span lang="en-US">nginx</span><span lang="zh-CN">的基础配置</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><h1 style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">测试说明：</span></h1><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">分别向两台虚拟机中的</span><span lang="en-US">tomcat</span><span lang="zh-CN">服务器中部署</span><span lang="en-US">hjy</span><span lang="en-US">.war</span><span lang="zh-CN">这个</span><span lang="en-US">web</span><span lang="zh-CN">项目（为了以示访问的是不同的</span><span lang="en-US">web</span><span lang="zh-CN">服务器，我们的两台虚拟机中部署的</span><span lang="en-US">hjy</span><span lang="zh-CN">这个项目在页面显示上略有不同），虚拟机</span><span lang="en-US">1</span><span lang="zh-CN">中，页面显示</span><span lang="en-US">test</span><span lang="en-US">1</span><span lang="zh-CN">，虚拟机</span><span lang="en-US">2</span><span lang="zh-CN">中页面显示</span><span lang="en-US">test2</span></span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">注：</span><span lang="en-US">1</span><span lang="zh-CN">，</span><span lang="en-US">254</span><span lang="zh-CN">是虚拟机</span><span lang="en-US">1</span><span lang="zh-CN">，配置的权重为</span><span lang="en-US">2,</span></span></p><p style="margin:0in;margin-left:.375in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="en-US">2</span><span lang="zh-CN">，</span><span lang="en-US">nginx</span><span lang="zh-CN">部署到</span><span lang="en-US">254</span><span lang="zh-CN">这台机子上了</span></span></p><p style="margin: 0in; font-size: 14pt;" lang="en-US"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">启动</span><span lang="en-US">nginx</span><span lang="zh-CN">，并启动两台虚拟机的</span><span lang="en-US">tomcat</span></span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="en-US"><br></span></span></p><span style="font-family:KaiTi_GB2312;"><img src="36770675674730" alt=""><br></span><p style="margin: 0in; font-size: 14pt;"><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><h2 style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">运行结果：</span></h2><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">访问</span><span lang="en-US">nginx</span><span lang="zh-CN">：http://localhost/hjy/test.jsp</span></span></p><span style="font-family:KaiTi_GB2312;"><img src="379525110110235" alt=""><br></span><p style="margin: 0in; font-size: 14pt;"><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">由于权重的不同，在我们不断刷新页面的过程中，显示</span><span lang="en-US">test</span><span lang="en-US">1</span><span lang="zh-CN">的可能性会大一些</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><h1 style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">扩展：</span><span lang="zh-CN" style="font-size: 14pt; font-family: KaiTi_GB2312;">添加</span><span lang="en-US" style="font-size: 14pt; font-family: KaiTi_GB2312;">Nginx</span><span lang="zh-CN" style="font-size: 14pt; font-family: KaiTi_GB2312;">对于静态文件的缓存配置</span></h1><p style="margin: 0in; font-size: 14pt;"><span style="font-family: KaiTi_GB2312;">&nbsp;</span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">为了提高响应速度，减轻真实服务器的负载，对于静态资源我们可以在反向代理服务器中进行缓存，这也是反向代理服务器的一个重要的作用。</span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">（1）缓存静态资源之图片文件</span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">root/nginx-1.4.7/staticresources/image：对于配置中提到的jpg/png等文件均定为到/nginx-1.4.7/staticresources/image文件夹中进行寻找匹配并将文件返回；</span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">expires7d：过期时效为7天，静态文件不怎么更新，过期时效可以设大一点，如果频繁更新，则可以设置得小一点；</span></p><p style="margin-top:7pt;margin-bottom:7pt;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="en-US">tips</span><span lang="zh-CN">：下面的样式、脚本缓存配置同这里一样，只是定位的文件夹不一样而已，不再赘述。</span></span></p><p style="margin-top:7pt;margin-bottom:7pt;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN"><br></span></span></p><span style="font-family:KaiTi_GB2312;"><img src="14681717710942" alt=""><br></span><p style="margin: 0in; font-size: 14pt;"><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">（2）缓存静态资源之样式文件</span></p><span style="font-family:KaiTi_GB2312;"><img src="9532645707556" alt=""><br></span><p style="margin: 0in; font-size: 14pt;"><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">（3）缓存静态资源之脚本文件</span></p><span style="font-family:KaiTi_GB2312;"><img src="17959386367634" alt=""><br></span><p style="margin: 0in; font-size: 14pt;"><br></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">（4）在nginx服务文件夹中创建静态资源文件夹，并要缓存的静态文件拷贝进去：这里我主要将Web程序中用到的image、css以及js文件拷贝了进去；</span></p><span style="font-family:KaiTi_GB2312;"><img src="28548839141398" alt=""><br></span><p style="margin: 0in; font-size: 14pt;"><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">（5）总结：通过配置静态文件的缓存设置，对于这些静态文件的请求可以直接从反向代理服务器中直接返回，而无需再将这些静态资源请求转发到具体的Web服务器进行处理了，可以提高响应速度，减轻真实Web服务器的负载压力。</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><h1 style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">总结：</span></h1><p style="margin-top:7pt;margin-bottom:7pt;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN"><br></span></span></p><p style="margin-top:7pt;margin-bottom:7pt;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">本文中我们使用Nginx在Windows环境下搭建了一个反向代理服务，并模拟了一个</span><span lang="en-US">Tomcat</span><span lang="zh-CN">服务器集群的负载均衡效果。从这个</span><span lang="en-US">demo</span><span lang="zh-CN">中，我们可以简单地感受到反向代理为我们所做的事情，并体会负载均衡是怎么一回事。</span></span></p><span style="font-family:KaiTi_GB2312;"><br></span><p style="margin: 0in; font-size: 14pt;"><h1 style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">附：</span></h1><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">每次以cmd方式启动Nginx服务不符合实际要求，于是我们想到将其注册为Windows服务，并设置为自动启动模式。这里，我们使用一个不错的小程序：“WindowsService Wrapper”，将nginx.exe注册为Windows服务，具体的步骤如下：</span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">①下载最新版的</span><span lang="en-US"> Windows Service Wrapper </span><span lang="zh-CN">程序，比如我下载的名称是</span><span lang="en-US"> “winsw-1.8-bin.exe”</span><span lang="zh-CN">（本文底部有下载地址），然后把它命名成你想要的名字（比如</span><span lang="en-US">:“nginx-service.exe”</span><span lang="zh-CN">，当然，你也可以不改名）</span></span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">②将重命名后的</span><span lang="en-US"> nginx-service.exe&nbsp;</span><span lang="zh-CN">复制到</span><span lang="en-US"> nginx </span><span lang="zh-CN">的安装目录（比如，我这里是</span><span lang="en-US"> “D:\Servers\nginx-1.4.7″</span><span lang="zh-CN">）</span></span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">③在同一个目录下创建一个</span><span lang="en-US">Windows Service Wrapper </span><span lang="zh-CN">的</span><span lang="en-US">XML</span><span lang="zh-CN">配置文件，名称必须与第一步重命名时使用的名称一致（比如我这里是</span><span lang="en-US"> “nginx-service.xml”, &nbsp;</span><span lang="zh-CN">如果，你没有重命名，则应该是</span><span lang="en-US"> “winsw-1.8-bin.xml”</span><span lang="zh-CN">），这个</span><span lang="en-US">XML</span><span lang="zh-CN">的内容如下：</span></span></p><p style="margin: 0in; font-size: 14pt;"><pre name="code" class="html">&lt;?xmlversion=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;service&gt;
&lt;id&gt;nginx&lt;/id&gt;
&lt;name&gt;Nginx Service&lt;/name&gt;
&lt;description&gt;High Performance NginxService&lt;/description&gt;
&lt;executable&gt;D:\Servers\nginx-1.4.7\nginx.exe&lt;/executable&gt;
&lt;logpath&gt;D:\Servers\nginx-1.4.7\&lt;/logpath&gt;
&lt;logmode&gt;roll&lt;/logmode&gt;
&lt;depend&gt;&lt;/depend&gt;
&lt;startargument&gt;-p D:\Servers\nginx-1.4.7&lt;/startargument&gt;
&lt;stopargument&gt;-p D:\Servers\nginx-1.4.7 -sstop&lt;/stopargument&gt;
&lt;/service&gt;</pre><br><p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">④在命令行下执行以下命令，以便将其注册成</span><span lang="en-US">Windows</span><span lang="zh-CN">服务：nginx-service.exe install</span></span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">⑤接下来就可以在</span><span lang="en-US">Windows</span><span lang="zh-CN">服务列表看到</span><span lang="en-US">Nginx</span><span lang="zh-CN">服务了，这里我们可以将其设置为自动启动了：</span></span></p><p style="margin-top: 7pt; margin-bottom: 7pt; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN"><br></span></span></p><span style="font-family:KaiTi_GB2312;"><img src="45350507037330" alt=""><br></span><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">（5）总结：在Windows环境中，要对外提供的Windows服务一般都要将其启动类型设置为自动。<br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin:0in;font-family:宋体;font-size:14.0pt"><br></p>   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/47262419'>原文链接</a>