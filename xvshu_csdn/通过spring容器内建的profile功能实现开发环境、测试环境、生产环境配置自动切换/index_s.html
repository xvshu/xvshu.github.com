<div class="articleLocationOnion"><a href='../../index.html'>首页: </a> &gt; <a href='../index_s.html'>未分类</a> &gt; 通过spring容器内建的profile功能实现开发环境、测试环境、生产环境配置自动切换</div><div style="color:blue" align=center>通过spring容器内建的profile功能实现开发环境、测试环境、生产环境配置自动切换</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">
软件开发的一般流程为工程师开发 -&gt; 测试 -&gt; 上线，因此就涉及到三个不同的环境，开发环境、测试环境以及生产环境，通常这三个环境会有很多配置参数不同，例如数据源、文件路径、url等，如果每次上线一个新版本时都手动修改配置会十分繁琐，容易出错。spring 为我们提供了 profile 机制来解决这个问题。<br><br><br>spring允许我们通过定义 profile 来将若干不同的 bean 定义组织起来，从而实现不同环境自动激活不同的 profile 来切换配置参数的功能，下面介绍以 xml 的方式定义 profile、如何激活 profile以及定义默认的 profile，整个过程我以配置不同环境的数据源为例，为了简化配置，这里假设只有开发和生产两个环境。<br><br><br>数据源定义为<br><p><pre code_snippet_id="1643642" snippet_file_name="blog_20160412_1_6217351" name="code" class="html">&lt;bean id=&quot;dataSource&quot; class=&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;&gt;
    &lt;property name=&quot;user&quot; value=&quot;${jdbc.user}&quot; /&gt; 
    &lt;property name=&quot;password&quot; value=&quot;${jdbc.password}&quot; /&gt; 
    &lt;property name=&quot;jdbcUrl&quot; value=&quot;${jdbc.jdbcUrl}&quot; /&gt;   
    &lt;property name=&quot;driverClass&quot; value=&quot;${jdbc.driverClass}&quot; /&gt;
    &lt;property name=&quot;initialPoolSize&quot; value=&quot;${c3p0.initialPoolSize}&quot;/&gt;
    &lt;property name=&quot;acquireIncrement&quot; value=&quot;${c3p0.acquireIncrement}&quot;/&gt;
    &lt;property name=&quot;minPoolSize&quot; value=&quot;${c3p0.minPoolSize}&quot;/&gt;
    &lt;property name=&quot;maxIdleTime&quot; value=&quot;${c3p0.maxIdleTime}&quot;/&gt;
    &lt;property name=&quot;idleConnectionTestPeriod&quot; value=&quot;${c3p0.idleConnectionTestPeriod}&quot; /&gt;
    &lt;property name=&quot;preferredTestQuery&quot; value=&quot;${c3p0.preferredTestQuery}&quot;/&gt;
&lt;/bean&gt;</pre><br><br><p><p><br></p><br>classpath下外部资源文件有两个 settings-development.properties 和 settings-production.properties，分别是开发环境和生产环境的数据源配置参数，内容如下<br><br><br>settings-development.properties<br><pre code_snippet_id="1643642" snippet_file_name="blog_20160412_2_3469116" name="code" class="html">jdbc.user=root
jdbc.password=111111
jdbc.driverClass=com.mysql.jdbc.Driver
jdbc.jdbcUrl=jdbc:mysql://localhost:3306/xxx
c3p0.minPoolSize=5 
c3p0.initialPoolSize=5
c3p0.acquireIncrement=5
c3p0.maxIdleTime=3600
c3p0.idleConnectionTestPeriod=3600
c3p0.preferredTestQuery=select 1</pre><br><br><br>settings-production.properties<br><pre code_snippet_id="1643642" snippet_file_name="blog_20160412_3_6326818" name="code" class="html">jdbc.user=xxx
jdbc.password=xxxx
jdbc.driverClass=com.mysql.jdbc.Driver
jdbc.jdbcUrl=jdbc:mysql:///xxx
c3p0.minPoolSize=20 
c3p0.initialPoolSize=20
c3p0.acquireIncrement=10
c3p0.maxIdleTime=3600
c3p0.idleConnectionTestPeriod=3600
c3p0.preferredTestQuery=select 1</pre><br><br><br><br><br>1. 定义 profile<br><br><br>现在就可以通过定义 profile 来将开发和生产环境的数据源配置分开，这里我们定义两个 profile，一个名称是 development，另一个名称是 production<br><pre code_snippet_id="1643642" snippet_file_name="blog_20160412_4_9848828" name="code" class="html">&lt;!-- 开发环境配置文件 --&gt;
&lt;beans profile=&quot;development&quot;&gt;
    &lt;context:property-placeholder location=&quot;classpath:settings-development.properties&quot;/&gt;
&lt;/beans&gt;
 
&lt;!-- 生产环境配置文件 --&gt;
&lt;beans profile=&quot;production&quot;&gt;
    &lt;context:property-placeholder location=&quot;classpath:settings-production.properties&quot;/&gt;
&lt;/beans&gt;</pre><br><br><br><br><br>2. 定义默认 profile<br><br><br>默认 profile 是指在没有任何 profile 被激活的情况下，默认 profile 内定义的内容将被使用，通常可以在 web.xml 中定义全局 servlet 上下文参数 spring.profiles.default 实现，代码如下<br><br><pre code_snippet_id="1643642" snippet_file_name="blog_20160412_5_7723041" name="code" class="html">&lt;!-- 配置spring的默认profile --&gt;
&lt;context-param&gt;
    &lt;param-name&gt;spring.profiles.default&lt;/param-name&gt;
    &lt;param-value&gt;development&lt;/param-value&gt;
&lt;/context-param&gt;</pre><br><br><br><br>3. 激活 profile&nbsp;<br><br><br>spring 为我们提供了大量的激活 profile 的方法，可以通过代码来激活，也可以通过系统环境变量、JVM参数、servlet上下文参数来定义 spring.profiles.active 参数激活 profile，这里我们通过定义 JVM 参数实现。<br>在生产环境中，以 tomcat 为例，我们在 tomcat 的启动脚本中加入以下 JVM 参数<br><br><pre code_snippet_id="1643642" snippet_file_name="blog_20160412_6_7341357" name="code" class="html">-Dspring.profiles.active=&quot;production&quot;</pre><br><br>而开发环境中不需要定义该参数，如果不定义，则会使用我们指定的默认 profile ，在这里也就是名称为 development 的 profile。这样当项目部署到不同的环境时，便可以通过 JVM 参数来实现不同环境 profile 自动激活。<br><br><br>4. 延伸<br><br><br>该参数还可以延伸，以至于我们可以在 java 代码中继续通过该参数来区分不同的环境，从而执行不同的操作，代码如下<br><br>public class Config {<br>&nbsp; &nbsp; &nbsp; public static String ENV = &quot;development&quot;;<br>}<br>public class InitConfigListener implements ServletContextListener {<br>&nbsp; &nbsp; public void contextInitialized(ServletContextEvent sce) {<br>&nbsp; &nbsp; &nbsp; &nbsp; //侦测jvm环境，并缓存到全局变量中<br>&nbsp; &nbsp; &nbsp; &nbsp; String env = System.getProperty(&quot;spring.profiles.active&quot;);<br>&nbsp; &nbsp; &nbsp; &nbsp; if(env == null) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Config.ENV = &quot;development&quot;;<br>&nbsp; &nbsp; &nbsp; &nbsp; } else {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Config.ENV = env;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; }<br>}<br>在项目初始化时获取到该参数后，我们便可以在项目任何位置使用，来执行一些不同环境需要区别对待的操作，例如统计流量的代码只需要在生产环境激活，就可以在jsp中加入如下代码<br><br>&lt;!-- 生产环境统计、推送代码 --&gt;<br>&lt;c:if test=&quot;${env == 'production' }&quot;&gt;<br>&lt;script&gt;<br>//统计代码<br>..<br>&lt;/script&gt;<br>&lt;/c:if&gt;   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/xvshu/article/details/51133786'>原文链接</a>