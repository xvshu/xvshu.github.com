<div style="color:blue" align=center>[WF40实战]WF40申请审批实例</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

<h1 style="margin:0in; font-family:SimSun; font-size:14.0pt">定义</h1>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">&nbsp;</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">百度百科：</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">&nbsp;</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><span lang="zh-CN">工作流</span><span lang="en-US">(Workflow)，就是“业务过程的部分或整体在计算机应用环境下的自动化”，它主要解决的是“使在多个参与者之间按照某种预定义的规则传递文档、信息或任务的过程自动进行，从而实现某个预期的业务目标，或者促使此目标的实现”。</span></p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">&nbsp;</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><span style="color:#cc0000">一句话：工作流就是一系列相互衔接、自动进行的业务活动。</span></p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">再通俗点就是对于一个业务需求不需要我们像以前一样手动去调用，而是使用工作流自动执行</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">&nbsp;</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">
<h1 style="margin:0in; font-family:SimSun; font-size:14.0pt">优势</h1>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><br>
</p>
<p style="margin:0in; font-size:14.0pt"><span lang="en-US" style="font-family:Calibri">1</span><span lang="zh-CN" style="font-family:SimSun">，不必手动去调各个方法，而由工作流控制程序的执行</span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="en-US" style="font-family:Calibri">2</span><span lang="zh-CN" style="font-family:SimSun">，状态的维护由工作流处理，减轻程序员工作量</span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="en-US" style="font-family:Calibri">3</span><span lang="zh-CN" style="font-family:SimSun">，更加面像对象（对于工作流的结点的抽象可以实现更好的复用）</span></p>
&nbsp;
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">&nbsp;</p>
<h1 style="margin:0in; font-family:SimSun; font-size:14.0pt">下面为简单的实现示例</h1>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">&nbsp;</p>
<p style="margin:0in; font-size:14.0pt"><span lang="en-US" style="font-family:Calibri">1</span><span lang="zh-CN" style="font-family:SimSun">，开发结点</span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="en-US" style="font-family:Calibri">2</span><span lang="zh-CN" style="font-family:SimSun">，根据需求组织工作流</span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="en-US" style="font-family:Calibri">3</span><span lang="zh-CN" style="font-family:SimSun">，使用工作流</span></p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">&nbsp;</p>
<h2 style="margin:0in; font-family:SimSun; font-size:14.0pt">开发工作流结点：</h2>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><br>
</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><span style="white-space:pre"><img src="26300198207253" alt=""></span></p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><span style="white-space:pre"><br>
</span></p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><span style="white-space:pre"></span></p>
<h2 style="margin:0in; font-family:SimSun; font-size:14.0pt">结点生成的相应活动：</h2>
<br>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><span style="white-space:pre"><span style="white-space:pre"><img src="22221908740252" alt=""></span></span>&nbsp;&nbsp;&nbsp;</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><br>
</p>
<h2 style="margin:0in; font-family:SimSun; font-size:14.0pt">组织相应的工作流：</h2>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><br>
</p>
<span style="white-space:pre"><img src="39505567390444" alt=""></span>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><span style="white-space:pre"></span></p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><br>
</p>
<h2 style="margin:0in; font-family:SimSun; font-size:14.0pt">使用工作流：</h2>
<br>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><span style="white-space:pre"><span style="white-space:pre"><img src="34630697019581" alt=""></span></span></p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><br>
</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">代码示例：</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><br>
</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">
<pre name="code" class="csharp">/// &lt;summary&gt;
    /// 启动工作流
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
    protected void Start_Click(object sender, EventArgs e)
    {
        RequestInfo.RequestInfo info = new RequestInfo.RequestInfo();
       
        info.InstanceID = Guid.Empty;
        info.RealName = txtRealName.Text;
        info.YourCompany = &quot;hjy&quot;;
        info.YourInterest = &quot;hjy&quot;;
        info.YourPost = &quot;1197321687@qq.com&quot;;      
        info.Email = &quot;hejingyuan&quot;;
        WorkFlowProcess.CreateAndRun(info);
        lbMsg.Text = &quot;申请成功，等待管理员审核...&quot;;
    }
</pre><br>
<pre name="code" class="csharp"> // creates a workflow application, binds parameters, links extensions and run it
        public static Guid CreateAndRun(RequestInfo.RequestInfo Request)
        {
            SqlWorkflowInstanceStore instanceStore = new SqlWorkflowInstanceStore(&quot;server=.;database=aspnetdb;uid=sa;pwd=123456&quot;);

            InstanceView view = instanceStore.Execute(instanceStore.CreateInstanceHandle(), new CreateWorkflowOwnerCommand(), TimeSpan.FromSeconds(30));

            instanceStore.DefaultInstanceOwner = view.InstanceOwner;

            IDictionary&lt;string, object&gt; input = new Dictionary&lt;string, object&gt; 
            {
                { &quot;Request&quot; , Request }
            };

            WorkflowApplication application = new WorkflowApplication(new ApplyBlogFlow(), input);

            application.InstanceStore = instanceStore;

            //获取或设置当前工作流实例处于空闲状态并可被保留时调用的 ActivityFunc
            application.PersistableIdle = (e) =&gt;
            {
                instanceUnloaded.Set();
                return PersistableIdleAction.Unload;
            };
            //获取或设置卸载当前工作流
            application.Unloaded = (e) =&gt;
            {
                instanceUnloaded.Set();
            };
            //获取或设置当前工作流实例遇到未处理的异常时
            application.OnUnhandledException = (ex) =&gt;
            {
                Console.Write(&quot;Exception&quot;);
                return UnhandledExceptionAction.Terminate;
            };

            Guid id = application.Id;

            application.Run();
            //阻止当前线程，直到当前waithand收到信号
            instanceUnloaded.WaitOne();
            return id;
        }
</pre><br>
<pre name="code" class="csharp">/// &lt;summary&gt;
    /// 激活工作流（输入工作流id）
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;sender&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
    protected void Activite_Click(object sender, EventArgs e)
    {
        RequestInfo.RequestInfo info = new RequestInfo.RequestInfo();
        info.InstanceID = Guid.Parse(lblQC.Text);        
        info.RealName = txtRealName.Text;
        info.Email = &quot;hejingyuan&quot;;
        info.Agree = &quot;true&quot;;
    
        WorkFlowProcess.RunInstance(info);
        lbMsg.Text = &quot;提交成功！&quot;;
    }
</pre><br>
<pre name="code" class="csharp">public static void RunInstance(RequestInfo.RequestInfo Request)
        {
            instanceUnloaded = new AutoResetEvent(false);
            SqlWorkflowInstanceStore instanceStore = new SqlWorkflowInstanceStore(&quot;server=.;database=aspnetdb;uid=sa;pwd=123456&quot;);

            IDictionary&lt;string, object&gt; input = new Dictionary&lt;string, object&gt; 
            {
                { &quot;Request&quot; , Request }
            };

            WorkflowApplication application1 = new WorkflowApplication(new ApplyBlogFlow());

            application1.InstanceStore = instanceStore;
            //工作流当前实例完成
            application1.Completed = (workflowApplicationCompletedEventArgs) =&gt;
            {

                Console.WriteLine(&quot;\nWorkflowApplication has Completed in the {0} state.&quot;, workflowApplicationCompletedEventArgs.CompletionState);

            };
            //卸载当前工作流
            application1.Unloaded = (workflowApplicationEventArgs) =&gt;
            {
                Console.WriteLine(&quot;WorkflowApplication has Unloaded\n&quot;);
                //发信号，说明值已经被写进去了。
                instanceUnloaded.Set();

            };

            application1.Load(Request.InstanceID);

            application1.ResumeBookmark(&quot;Apply&quot;, Request.Agree);
             //此段代码起作用了，之前是因为默认为true，并没有自动设置为false，故在前面手动设置了一下！2014年9月30日
            instanceUnloaded.WaitOne();

            Console.ReadLine();

            
        }
</pre><br>
<p>
<h1 style="margin:0in; font-family:SimSun; font-size:14.0pt">总结</h1>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt">&nbsp;</p>
<p style="margin:0in; font-size:14.0pt"><span lang="en-US" style="font-family:Calibri">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span lang="zh-CN" style="font-family:SimSun">有时候我们看&#20284;深奥的东西其实并非如此，任何知识只要潜心研究，其实都不难，重要的不是知识本身，而是要解决不怕不知道就怕不知道的问题！</span></p>
<br>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><br>
</p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><br>
</p>
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/39739883'>原文链接</a>