<div class="articleLocationOnion"><a href='../../index.html'>首页: </a> &gt; <a href='../index_s.html'>未分类</a> &gt; 【整合篇】Activiti业务与流程的整合</div><div style="color:blue" align=center>【整合篇】Activiti业务与流程的整合</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">&nbsp; &nbsp; 继上篇博客：<a target="_blank" href="http://blog.csdn.net/hejingyuan6/article/details/42871329">【整合篇】JBPM4.4业务与流程的整合</a></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">&nbsp; &nbsp; 对于无论是</span><span lang="en-US">Activtit</span><span lang="zh-CN">还是</span><span lang="en-US">jbpm</span><span lang="zh-CN">来说，业务与流程的整合均类&#20284;，启动流程是绑定业务，流程与业务的整合放到动态代理中</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<pre code_snippet_id="605354" snippet_file_name="blog_20150216_1_9848959" name="code" class="java">/**
     * 启动修改课程流程Leave leave, 
     *
     * @param leave
     */
    @RequestMapping(value = &quot;start&quot;, method = RequestMethod.POST)
    public String startWorkflow(Leave leave,RedirectAttributes redirectAttributes, HttpSession session) {
        try {
        	
            User user = UserUtil.getUserFromSession(session);
            // 用户未登录不能操作，实际应用使用权限框架实现，例如Spring Security、Shiro等
            if (user == null || StringUtils.isBlank(user.getId())) {
                return &quot;redirect:/login?timeout=true&quot;;
            }            
            leave.setUserId(user.getId());
            Map&lt;String, Object&gt; variables = new HashMap&lt;String, Object&gt;(); 
            variables.put(&quot;leave&quot;, leave);
            //保存业务实体
            leave.setTestId(new Date().toString());            
            leaveBean.saveBeforeEntity(leave); 
            
            Leave Leavetest=null;
            Leavetest=leaveBean.queryByTestid(leave.getTestId());
            leave=Leavetest;
            logger.debug(&quot;save entity: {}&quot;, leave); 
            
            
            //不再获取id，改为获取类  .getClass().getSimpleName().toString();          
            //String businessKey = &quot;leave&quot;;            
            String businessKey = leave.getId().toString();            
            ProcessInstance processInstance = null;
            
           /*添加的代码--begin--Proxy*/
            
            // 调用业务，保存申请信息		
    		startNode.common(businessKey, variables,runtimeService,identityService);
    		LogHandler1 logHandler = startNode.new LogHandler1();
    		//放到代理中设置值了
    		//stuCourseApply.setExecuteId(pi.getId());
    		
    		LeaveBean leaveBeanProxy=(LeaveBean)logHandler.newProxyInstanceStart(leaveBean);  
    		leaveBeanProxy.updeatChangeApply(leave);	
            
    	/*添加的代码--end--Proxy*/
         
    		
    	/*放到代理中--begin--Proxy*/ 
           /* try {
                // 用来设置启动流程的人员ID，引擎会自动把用户ID保存到activiti:initiator中
            	identityService.setAuthenticatedUserId(leave.getUserId());                                
                processInstance = runtimeService.startProcessInstanceByKey(&quot;easyChangeCourse&quot;, businessKey, variables);
                String processInstanceId = processInstance.getId();
                leave.setProcessInstanceId(processInstanceId);
                logger.debug(&quot;start process of {key={}, bkey={}, pid={}, variables={}}&quot;, new Object[]{&quot;easyChangeCourse&quot;, processInstanceId, variables});
            } finally {
                identityService.setAuthenticatedUserId(null);
            }*/
    	/*放到代理中--end--Proxy*/     
    		
    	//+ processInstance.getId()
            redirectAttributes.addFlashAttribute(&quot;message&quot;, &quot;流程已启动&quot; );
        } catch (ActivitiException e) {
            if (e.getMessage().indexOf(&quot;no processes deployed with key&quot;) != -1) {
                logger.warn(&quot;没有部署流程!&quot;, e);
                redirectAttributes.addFlashAttribute(&quot;error&quot;, &quot;没有部署流程，请在[工作流]-&gt;[流程管理]页面点击&lt;重新部署流程&gt;&quot;);
            } else {
                logger.error(&quot;启动请假流程失败：&quot;, e);
                redirectAttributes.addFlashAttribute(&quot;error&quot;, &quot;系统内部错误！&quot;);
            }
        } catch (Exception e) {
            logger.error(&quot;启动请假流程失败：&quot;, e);
            redirectAttributes.addFlashAttribute(&quot;error&quot;, &quot;系统内部错误！&quot;);
        }
        return &quot;redirect:/oa/leave/apply&quot;;
    }
</pre><br>
<p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14pt">动态代理：</p>
<p style="margin:0in; font-size:14pt"><br>
</p>
<p style="margin:0in; font-size:14pt">
<pre code_snippet_id="605354" snippet_file_name="blog_20150216_2_1437590" name="code" class="java">package com.tgb.itoo.activiti.controller;

import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;
import java.util.Map;

import org.activiti.engine.IdentityService;
import org.activiti.engine.RuntimeService;
import org.activiti.engine.runtime.ProcessInstance;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;
import com.tgb.itoo.basic.entity.Leave;

@Component
@Transactional
public class StartNode{

	private Logger logger = LoggerFactory.getLogger(getClass());
	//定义一个属性变量
	private Map&lt;String, Object&gt; variables;
	private String businessKey;
	
	//设置人人员
	protected IdentityService identityService;
	@Autowired
    public void setIdentifyService(IdentityService identityService) {
		this.identityService = identityService;
	}
	protected RuntimeService runtimeService;
	@Autowired
    public void setRuntimeService(RuntimeService runtimeService) {
        this.runtimeService = runtimeService;
    }
	
	@Autowired
    RuntimeService runtimeService1;
	
	public void common(String businessKey,Map&lt;String, Object&gt; variables,RuntimeService runtimeService,IdentityService identityService){
		this.variables=variables;
		this.businessKey=businessKey;
		this.runtimeService=runtimeService;
		this.identityService=identityService;
	}
	//想尝试能否根据其他方式传参，new的话太耗费资源
	/*public StartAbstractJBPM(String pdKey,Map&lt;String, Object&gt; variablesMap,JBPMService jbpmService){
		this.variablesMap=variablesMap;
		this.pdKey=pdKey;
		this.jbpmService=jbpmService;
	}*/
					
	
	//动态代理类只能代理接口（不支持抽象类），代理类都需要实现InvocationHandler类，实现invoke方法。该invoke方法就是调用被代理接口的所有方法时需要调用的，该invoke方法返回的值是被代理接口的一个实现类     
	public class LogHandler1 implements InvocationHandler{  	  
    // 目标对象  
    private Object targetObject;  
    //绑定关系，也就是关联到哪个接口（与具体的实现类绑定）的哪些方法将被调用时，执行invoke方法。              
    public Object newProxyInstanceStart(Object targetObject){  
        this.targetObject=targetObject;  
        //该方法用于为指定类装载器、一组接口及调用处理器生成动态代理类实例    
        //第一个参数指定产生代理对象的类加载器，需要将其指定为和目标对象同一个类加载器  
        //第二个参数要实现和目标对象一样的接口，所以只需要拿到目标对象的实现接口  
        //第三个参数表明这些被拦截的方法在被拦截时需要执行哪个InvocationHandler的invoke方法  
        //根据传入的目标返回一个代理对象  
        return Proxy.newProxyInstance(targetObject.getClass().getClassLoader(),  
                targetObject.getClass().getInterfaces(),this);  
    }  
	  
    @Override  
    //关联的这个实现类的方法被调用时将被执行  
   // InvocationHandler接口的方法，proxy表示代理，method表示原对象被调用的方法，args表示方法的参数  
    public Object invoke(Object proxy, Method method, Object[] args)  
            throws Throwable {  
        System.out.println(&quot;start--&gt;&gt;&quot;);  
        for(int i=0;i&lt;args.length;i++){  
            System.out.println(args[i]);  
        }  
        Object ret=null;  
        try{  
            //原对象方法调用前处理日志信息  
            System.out.println(&quot;satrt--&gt;&gt;&quot;); 
        		           	 
            //启动流程
            //调用目标方法  
            Leave leave=(Leave)args[0];          
            // 用来设置启动流程的人员ID，引擎会自动把用户ID保存到activiti:initiator中
            try {
        	identityService.setAuthenticatedUserId(leave.getUserId());                                
        	ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(&quot;ChangeCourse&quot;, businessKey, variables);
            String processInstanceId = processInstance.getId();
            
            leave.setProcessInstanceId(processInstanceId);
            logger.debug(&quot;start process of {key={}, bkey={}, pid={}, variables={}}&quot;, new Object[]{&quot;ChangeCourse&quot;, processInstanceId, variables});
            } finally {
                identityService.setAuthenticatedUserId(null);
            }
            args[0]=leave;
            ret=method.invoke(targetObject, args);  
            
            //调用完成当前结点
    		// &gt;&gt; 办理完第1个任务“提交申请”		
            //jbpmService.completeFirstTask(pi);  
    		
            //原对象方法调用后处理日志信息  
            System.out.println(&quot;success--&gt;&gt;&quot;);  
        }catch(Exception e){  
            e.printStackTrace();  
            System.out.println(&quot;error--&gt;&gt;&quot;);  
	            throw e;  
	        }  
	        return ret;  
	    }			
	}	

}
</pre><br>
<pre code_snippet_id="605354" snippet_file_name="blog_20150216_3_2045484" name="code" class="java">/**
     * 任务列表ERROR [stderr] (http-localhost/127.0.0.1:8080-3) ScriptEngineManager providers.next(): javax.script.ScriptEngineFactory: Provider com.sun.script.javascript.RhinoScriptEngineFactory not found
     *
     * @param leave
     */
    @RequestMapping(value = &quot;list/task&quot;)
    public ModelAndView taskList(HttpSession session, HttpServletRequest request) {
    	List&lt;Map&lt;String, Object&gt;&gt; results = new ArrayList&lt;Map&lt;String, Object&gt;&gt;();
    	String userId = UserUtil.getUserFromSession(session).getId();
    	results=abstractTaskList(userId);    	
    	return new ModelAndView(&quot;/oa/leave/taskList&quot;,&quot;results&quot;,results);
                               
    }
</pre><br>
<pre code_snippet_id="605354" snippet_file_name="blog_20150216_4_7321223" name="code" class="java">/**
     * 抽象出来的查看任务列表，与基本业务无关
     *
     * @param userId 用户id
     * @return
     */
	public List&lt;Map&lt;String, Object&gt;&gt; abstractTaskList(String userId){
		 List&lt;Leave&gt; results = new ArrayList&lt;Leave&gt;();
	     // 根据当前人的ID查询
	     TaskQuery taskQuery = taskService.createTaskQuery().taskCandidateOrAssigned(userId);        
	     List&lt;Task&gt; tasks = taskQuery.list();     
	     int i=0;	   
	     
	     List&lt;Map&lt;String, Object&gt;&gt; mapList = new ArrayList&lt;Map&lt;String, Object&gt;&gt;();
	     // 根据流程的业务ID查询实体并关联
	     for (Task task : tasks) {
	         String processInstanceId = task.getProcessInstanceId();
	         ProcessInstance processInstance = runtimeService.createProcessInstanceQuery().processInstanceId(processInstanceId).active().singleResult();
	         String businessKey = processInstance.getBusinessKey();
	         if (businessKey == null) {
	             continue;
	         } 
	         
	         Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
	         
	         Leave leave = leaveBean.findEntityById(businessKey);
	         
	    	//leave.setProcessInstance(processInstance);
	 		//leave.setProcessDefinition(getProcessDefinition(processInstance.getProcessDefinitionId()));	                
 		//leave.setTask(task);
	 		
			 map.put(&quot;leave&quot;, leave);//存入“申请信息”
			 map.put(&quot;task&quot;, task);
			 map.put(&quot;processDefinition&quot;, getProcessDefinition(processInstance.getProcessDefinitionId()));
			 map.put(&quot;processInstance&quot;, processInstance);//存入“流程实例”
			 mapList.add(map);
	         /*Leave leave=updateEntity(processInstance,task,businessKey);
	         results.add(leave); */
	         i=i+1;
	     }
		return mapList;
	}
</pre><br>
<pre code_snippet_id="605354" snippet_file_name="blog_20150216_5_8136861" name="code" class="java">/**
     * 读取运行中的流程实例(查看我的申请)involvedUser(userId)(涉及到的用户)
     *
     * @return
     */
    @RequestMapping(value = &quot;list/running&quot;)
    public ModelAndView runningList(HttpSession session,HttpServletRequest request) {
    	String userId = UserUtil.getUserFromSession(session).getId();
    	List&lt;Map&lt;String, Object&gt;&gt; results = new ArrayList&lt;Map&lt;String, Object&gt;&gt;();
    	results=abstractRuningList(userId);
  
    	return new ModelAndView (&quot;/oa/leave/running&quot;,&quot;results&quot;,results);
       }
</pre><br>
<pre code_snippet_id="605354" snippet_file_name="blog_20150216_6_1219991" name="code" class="java">/**
     * 抽象出来读取运行中的流程实例(查看我的申请)，与基本业务无关
     *
     * @param userId 用户id
     * @return
     */
	public List&lt;Map&lt;String, Object&gt;&gt; abstractRuningList(String userId){
		List&lt;Leave&gt; results = new ArrayList&lt;Leave&gt;();
		ProcessInstanceQuery query = runtimeService.createProcessInstanceQuery().processDefinitionKey(&quot;ChangeCourse&quot;).involvedUser(userId).active().orderByProcessInstanceId().desc();//根据流程定义Key查询流程实例
    	List&lt;ProcessInstance&gt; list = query.list();
    	List&lt;Map&lt;String, Object&gt;&gt; mapList = new ArrayList&lt;Map&lt;String, Object&gt;&gt;();
    	// 关联业务实体
        for (ProcessInstance processInstance : list) {
            String businessKey = processInstance.getBusinessKey();
            if (businessKey == null) {
                continue;
            }
            // 设置当前任务信息
            List&lt;Task&gt; tasks = taskService.createTaskQuery().processInstanceId(processInstance.getId()).active().orderByTaskCreateTime().desc().listPage(0, 1);
            Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
	         
            Leave leave = leaveBean.findEntityById(businessKey);
            
       		/*leave.setProcessInstance(processInstance);
    		leave.setProcessDefinition(getProcessDefinition(processInstance.getProcessDefinitionId()));	                
    		leave.setTask(tasks.get(0));*/
    		
    		 map.put(&quot;leave&quot;, leave);//存入“考试信息”
			 map.put(&quot;task&quot;, tasks.get(0));
			 map.put(&quot;processDefinition&quot;, getProcessDefinition(processInstance.getProcessDefinitionId()));
			 map.put(&quot;processInstance&quot;, processInstance);//存入“流程实例”
			 mapList.add(map);
	         /*Leave leave=updateEntity(processInstance,task,businessKey);
	         results.add(leave); */
	        
	        
            //Leave leave=updateEntity(processInstance,tasks.get(0),businessKey);
	        
	        
        }
        return mapList;
	}
</pre><br>
<pre code_snippet_id="605354" snippet_file_name="blog_20150216_7_7052138" name="code" class="java">/**
     * 读取完成的流程实例（已经完成的流程申请-我）
     *
     * @return
     */
    @RequestMapping(value = &quot;list/finished&quot;)
    public ModelAndView finishedList(HttpSession session,HttpServletRequest request) {
    	 String userId = UserUtil.getUserFromSession(session).getId();  
    	 List&lt;Leave&gt; results = new ArrayList&lt;Leave&gt;();
         HistoricProcessInstanceQuery query = historyService.createHistoricProcessInstanceQuery().processDefinitionKey(&quot;ChangeCourse&quot;).involvedUser(userId).finished().orderByProcessInstanceEndTime().desc();
         List&lt;HistoricProcessInstance&gt; list = query.list();
         List&lt;Map&lt;String, Object&gt;&gt; mapList = new ArrayList&lt;Map&lt;String, Object&gt;&gt;();
         // 关联业务实体
         for (HistoricProcessInstance historicProcessInstance : list) {
        	 Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
             String businessKey = historicProcessInstance.getBusinessKey();
             Leave leave = leaveBean.findEntityById(businessKey);
            /* leave.setProcessDefinition(getProcessDefinition(historicProcessInstance.getProcessDefinitionId()));
             leave.setHistoricProcessInstance(historicProcessInstance);            
             results.add(leave);*/ 
             map.put(&quot;leave&quot;, leave);//存入“申请信息”			
			 map.put(&quot;processDefinition&quot;, getProcessDefinition(historicProcessInstance.getProcessDefinitionId()));
			 map.put(&quot;historicProcessInstance&quot;, historicProcessInstance);//存入“流程实例”
			 mapList.add(map);
             
         }
        
        return new ModelAndView(&quot;/oa/leave/finished&quot;,&quot;results&quot;,mapList);
    }
</pre><br>
<pre code_snippet_id="605354" snippet_file_name="blog_20150216_8_6264592" name="code" class="java"> /**
     * 完成任务
     *
     * @param id
     * @return
     */
    @RequestMapping(value = &quot;/complete/{id}&quot;, method = {RequestMethod.POST, RequestMethod.GET})
    @ResponseBody
    public String complete(@PathVariable(&quot;id&quot;) String taskId, Variable var) {
        try { 
        	//deptLeaderPass=true or  hrBackReason=666, hrPass=false-----{leaderBackReason=78, deptLeaderPass=false}
        	Map&lt;String, Object&gt; variables = var.getVariableMap();
        	//taskService.getVariables(taskId);
        	//Object variablesResult=variables.get(&quot;deptLeaderPass&quot;);        	
        	//variablesResult=variables.get(&quot;hrPass&quot;);
        	
        	taskService.complete(taskId, variables);        	
        	
            //获取map中的值
//            if(hrPass=true){
//            	//更新业务表信息
//            }
            return &quot;success&quot;;
        } catch (Exception e) {
            logger.error(&quot;error on complete task {}&quot;, new Object[]{taskId, e});
            return &quot;error&quot;;
        }
    }
</pre><br>
<br>
<p>
<br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">总结：</span></span></span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">&nbsp; &nbsp; 对于在流程与业务的整合中应用动态代理也不知道是否符合</span><span lang="en-US">AOP</span><span lang="zh-CN">的理念，类&#20284;其他方面的流程操作还未抽取出来（交互太多），在这里记录一下学习</span><span lang="en-US">Activiti</span><span lang="zh-CN">的一个过程，在之后的尝试中可以换个方式，换个思路，直接将整个工作流应用抽取出来（请假，修改课程等）。</span></span><br>
</span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br>
</span></span></span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br>
</span></span></span></p>
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/43850413'>原文链接</a>