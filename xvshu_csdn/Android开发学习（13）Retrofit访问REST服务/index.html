<div style="color:blue" align=center>Android开发学习（13）Retrofit访问REST服务</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">
        <div class="markdown_views"><p>前段时间，有个博友在讨论区提了一个web封装的框架Retrofit，正好接上篇博客，我们搭建了一个简单的rest服务。</p>



<h1 id="简介">简介</h1>

<blockquote>
  <p>准确来说，Retrofit 是一个 RESTful 的 HTTP 网络请求框架的封装,网络请求的工作本质上是 OkHttp 完成，而 Retrofit 仅负责 网络请求接口的封装,App应用程序通过 Retrofit 请求网络，实际上是使用 Retrofit 接口层封装请求参数、Header、Url 等信息，之后由 OkHttp 完成后续的请求操作,在服务端返回数据之后，OkHttp 将原始的结果交给 Retrofit，Retrofit根据用户的需求对结果进行解析.</p>
</blockquote>

<p>流程如下： <br>
<img src="31175278576381" alt="flow" title=""></p>

<p>步骤1：添加Retrofit库的依赖 <br>
步骤2：创建 接收服务器返回数据 的类 <br>
步骤3：创建 用于描述网络请求 的接口 <br>
步骤4：创建 Retrofit 实例 <br>
步骤5：创建 网络请求接口实例 并 配置网络请求参数 <br>
步骤6：发送网络请求（异步 / 同步） <br>
<code>封装了 数据转换、线程切换的操作</code> <br>
步骤7： 处理服务器返回的数据</p>



<h1 id="引入步骤">引入步骤</h1>



<h2 id="maven">maven</h2>



<pre class="prettyprint"><code class=" hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>com.squareup.retrofit2<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>retrofit<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>2.2.0<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>com.squareup.retrofit2<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>converter-wire<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>2.2.0<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>com.squareup.retrofit2<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>converter-gson<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>2.2.0<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>com.google.code.gson<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>gson<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>2.8.1<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span></code></pre>



<h2 id="封装retrofit相关">封装Retrofit相关</h2>



<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">package</span> com.xvshu.android.web.common;

<span class="hljs-keyword">import</span> retrofit2.Retrofit;
<span class="hljs-keyword">import</span> retrofit2.converter.gson.GsonConverterFactory;
<span class="hljs-keyword">import</span> retrofit2.converter.wire.WireConverterFactory;

<span class="hljs-javadoc">/**
 * Created by xvshu on 2017/8/16.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RetrofitUtils</span> {</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String baseUrl = <span class="hljs-string">"http://172.30.53.58:8080/rest/"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Retrofit  retrofit = <span class="hljs-keyword">null</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Retrofit <span class="hljs-title">getRetrofit</span>(){
        <span class="hljs-keyword">if</span>(retrofit==<span class="hljs-keyword">null</span>){
            retrofit = <span class="hljs-keyword">new</span> Retrofit.Builder()
                    .addConverterFactory(GsonConverterFactory.create())
                    .addConverterFactory(WireConverterFactory.create())
                    .baseUrl(baseUrl)
                    .build();
        }
        <span class="hljs-keyword">return</span> retrofit;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title">genService</span>(Class&lt;T&gt; tClass)<span class="hljs-keyword">throws</span> InstantiationException {
        <span class="hljs-keyword">return</span> getRetrofit().create(tClass);
    }
}
</code></pre>



<h2 id="定义service">定义service</h2>



<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">package</span> com.xvshu.android.web;

<span class="hljs-keyword">import</span> retrofit2.Call;
<span class="hljs-keyword">import</span> retrofit2.http.GET;
<span class="hljs-keyword">import</span> retrofit2.http.Path;

<span class="hljs-javadoc">/**
 * Created by xvshu on 2017/8/16.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UseService</span> {</span>
    <span class="hljs-annotation">@GET</span>(<span class="hljs-string">"user/android/{userName}/{passWord}"</span>)
    Call&lt;String&gt; login(<span class="hljs-annotation">@Path</span>(<span class="hljs-string">"userName"</span>) String userName,<span class="hljs-annotation">@Path</span>(<span class="hljs-string">"passWord"</span>) String passWord);
}
</code></pre>



<h2 id="具体访问">具体访问</h2>

<p>重写登录代码:</p>



<pre class="prettyprint"><code class=" hljs avrasm">@Override
    public void onClick(View v) {
        final String userid = useridEt<span class="hljs-preprocessor">.getText</span>()<span class="hljs-preprocessor">.toString</span>()<span class="hljs-preprocessor">.trim</span>()<span class="hljs-comment">;</span>
        final String pass = passEt<span class="hljs-preprocessor">.getText</span>()<span class="hljs-preprocessor">.toString</span>()<span class="hljs-preprocessor">.trim</span>()<span class="hljs-comment">;</span>
        if(userid<span class="hljs-preprocessor">.equals</span>(<span class="hljs-string">""</span>)){
            promptText<span class="hljs-preprocessor">.setText</span>(<span class="hljs-string">"用户名为空"</span>)<span class="hljs-comment">;</span>
            return <span class="hljs-comment">;</span>
        }
        if(pass<span class="hljs-preprocessor">.equals</span>(<span class="hljs-string">""</span>)){
            promptText<span class="hljs-preprocessor">.setText</span>(<span class="hljs-string">"密码为空"</span>)<span class="hljs-comment">;</span>
            return <span class="hljs-comment">;</span>
        }

        Boolean isLoginSucess = false<span class="hljs-comment">;</span>
        try {
            UseService useService = RetrofitUtils<span class="hljs-preprocessor">.genService</span>(UseService<span class="hljs-preprocessor">.class</span>)<span class="hljs-comment">;</span>
            <span class="hljs-keyword">Call</span>&lt;String&gt; repos  =useService<span class="hljs-preprocessor">.login</span>(userid,pass)<span class="hljs-comment">;</span>
            repos<span class="hljs-preprocessor">.enqueue</span>(new Callback&lt;String&gt;() {
                              @Override
                              public void onResponse(<span class="hljs-keyword">Call</span>&lt;String&gt; <span class="hljs-keyword">call</span>, Response&lt;String&gt; response) {
                                  Log<span class="hljs-preprocessor">.i</span>(<span class="hljs-string">"loginOnFailure"</span>, response<span class="hljs-preprocessor">.body</span>()<span class="hljs-preprocessor">.toString</span>())<span class="hljs-comment">;</span>
                                  if (response<span class="hljs-preprocessor">.body</span>()<span class="hljs-preprocessor">.equals</span>(<span class="hljs-string">"true"</span>)) {
                                      Toast<span class="hljs-preprocessor">.makeText</span>(RetrofitActivity<span class="hljs-preprocessor">.this</span>, <span class="hljs-string">"Rest登录成功！"</span>, Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
                                      if(cbRememberPass<span class="hljs-preprocessor">.isChecked</span>()) {
                                          //记住用户名、密码、
                                          SharedPreferences<span class="hljs-preprocessor">.Editor</span> editor = spUser<span class="hljs-preprocessor">.edit</span>()<span class="hljs-comment">;</span>
                                          editor<span class="hljs-preprocessor">.putString</span>(spKeyUser, userid)<span class="hljs-comment">;</span>
                                          editor<span class="hljs-preprocessor">.putString</span>(spKeyPass,pass)<span class="hljs-comment">;</span>
                                          editor<span class="hljs-preprocessor">.commit</span>()<span class="hljs-comment">;</span>
                                      }else{
                                          //不记住用户名、密码
                                          SharedPreferences<span class="hljs-preprocessor">.Editor</span> editor = spUser<span class="hljs-preprocessor">.edit</span>()<span class="hljs-comment">;</span>
                                          editor<span class="hljs-preprocessor">.putString</span>(spKeyUser, <span class="hljs-string">""</span>)<span class="hljs-comment">;</span>
                                          editor<span class="hljs-preprocessor">.putString</span>(spKeyPass,<span class="hljs-string">""</span>)<span class="hljs-comment">;</span>
                                          editor<span class="hljs-preprocessor">.commit</span>()<span class="hljs-comment">;</span>
                                      }

                                      Intent intent_hello = new Intent(RetrofitActivity<span class="hljs-preprocessor">.this</span>, HelloActivity<span class="hljs-preprocessor">.class</span>)<span class="hljs-comment">;</span>
                                      startActivity(intent_hello)<span class="hljs-comment">;</span>
                                  } else {
                                      Toast<span class="hljs-preprocessor">.makeText</span>(RetrofitActivity<span class="hljs-preprocessor">.this</span>, <span class="hljs-string">"登录失败"</span>, Toast<span class="hljs-preprocessor">.LENGTH</span>_LONG)<span class="hljs-preprocessor">.show</span>()<span class="hljs-comment">;</span>
                                  }

                              }

                              @Override
                              public void onFailure(<span class="hljs-keyword">Call</span>&lt;String&gt; <span class="hljs-keyword">call</span>, Throwable throwable) {
                                  Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"loginOnFailure"</span>, throwable<span class="hljs-preprocessor">.getMessage</span>(),throwable)<span class="hljs-comment">;</span>
                              }
                          }
            )<span class="hljs-comment">;</span>

        }catch (Exception ex){
            Log<span class="hljs-preprocessor">.e</span>(<span class="hljs-string">"=RetrofitUtils=&gt;"</span>,<span class="hljs-string">"RetrofitUtils.genService(UseService.class)"</span>,ex)<span class="hljs-comment">;</span>
            isLoginSucess=false<span class="hljs-comment">;</span>
        }


    }</code></pre>

<p>效果： <br>
<img src="14893615659153" alt="restlogin" title=""></p>

<p>后台日志： <br>
<img src="338828610120956" alt="log" title=""></p>

<blockquote>
  <p><strong>源码地址：</strong> <br>
  <a href="https://github.com/xvshu/xvshu_android_test" target="_blank">git_xvshu_android_test</a></p>
</blockquote></div>
        <script>
            $(function () {
                $('pre.prettyprint code').each(function () {
                    var lines = $(this).text().split('\n').length;
                    var $numbering = $('<ul/>').addClass('pre-numbering').hide();
                    $(this).addClass('has-numbering').parent().append($numbering);
                    for (i = 1; i <= lines; i++) {
                        $numbering.append($('<li/>').text(i));
                    };
                    $numbering.fadeIn(1700);
                });
            });
        </script>
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/xvshu/article/details/77337310'>原文链接</a>