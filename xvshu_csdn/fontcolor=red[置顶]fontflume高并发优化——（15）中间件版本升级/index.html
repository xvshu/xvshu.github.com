<div style="color:blue" align=center>fontcolor=red[置顶]fontflume高并发优化——（15）中间件版本升级</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">
        <div class="markdown_views"><p>在系统平稳运行一年的基础上，为提供更好的服务，现针对java，kafka，flume，zk,统一进行版本升级，请各位小伙伴跟着走起来，不要掉队啊！</p>

<table>
<thead>
<tr>
  <th align="center">名称</th>
  <th align="center">老版本号</th>
  <th align="center">新版本号</th>
</tr>
</thead>
<tbody><tr>
  <td align="center">jdk</td>
  <td align="center">1.7.0_25</td>
  <td align="center">1.8.0</td>
</tr>
<tr>
  <td align="center">kafka</td>
  <td align="center">2.10-0.8.0.1</td>
  <td align="center">2.10-0.10.2.1</td>
</tr>
<tr>
  <td align="center">flume</td>
  <td align="center">1.6.0</td>
  <td align="center">1.7.0</td>
</tr>
<tr>
  <td align="center">zookeeper</td>
  <td align="center">3.4.6</td>
  <td align="center">3.4.8</td>
</tr>
</tbody></table>


<h1 id="jdkzookeeperflume">jdk,zookeeper,flume:</h1>

<p>这两个中间件平滑升级，没有特殊的地方，参考其他博客就好</p>



<h1 id="kafka">kafka:</h1>

<p>这个的变化还是很大的，咱们详细说来</p>



<h2 id="1zk的作用">1，zk的作用</h2>

<p>offsets,这个值，标记kafka消费到哪了，以前由zk维护，但是，遇到并发比较大的情况，zk的数据出现错误的几率变大，目前版本交由kafka本身维护，kafka本身创建了一个topic解决这个问题，topic：__consumer_offsets，在最新的版本，zk的作用仅仅在维护集群主从关系上了，作用降低。</p>



<h2 id="2消费端变化">2，消费端变化</h2>

<p>消费端的配置，发生了变化，和flume 1.6有些区别，但是1.7的版本还是对这些做了适配，基本配置不用变化。</p>



<h2 id="3监控的变化">3，监控的变化</h2>

<p>以前的监控是基于zk的，目前已经不满足与最新的kafka，监控中间件升级为kafkamanager，将最新版本的zip包下载到服务器，解压，并配置就可使用,配置如下：</p>



<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-preprocessor"># Copyright 2015 Yahoo Inc. Licensed under the Apache License, Version 2.0</span>
<span class="hljs-preprocessor"># See accompanying LICENSE file.</span>

<span class="hljs-preprocessor"># This is the main configuration file for the application.</span>
<span class="hljs-preprocessor"># ~~~~~</span>

<span class="hljs-preprocessor"># Secret key</span>
<span class="hljs-preprocessor"># ~~~~~</span>
<span class="hljs-preprocessor"># The secret key is used to secure cryptographics functions.</span>
<span class="hljs-preprocessor"># If you deploy your application to several instances be sure to use the same key!</span>
play<span class="hljs-preprocessor">.crypto</span><span class="hljs-preprocessor">.secret</span>=<span class="hljs-string">"^&lt;csmm5Fx4d=r2HEX8pelM3iBkFVv?k[mc;IZE&lt;_Qoq8EkX_/7@Zt6dP05Pzea3U"</span>
play<span class="hljs-preprocessor">.crypto</span><span class="hljs-preprocessor">.secret</span>=${?APPLICATION_SECRET}

<span class="hljs-preprocessor"># The application languages</span>
<span class="hljs-preprocessor"># ~~~~~</span>
play<span class="hljs-preprocessor">.i</span>18n<span class="hljs-preprocessor">.langs</span>=[<span class="hljs-string">"en"</span>]

play<span class="hljs-preprocessor">.http</span><span class="hljs-preprocessor">.requestHandler</span> = <span class="hljs-string">"play.http.DefaultHttpRequestHandler"</span>
play<span class="hljs-preprocessor">.http</span><span class="hljs-preprocessor">.context</span> = <span class="hljs-string">"/"</span>
play<span class="hljs-preprocessor">.application</span><span class="hljs-preprocessor">.loader</span>=loader<span class="hljs-preprocessor">.KafkaManagerLoader</span>

kafka-manager<span class="hljs-preprocessor">.zkhosts</span>=<span class="hljs-string">"10.1.115.181:2181,10.1.114.221:2181,10.1.114.231:2181/kafka"</span>
<span class="hljs-preprocessor"># kafka-manager.zkhosts=${?ZK_HOSTS}</span>
pinned-dispatcher<span class="hljs-preprocessor">.type</span>=<span class="hljs-string">"PinnedDispatcher"</span>
pinned-dispatcher<span class="hljs-preprocessor">.executor</span>=<span class="hljs-string">"thread-pool-executor"</span>
application<span class="hljs-preprocessor">.features</span>=[<span class="hljs-string">"KMClusterManagerFeature"</span>,<span class="hljs-string">"KMTopicManagerFeature"</span>,<span class="hljs-string">"KMPreferredReplicaElectionFeature"</span>,<span class="hljs-string">"KMReassignPartitionsFeature"</span>]

akka {
  loggers = [<span class="hljs-string">"akka.event.slf4j.Slf4jLogger"</span>]
  loglevel = <span class="hljs-string">"INFO"</span>
}


basicAuthentication<span class="hljs-preprocessor">.enabled</span>=true
basicAuthentication<span class="hljs-preprocessor">.username</span>=<span class="hljs-string">"admin"</span>
basicAuthentication<span class="hljs-preprocessor">.password</span>=<span class="hljs-string">"admin"</span>
basicAuthentication<span class="hljs-preprocessor">.realm</span>=<span class="hljs-string">"Kafka-Manager"</span>
basicAuthentication<span class="hljs-preprocessor">.excluded</span>=[<span class="hljs-string">"/api/health"</span>] <span class="hljs-preprocessor"># ping the health of your instance without authentification</span>
</code></pre>

<p>如果出现jdk的问题，可以通过指定路径的方式解决：</p>



<pre class="prettyprint"><code class=" hljs bash"><span class="hljs-shebang">#!/usr/bin/env bash</span>
<span class="hljs-comment">###  ------------------------------- ###</span>
<span class="hljs-comment">###  Helper methods for BASH scripts ###</span>
<span class="hljs-comment">###  ------------------------------- ###</span>
JAVA_HOME=<span class="hljs-string">"/Data/servers/jdk8"</span>

<span class="hljs-function"><span class="hljs-title">die</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span> <span class="hljs-number">1</span>&gt;&amp;<span class="hljs-number">2</span>
  <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
}</code></pre>

<p>监控界面如下： <br>
<img src="14446807533919" alt="这里写图片描述" title=""></p>



<h1 id="总结">总结：</h1>

<p>在本次升级中，主要是为了增加flume与kafka的并发，因为数据的问题，对es并未进行升级，但是在以后中，我们还是会对es进行升级，做数据平移，或者做双数据源，因为日志最多存过30天，这样的方案，还是非常容易的，请大家继续关注后续的博客。</p></div>
        <script>
            $(function () {
                $('pre.prettyprint code').each(function () {
                    var lines = $(this).text().split('\n').length;
                    var $numbering = $('<ul/>').addClass('pre-numbering').hide();
                    $(this).addClass('has-numbering').parent().append($numbering);
                    for (i = 1; i <= lines; i++) {
                        $numbering.append($('<li/>').text(i));
                    };
                    $numbering.fadeIn(1700);
                });
            });
        </script>
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/xvshu/article/details/75652405'>原文链接</a>