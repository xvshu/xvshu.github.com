<div class="articleLocationOnion"><a href='../../index.html'>首页: </a> &gt; <a href='../index_s.html'>未分类</a> &gt; OSGI实例demo说明（二）</div><div style="color:blue" align=center>OSGI实例demo说明（二）</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">下面我们就来真正的写一个实例</span><span lang="en-US">demo</span><span lang="zh-CN">，结合</span><span lang="en-US">OSGI</span><span lang="zh-CN">的优点来说明一下，该</span><span lang="en-US">demo</span><span lang="zh-CN">设计如下图：</span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="886088801356" alt=""><br>
</span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">这个</span><span lang="en-US">demo</span><span lang="zh-CN">包含五个</span><span lang="zh-CN">Bundles</span><span lang="zh-CN">：</span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">SayHello Bundle 包含一个接口，只有唯一的方法sayHello()；</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span style="font-size:14pt">BobSays</span><span style="font-size:14pt">、</span><span style="font-size:14pt">RodSays</span><span style="font-size:14pt">、</span><span style="font-size:14pt">KentSays</span><span style="font-size:14pt">三个</span><span style="font-size:14pt">Bundles</span><span style="font-size:14pt">分别实现了三个具体的</span><span style="font-size:14pt">sayHello()</span><span style="font-size:14pt">；</span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span style="font-size:14pt">SayHelloServiceBundle</span><span style="font-size:14pt">提供了说</span><span style="font-size:14pt">hello</span><span style="font-size:14pt">的机会，是具体的一个服务应用，在功能上有点类&#20284;于</span><span style="font-size:14pt">main</span><span style="font-size:14pt">函数的味道。</span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">这个HelloWorlddemo 的目的不但可以让读者小试牛刀，而且可以同时体会一下OSGi 最大的优点——服务状态的可更改性。</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">BobSays、RodSays、KentSays 实现了SayHello 暴露的接口，它们是sayHello 的具体执行者，但是在SayHelloService 调用的过程中，我们可以动态的改变到底是谁（BobSays、RodSays、KentSays）来说。</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">为了实现这个demo，还需要简单介绍一下OSGi 最简单的实现机制：OSGiBundles 之间包的依赖关系。每一个OSGi Bundle 的类文件可分为私有的、引入的、暴露的三种，如下图所示</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="36694077848992" alt=""><br>
</p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt">
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">在OSGi 中ExportedClasses 是以包的方式暴露的，如图所示，SayHello 中暴露了接口所在的包，对应的BobSays等三个Bundles 和SayHelloService Bundle 都引入了该包，这是OSGi 中最简单的通信方式，OSGi 规范中推荐使用面向服务的通信方式，这里只是举一个简单的实例，因此不用做的那么复杂。</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14pt"><span style="font-family:KaiTi_GB2312">实战开始：</span><span style="font-family:KaiTi_GB2312; font-size:14pt">&nbsp;</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">新建一个名为SayHello 的plug-inproject，在Target Platform 选项中，选择an OSGi Framework：Equinox。我们自己设置了Activator路径为org.osgi.demo.sayHello.Activator，每个Activator 都具有两个方法，start()和stop()，这两个方法是该bundle
 启动、停止的时候，调用的方法，通常在这里注册、初始化或注销该Bundle 服务的过程，这里不需要更改任何Activator 中的内容，用系统自动生成的就可以了。</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="1410037305446" alt=""><br>
<p><span style="font-family:KaiTi_GB2312; font-size:18px"><br>
</span></p>
<p><span style="font-family:KaiTi_GB2312; font-size:18px">在建立好项目后，会出现对SayHello项目的配置，这里可以通过dependencies 选项卡，设置需要的plug-in 和引入的package；可以通过runtime 选项卡的设置，确定暴露哪些包。我们新建一个org.osgi.demo.say 包，并建立SayHello 接口，只有一个返回void的方法sayHello() ，并将此包设为暴露的（<span style="background:red">通过这种暴露方式实现了信息隐藏</span>）。这些设置都保存在项目的META-INF目录下的MANIFEST.MF文件中，以后要更改的话，只需打开该文件即可。</span></p>
<p><span style="font-family:KaiTi_GB2312; font-size:18px"><br>
</span></p>
&nbsp; &nbsp; &nbsp; &nbsp;<img src="39027518762096" alt=""><br>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">SayHello 接口的代码如下：</span><br>
</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<pre code_snippet_id="614225" snippet_file_name="blog_20150308_1_6700906" name="code" class="java">package org.osgi.demo.say;

public interface SayHello {
	
	 public void sayHello();
}</pre>
<p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">同样类&#20284;的新建一个名为BobSays的plug-inproject。设置的包为org.osgi.demo.bob，这里需要在配置dependencies 的时候，将包org.osgi.demo.say 引入。</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="26446289401642" alt=""><br>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">&nbsp; &nbsp; &nbsp;<img src="50679767760054" alt=""><br>
</span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">创建新的类BobSays，代码如下：<br>
</span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<pre code_snippet_id="614225" snippet_file_name="blog_20150308_2_698733" name="code" class="java">package org.osgi.demo.bob;

import org.osgi.demo.say.SayHello;

public class BobSays implements SayHello {
    public void sayHello() {
        System.out.println(&quot;Bob says \&quot;Hello OSGi world\&quot;&quot;);
    }
}</pre>
<p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">这里需要覆写在BobSaysBundle 中的Activator 的两个方法，具体代码如下：</span></p>
<pre code_snippet_id="614225" snippet_file_name="blog_20150308_3_401555" name="code" class="cpp">package org.osgi.demo.bobsays;

import org.osgi.demo.bob.BobSays;
import org.osgi.demo.say.SayHello;
import org.osgi.framework.BundleActivator;
import org.osgi.framework.BundleContext;
import org.osgi.framework.ServiceRegistration;

public class Activator implements BundleActivator {

	
		private ServiceRegistration serviceReg = null;
		public void start(BundleContext context) throws Exception {
		        serviceReg = context.registerService(SayHello.class.getName(),
		                new BobSays(), null);// 1
		    }
		public void stop(BundleContext context) throws Exception {
		        if (serviceReg != null)
		            serviceReg.unregister();// 2
		    }
		}</pre>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">完成的主要功能是：1、在启动服务的时候，注册BoySays服务为一个SayHello服务；2、在停止服务的时候，从上下文中卸载该服务。</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">类&#20284;的创建KentSays、RodSays 两个project。</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">最后，创建一个名为SayHelloService的plug-inproject。设置的包为org.osgi.demo.service，同样在配置dependencies 的时候，将包org.osgi.demo.say 引入。</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="17172417528976" alt=""><br>
</p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt">&nbsp; &nbsp; &nbsp;&nbsp;<img src="19831366192528" alt=""></p>
<p><span style="font-family:KaiTi_GB2312; font-size:18px"><br>
</span></p>
<p><span style="font-family:KaiTi_GB2312; font-size:18px">创建SayHelloService类，代码如下：</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<pre code_snippet_id="614225" snippet_file_name="blog_20150308_4_3418645" name="code" class="java">package org.osgi.demo.service;

import org.osgi.demo.say.SayHello;

public class SayHelloService {

	private SayHello say;
	public void helloWorld() {
	        for (int i = 0; i &lt; 10; i++) {
	            try {
	                Thread.sleep(1000);
	            } catch (InterruptedException e) {
	                e.printStackTrace();
	                System.err.println(&quot;Thread can&#39;t sleep&quot;);
	            }
	            say.sayHello();
	        }
	    }

	public void setSay(SayHello say) {
	        this.say = say;
	    }

}
</pre><br>
<p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">这里采用依赖注入的方式，所以有一个setSay()方法，来设置一个具体的SayHello。helloWorld() 方法就是调用特定的SayHello.sayHello() 来完成的，用10秒钟的时间打印十次sayHello()的具体内容。该Bundle 的Activator
 代码如下：<br>
</span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<pre code_snippet_id="614225" snippet_file_name="blog_20150308_5_264548" name="code" class="java">package org.osgi.demo.sayhelloservice;

import org.osgi.demo.say.SayHello;
import org.osgi.demo.service.SayHelloService;
import org.osgi.framework.BundleActivator;
import org.osgi.framework.BundleContext;
import org.osgi.framework.ServiceReference;
import org.osgi.framework.ServiceRegistration;

public class Activator implements BundleActivator {
private ServiceRegistration serviceReg = null;
public void start(BundleContext context) throws Exception {
	
        SayHelloService sayService = new SayHelloService();
        /*serviceReg = context.registerService(SayHelloService.class.getName(),
                sayService, null);// 1
*/        
        ServiceReference serviceRef = context
                .getServiceReference(SayHello.class.getName());// 2
        
        sayService.setSay((SayHello) context.getService(serviceRef));// 2
        
        sayService.helloWorld();// 3
    }
public void stop(BundleContext context) throws Exception {
        if (serviceReg != null)
            serviceReg.unregister();
    }
}</pre>
<p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">完成的主要功能是：1、注册SayHelloService服务；2、获取一个的SayHello 服务；3、并注入到SayHelloService服务中，现在注入的服务是从服务上下文中具体获取的，而到底是哪个，只有在运行时状态才能决定。</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14pt"><span style="font-family:KaiTi_GB2312">运行：</span></p>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">&nbsp;&nbsp;<img src="6660096704109" alt=""></span></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><br>
</p>
<p><span style="font-family:KaiTi_GB2312; font-size:18px">选择Open Run Dialog...，并选中上述3个Bundles 和OSGi 核心Bundle，点击Run 按钮。输入“ss”，列出了3个Bundles 的状态（在这里我只建立了BobSays），此时，如果你的SayHelloService Bundle 状态是Resolved，那么你可以通过命令“start ‘SayHelloServiceBundle 状态的id’”，启动SayHelloService，此时你会看到打印出的10条hello
 world信息。读者可以手动利用用命令“start” 和“stop” 改变sayHello 的具体执行者，动态的更换实际sayHello 的执行者。这个简单的HelloWorld 应用，可以说明SayHelloService 在具体执行的过程中行为是可动态改变的（<span style="background:red">根据启动不同实现动态指定让谁来说</span>），并且改变只是局部的。</span></p>
<p><span style="font-family:KaiTi_GB2312; font-size:18px"><br>
</span></p>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="17061066792429" alt="">
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"></span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14pt"><span style="font-family:KaiTi_GB2312">总结</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">通过以上简单的实例</span><span lang="en-US">demo</span><span lang="zh-CN">，相信大家已经能理解前文所说的</span><span lang="en-US">OSGI</span><span lang="zh-CN">架构的一些模块化特征，这个demo只是一个基础，在学习的初期一个入门实例，由于OSGi
 字面上的意思太过于抽象，我们在学习的时候还是要结合实例去理解比较容易。</span></span></p>
<br>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><br>
</span></p>
<p style="margin-top:7pt; margin-bottom:7pt; font-size:14.0pt"><span lang="zh-CN"><br>
</span></p>
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/44131035'>原文链接</a>