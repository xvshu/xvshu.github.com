<div class="articleLocationOnion"><a href='../../index.html'>首页: </a> &gt; <a href='../index_s.html'>未分类</a> &gt; 【应用篇】Activiti外置表单实例demo（四）</div><div style="color:blue" align=center>【应用篇】Activiti外置表单实例demo（四）</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">
<p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN"><br></span></span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">在这里我想说的外置表单，是说我们将我们自己的</span><span lang="en-US">jsp</span><span lang="zh-CN">（</span><span lang="en-US">.form</span><span lang="zh-CN">，</span><span lang="en-US">.html</span><span lang="zh-CN">）等页面上传到工作流的数据库中，当任务执行到当前结点时，给我们像前台发送绑定好的表单。</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">此处是给表单绑定表单的过程</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><img src="51396368166167" alt=""><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><img src="118168106119" alt=""><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p style="margin: 0in; font-size: 14pt;"><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">不同意为：${deptLeaderPass =='false'}</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">下面我们看</span><span lang="zh-CN">对应的页面内容：</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN"><span style="font-family: KaiTi_GB2312; font-size: 19px;">start.form</span>简单的</span><span lang="en-US">html</span><span lang="zh-CN">页面：</span></span></p><span style="font-family:KaiTi_GB2312;"></span><pre code_snippet_id="687540" snippet_file_name="blog_20150608_1_9281096" name="code" class="html">&lt;table border=&quot;1&quot;&gt;
	&lt;tr&gt;
		&lt;td&gt;请假类型：&lt;/td&gt;
		&lt;td&gt;
			&lt;select id=&quot;leaveType&quot; name=&quot;fp_leaveType&quot;&gt;
				&lt;option&gt;公休&lt;/option&gt;
				&lt;option&gt;病假&lt;/option&gt;
				&lt;option&gt;调休&lt;/option&gt;
				&lt;option&gt;事假&lt;/option&gt;
				&lt;option&gt;婚假&lt;/option&gt;
			&lt;/select&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td&gt;开始时间：&lt;/td&gt;
		&lt;td&gt;&lt;input type=&quot;text&quot; id=&quot;startTime&quot; name=&quot;fp_startTime&quot; class=&quot;datetime required&quot; /&gt;&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td&gt;结束时间：&lt;/td&gt;
		&lt;td&gt;&lt;input type=&quot;text&quot; id=&quot;endTime&quot; name=&quot;fp_endTime&quot; class=&quot;datetime required&quot; /&gt;&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td&gt;请假原因：&lt;/td&gt;
		&lt;td&gt;
			&lt;textarea id=&quot;reason&quot; name=&quot;fp_reason&quot;&gt;&lt;/textarea&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;</pre><br><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">dept-leader-audit.form页面：<br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"></span></p><pre code_snippet_id="687540" snippet_file_name="blog_20150608_2_8752780" name="code" class="html">&lt;table class='view-info'&gt;
	&lt;tr&gt;
		&lt;td width=&quot;100&quot; class=&quot;label&quot;&gt;申请人：&lt;/td&gt;
		&lt;td name=&quot;userId&quot;&gt;${applyUserId}&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td class=&quot;label&quot;&gt;假种：&lt;/td&gt;
		&lt;td name=&quot;leaveType&quot;&gt;${leaveType}&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td class=&quot;label&quot;&gt;请假&lt;font color=&quot;red&quot;&gt;开始&lt;/font&gt;时间：&lt;/td&gt;
		&lt;td name=&quot;startTime&quot;&gt;${startTime}&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td class=&quot;label&quot;&gt;请假&lt;font color=&quot;red&quot;&gt;结束&lt;/font&gt;时间：&lt;/td&gt;
		&lt;td name=&quot;endTime&quot;&gt;${endTime}&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td class=&quot;label&quot;&gt;请假事由：&lt;/td&gt;
		&lt;td name=&quot;reason&quot;&gt;${reason}&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr&gt;
		&lt;td class=&quot;label&quot;&gt;是否同意申请：&lt;/td&gt;
		&lt;td&gt;
			&lt;select id=&quot;deptLeaderPass&quot; name=&quot;fp_deptLeaderPass&quot;&gt;
				&lt;option value=&quot;true&quot;&gt;同意&lt;/option&gt;
				&lt;option value=&quot;false&quot;&gt;驳回&lt;/option&gt;
			&lt;/select&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
	&lt;tr id=&quot;leaderBackReasonTr&quot;&gt;
		&lt;td class=&quot;label&quot;&gt;驳回理由：&lt;/td&gt;
		&lt;td&gt;
			&lt;textarea id=&quot;leaderBackReason&quot; name=&quot;fp_leaderBackReason&quot;&gt;&lt;/textarea&gt;
		&lt;/td&gt;
	&lt;/tr&gt;
&lt;/table&gt;</pre><p><p style="margin: 0in; font-size: 14pt;"><p style="margin:0in;font-size:14.0pt"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">hr-audit.form也类似均是很简单的</span><span lang="en-US">HTML</span><span lang="zh-CN">页面。</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">对应的核心工作流实现代码：</span></p><span style="font-family:KaiTi_GB2312;"></span><pre code_snippet_id="687540" snippet_file_name="blog_20150608_3_831780" name="code" class="java">/*
	 * 启动流程 启动流程，只考虑首次登录。 首次登录：启动工作流，并且更新/{processDefinitionId} @RequestMapping(value = &quot;get-form/start/{processDefinitionId}&quot;)
	 */
	@RequestMapping(value = &quot;/start/{processDefinitionId}&quot;)	
	public String start(@PathVariable(&quot;processDefinitionId&quot;) String processDefinitionId,HttpServletRequest request) throws Exception {

		try {			
			// 定义map用于往工作流数据库中传值。
			Map&lt;String, String&gt; formProperties = new HashMap&lt;String, String&gt;();						
			//启动流程-何静媛-2015年5月24日--processDefinitionId,
			ProcessInstance processInstance = formService
					.submitStartFormData(processDefinitionId,
							formProperties);
			// 返回到显示用户信息的controller 		
			logger.debug(&quot;start a processinstance: {}&quot;, processInstance);			
			return &quot;redirect:/workflow/auto/get-form/task/&quot;+ processInstance.getId();
			
		} catch (Exception e) {   
			throw e; 
		} finally {
			identityService.setAuthenticatedUserId(null);
		}
		

	}
	
	/**
	 * 读取Task的表单
	 * @RequestMapping(value = &quot;get-form/task/{processDefinitionkey}&quot;)
	 * @PathVariable(&quot;processDefinitionkey&quot;) String processDefinitionkey
	 */
	@RequestMapping(value = &quot;/get-form/task/{processInstanceId}&quot;)
	@ResponseBody
	public ModelAndView findTaskForm(
			@PathVariable(&quot;processInstanceId&quot;) String processInstanceId,
			HttpServletRequest request) throws Exception {
		ModelAndView mav = new ModelAndView(&quot;leave/apply&quot;);
		// 获取当前登陆人信息。
		/* User user = UserUtil.getUserFromSession(request.getSession()); */
		
		TaskQuery taskQuery = taskService.createTaskQuery()
				.processInstanceId(processInstanceId).orderByProcessInstanceId().desc();
				
		List&lt;Task&gt; tasks = taskQuery.list();
		if (tasks.size()==0) {
			ModelAndView mav2 = new ModelAndView(&quot;leave/finish&quot;);
			return mav2;
		}
		Task task = tasks.get(0);
		Object renderedTaskForm = formService.getRenderedTaskForm(task.getId());
		System.out.println(renderedTaskForm.toString());
		mav.addObject(&quot;renderedTaskForm&quot;, renderedTaskForm.toString());//整个页面，参数已经赋值（整个页面是什么时候赋上值的？）
		mav.addObject(&quot;taskId&quot;, task.getId());
		mav.addObject(&quot;processInstanceId&quot;, processInstanceId);
		return mav;
	}

	/**
     * 办理任务，提交task的并保存form
     */
    @RequestMapping(value = &quot;task/complete/{taskId}/{processInstanceId}&quot;)
    @SuppressWarnings(&quot;unchecked&quot;)
    public String completeTask(@PathVariable(&quot;taskId&quot;) String taskId,@PathVariable(&quot;processInstanceId&quot;) String processInstanceId, RedirectAttributes redirectAttributes, HttpServletRequest request) {
        
    	Map&lt;String, String&gt; formProperties = new HashMap&lt;String, String&gt;();

        // 从request中读取参数然后转换
        Map&lt;String, String[]&gt; parameterMap = request.getParameterMap();
        Set&lt;Entry&lt;String, String[]&gt;&gt; entrySet = parameterMap.entrySet();
        for (Entry&lt;String, String[]&gt; entry : entrySet) {
            String key = entry.getKey();

      /*
       * 参数结构：fq_reason，用_分割 fp的意思是form paremeter 最后一个是属性名称
       */
            if (StringUtils.defaultString(key).startsWith(&quot;fp_&quot;)) {
                String[] paramSplit = key.split(&quot;_&quot;);
                formProperties.put(paramSplit[1], entry.getValue()[0]);
            }
        }

        logger.debug(&quot;start form parameters: {}&quot;, formProperties);

        try {
            formService.submitTaskFormData(taskId, formProperties);
        } finally {
            identityService.setAuthenticatedUserId(null);
        }

        redirectAttributes.addFlashAttribute(&quot;message&quot;, &quot;任务完成：taskId=&quot; + taskId);
        return &quot;redirect:/workflow/auto/get-form/task/&quot;+processInstanceId;
       
    }

    </pre><br><p style="margin: 0in; font-size: 14pt;"><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">那么对应的提交表单的方式怎么实现的呢？</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin:0in;font-size:14.0pt" lang="en-US"><span style="font-family:KaiTi_GB2312;">Apply.jsp</span></p><span style="font-family:KaiTi_GB2312;"></span><pre code_snippet_id="687540" snippet_file_name="blog_20150608_4_8974063" name="code" class="html">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot;%&gt;
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot; &quot;http://www.w3.org/TR/html4/loose.dtd&quot;&gt;
&lt;html&gt;
&lt;head&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot;&gt;
&lt;title&gt;申请信息&lt;/title&gt; 
&lt;/head&gt;
&lt;body&gt;
&lt;form name=&quot;form1&quot; id=&quot;form1&quot; action=&quot;${pageContext.request.contextPath}/workflow/auto/task/complete/${taskId}/${processInstanceId}&quot;&gt;
		&lt;div style=&quot;margin: 0 auto;&quot;&gt;${renderedTaskForm}&lt;/div&gt; 
		 &lt;input type=&quot;hidden&quot; name=&quot;taskId&quot;
			value=&quot;${taskId}&quot;&gt;
			&lt;input type=&quot;hidden&quot; name=&quot;processInstanceId&quot;
			value=&quot;${processInstanceId}&quot;&gt;
		&lt;div&gt;
			 &lt;table style=&quot;margin: auto&quot; width=&quot;600&quot;&gt;
				&lt;tr&gt;			
					&lt;td align=&quot;right&quot; &gt;
					&lt;input type=&quot;submit&quot;  value=&quot;下一步&quot; /&gt;
					&lt;/td&gt;
				&lt;/tr&gt;
			&lt;/table&gt; 
		&lt;/div&gt; 
	&lt;/form&gt; 
&lt;/body&gt;
&lt;/html&gt;
</pre><br><br><p style="margin: 0in; font-size: 14pt;"><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">我们让所有的表单（在没有完成任务时，均返回到</span><span lang="en-US">apply.jsp</span><span lang="zh-CN">页面中，可以让每个页面均添加上下一步的按钮）因为对于完成来说，所有的任务均对应以上的方法实现。</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">总结：使用这种外置表单的方式相比我们静态表单的方式有什么区别呢？</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="en-US">1</span><span lang="zh-CN">，外置表单的方式不需要我们建立任何实体，所有的数据均存放到工作流的数据库，任何业务来了均可以使用，当然工作流也支持保存到工作流库中的数据的所有查询操作，直接调用相应的</span><span lang="en-US">api</span><span lang="zh-CN">即可。</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="en-US">2</span><span lang="zh-CN">，需要我们画简单的</span><span lang="en-US">html</span><span lang="zh-CN">页面，对于提交表单等的操作可以使用</span><span lang="en-US">js</span><span lang="zh-CN">单独来操作，如果添加到</span><span lang="en-US">jsp</span><span lang="zh-CN">或</span><span lang="en-US">html</span><span lang="zh-CN">页面中，工作流表单在执行时是不识别的，会报错误</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="zh-CN">附录：</span><span lang="en-US">demo</span><span lang="zh-CN">说明</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="en-US">1</span><span lang="zh-CN">，修改连接的数据库</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="en-US">2</span><span lang="zh-CN">，初始化用户，初始化脚本在</span><span lang="en-US">src/resources</span><span lang="zh-CN">目录下</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="en-US">3</span><span lang="zh-CN">，访问地址http://localhost:8080/activitiDemo</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><span lang="en-US">4</span><span lang="zh-CN">，登录后，需要部署流程才可以使用，流程文件在diagrams文件夹下，打成压缩包上传即可。</span></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;">&nbsp;</span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><a target="_blank" href="http://download.csdn.net/detail/hejingyuan6/8784599" target="_blank">activiti外置表单demo</a><br></span></p><p style="margin: 0in; font-size: 14pt;"><span style="font-family:KaiTi_GB2312;"><br></span></p><p><br></p><p><br></p>   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/46412285'>原文链接</a>