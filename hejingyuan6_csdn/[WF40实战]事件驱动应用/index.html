<div style="color:blue" align=center>[WF40实战]事件驱动应用</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">看到题目也许很多人都会疑问，为什么要使用事件监听呢？</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">目前的认识：</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">1,</span><span lang="zh-CN">使用事件监听可以将工作流的结点返回&#20540;返回到客户端</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">2,</span><span lang="zh-CN">可以实现等待与重启，相当于之前的</span><span lang="en-US">WaitActivity</span><span lang="zh-CN">创建</span><span lang="en-US">BookMark</span><span lang="zh-CN">的方式</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">至于使用</span><span lang="en-US">WorkflowInvoker</span><span lang="en-US">或</span><span lang="zh-CN">者</span><span lang="en-US">WorkflowApplication</span><span lang="zh-CN">这两种方式暂时还没能实现工作流的节点&#20540;返回到客户端。但是对于等待流是可以实现的！</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">当然要注意的是，如果需要进行事件的监听，则不能使用</span><span lang="en-US">WorkflowInvoker</span><span lang="en-US">或者</span><span lang="en-US">WorkflowApplication</span><span lang="en-US">来启动流程，而是需要通过</span><span lang="en-US">WorkflowServiceHost</span><span lang="en-US">来启动监听（</span><span lang="zh-CN">而且</span><span lang="en-US">这里有个根本区别，</span><span lang="en-US">WorkflowServiceHost</span><span lang="en-US">只是启动监听，并不立即创建</span><span lang="en-US">Workflow</span><span lang="en-US">的实例）</span></span></p>
<p lang="en-US" style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">具体实现：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">WF</span><span lang="zh-CN">：</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">拖放一个</span><span lang="en-US">Receive到PickBranch的Trigger里面（我们设置了这个Receive的ServiceContractName，和OperationName，可以随便取名，没有太多限制。这里其实是使用了WCF的技术。</span><span lang="zh-CN">）</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><img src="51065487728215" alt=""><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">&nbsp;<img src="132157263159" alt=""><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">我们可以选择</span><span lang="en-US">Receive</span><span lang="en-US">这个</span><span lang="en-US">Activity</span><span lang="en-US">，然后在右键菜单中找到</span><span lang="en-US">Create
 SendReply</span><span lang="zh-CN">，然后找到合适的位置粘贴即可！可以生成相应的</span><span lang="en-US">SendReplyTo</span><span lang="zh-CN">，与</span><span lang="en-US">Receive</span><span lang="zh-CN">自动关联</span></span></p>
<br>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><img src="44051508684248" alt=""><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">那么，我们到底要发送什么数据给用户呢？可以点击</span><span lang="en-US">Activity</span><span lang="en-US">上面的</span><span lang="en-US">Content</span><span lang="en-US">这个地方</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="en-US"><br>
</span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="en-US">&nbsp; &nbsp; &nbsp;<img src="136612810029397" alt=""><br>
</span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="en-US"><br>
</span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14.0pt">
<p lang="en-US" style="margin:0in; font-size:14pt">&nbsp;<span style="font-family:KaiTi_GB2312">WCF</span></p>
<p lang="en-US" style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">新建一个“控制台应用程序”（</span><span lang="en-US">Host</span><span lang="zh-CN">）</span><span lang="en-US">,</span><span lang="zh-CN">添加相应的引用</span></span></p>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="21227007131692" alt="">
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">宿主程序（通过代码的方式启动工作流服务）即将工作流作为一种服务发布出去：</span></p>
<br>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<pre code_snippet_id="485475" snippet_file_name="blog_20141016_1_7137831" name="code" class="csharp">namespace Host
{
    class Program
    {
        static void Main(string[] args)
        {
            var host = new WorkflowServiceHost(
                new DocumentReviewLib.DocumentReviewWorkflow(),
                new Uri(&quot;http://localhost:8080/DRS&quot;));

            host.AddDefaultEndpoints();
            host.Description.Behaviors.Add(
                new ServiceMetadataBehavior() { HttpGetEnabled = true });

            host.AddServiceEndpoint(
                &quot;IMetadataExchange&quot;,
                MetadataExchangeBindings.CreateMexHttpBinding(),
                &quot;mex&quot;);

            host.Open();
            Console.WriteLine(&quot;Server is ready.&quot;);
            Console.Read();

        }
    }
}
</pre><br>
<p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">点击</span><span lang="en-US">F5</span><span lang="zh-CN">即可启动服务，在浏览器中可以查看服务</span></span></p>
<p style="margin:0in; font-size:14pt">&nbsp;</p>
<p style="margin:0in; font-size:14pt">&nbsp; &nbsp;&nbsp;<img src="17250996245286" alt=""><br>
</p>
<br>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">那么将这部做完以后我们客户端是怎样调用我们封装的这么一个工作流的服务呢</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">我们希望客户端调用这个工作流的服务呢是一个非常松的耦合，那么我们可以用一个非常简单的办法，去生成呢对这个服务的一个代理，通过这个代理类来进行调用</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">生成他的代理类</span></p>
<p lang="en-US" style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">根据上面页面的提示，我们可以产生一个服务代理类。注意，要使用</span><span lang="en-US">Visual Studio Command Prompt</span><span lang="en-US">，而不是默认的</span><span lang="en-US">cmd</span></span></p>
<p lang="en-US" style="margin:0in; font-size:14pt">&nbsp;</p>
<p lang="en-US" style="margin:0in; font-size:14pt">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="20335087822357" alt=""><br>
</p>
<p lang="en-US" style="margin:0in; font-size:14pt">&nbsp; &nbsp; &nbsp;<img src="30580217187255" alt=""><br>
</p>
<p lang="en-US" style="margin:0in; font-size:14pt"><br>
</p>
<p lang="en-US" style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">查看生成的代理类：</span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><img src="50986265403620" alt=""><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">其中生成的相应方法为：</span></p>
<p style="margin:0in; font-size:14pt">&nbsp;</p>
<pre code_snippet_id="485475" snippet_file_name="blog_20141016_2_3842031" name="code" class="csharp"> public System.Nullable&lt;int&gt; CreateTicket()
    {
        CreateTicketRequest inValue = new CreateTicketRequest();
        CreateTicketResponse retVal = ((IDocumentReview)(this)).CreateTicket(inValue);
        return retVal.@int;
    }
</pre><br>
<p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312">WindowsForms：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">我们接下来要设计一个</span><span lang="en-US">Windows Forms的客户端程序，来使用该服务，发起流程的操作</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">将刚才工具所生成的两个文件添加到当前项目，并且将</span><span lang="en-US">output.config修改为app.config</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; margin-left:.375in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">如果客户端为</span><span lang="en-US">winform</span><span lang="zh-CN">或为</span><span lang="en-US">wpf</span><span lang="zh-CN">那么我们会将这个</span><span lang="en-US">output</span><span lang="zh-CN">改成</span><span lang="en-US">app.config</span></span></p>
<p style="margin:0in; margin-left:.375in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">如何客户端为</span><span lang="en-US">webform</span><span lang="zh-CN">，我们改名为</span><span lang="en-US">web.config</span></span></p>
<br>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">&nbsp; &nbsp; &nbsp;&nbsp;<img src="37732947347648" alt=""><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">客户端调用<br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">&nbsp; &nbsp;<img src="30769855962510" alt=""></span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">对应的代码：<br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<pre code_snippet_id="485475" snippet_file_name="blog_20141016_3_1791125" name="code" class="csharp"> public partial class Form1 : Form
    {
        public Form1()
        {
            InitializeComponent();
        }

        private void btCreate_Click(object sender, EventArgs e)
        {
            var proxy = new DocumentReviewClient();
            var result = proxy.CreateTicket();

            lstTickets.Items.Add(result);
        }
    }
</pre><br>
<br>
<p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">运行结果：</span></p>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="108707210194889" alt=""><br>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">附上整个应用程序说明：<br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="30743458768384" alt=""></span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">以上的示例是通过</span><span lang="en-US">WCF</span><span lang="zh-CN">实现的事件驱动方式，使用这种方式有几种优势：</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">1</span><span lang="zh-CN">：客户端调用这个工作流的服务是一个非常松的耦合（代理）</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">2</span><span lang="zh-CN">：可以实现工作流结点往客户端返回&#20540;</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">3</span><span lang="zh-CN">：也是启动工作流的另一种方式</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">总结：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">对于学习来说，我们大家都是从不懂到理解更加深刻，也许到现在我们对工作流的理解还存在偏差，还有好多疑问，但是随着学习的不断深入，理解也在不断深入，记得刚开始看关于工作流中的事件驱动时的不理解，但随着不断的学习，我们自己也在不断解决自己的疑问，相信这就是学习的过程！</span></p>
<br>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-family:SimSun; font-size:14.0pt"><span lang="zh-CN"><br>
</span></p>
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/40143397'>原文链接</a>