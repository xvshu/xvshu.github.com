<div style="color:blue" align=center>JAVA学习篇JSP实现原理</div><br><div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

<p><span style="font-family:KaiTi_GB2312"><br>
</span></p>
<p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">JSP全称是Java</span><span lang="en-US">&nbsp;Server&nbsp;Pages，它和servle技术一样，都是SUN公司定义的一种用于开发动态web资源的技术。</span></span></p>
<p lang="en-US" style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">起源：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">在很多动态网页中，绝大部分内容都是固定不变的，只有局部内容需要动态产生和改变。如果使用Servlet程序来输出只有局部内容需要动态改变的网页，其中所有的静态内容也需要程序员用Java程序代码产生，整个Servlet程序的代码将非常臃肿，编写和维护都将非常困难。</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">解决方案：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">为了弥补Servlet的缺陷，SUN公司在Servlet的基础上推出了JSP（Java</span><span lang="en-US">&nbsp;Server&nbsp;Pages）技术作为解决方案。JSP是简化Servlet编写的一种技术，它将Java代码和HTML语句混合在同一个文件中编写，只对网页中的要动态产生的内容采用Java代码来编写，而对固定不变的静态内容采用普通静态HTML页面的方式编写</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">与</span><span lang="en-US">Html</span><span lang="zh-CN">相比：</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">html只能为用户提供静态数据，而Jsp技术允许在页面中嵌套java代码，为用户提供动态数据。</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">与Servlet相比</span><span lang="en-US">:</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">servlet很难对数据进行排版，而jsp除了可以用java代码产生动态数据的同时，也很容易对数据进行排版，避免了</span><span lang="en-US">servlet</span><span lang="zh-CN">中编写大量的拼接</span><span lang="en-US">HTML</span><span lang="zh-CN">代码。</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">思考：JSP为什么可以像Servlet一样，也可以叫做动态web资源的开发技术？</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">解释：其实Jsp就是一个Servlet。下面是对这句话的具体解释！</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">JSP的调用过程原理图</span><span lang="en-US">:</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US"><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">&nbsp; &nbsp; &nbsp;<img src="47309909945596" alt="">&nbsp;</span></span></p>
<span style="font-family:KaiTi_GB2312"><br>
</span>
<p><br>
</p>
<p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">执行流程简介：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">1</span><span lang="zh-CN">，当WEB容器（Servlet引擎）接收到以.jsp为扩展名的URL的访问请求时，它将把该访问请求交给JSP引擎去处理。</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">2</span><span lang="zh-CN">，</span><span lang="en-US">T</span><span lang="zh-CN">omcat中的JSP引擎就是一个Servlet程序，它负责解释和执行JSP页面。</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">3</span><span lang="zh-CN">，当我们第一次访问Jsp的时候，Jsp引擎都会将这个Jsp翻译成一个Servlet，这个文件存放在Tomcat中的work目录中</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">4</span><span lang="zh-CN">，</span><span lang="en-US">接着再把这个Servlet源程序编译成Servlet的class类文件</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">5</span><span lang="zh-CN">，</span><span lang="en-US">然后再由WEB容器（Servlet引擎）像调用普通Servlet程序一样的方式来装载和解释执行这个由JSP页面翻译成的Servlet程序。</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">具体代码示例：</span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">&nbsp;</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">jsp</span><span lang="zh-CN">页面</span><span lang="en-US">:</span></span></p>
<span style="font-family:KaiTi_GB2312"><br>
</span>
<p><span style="font-family:KaiTi_GB2312"></span></p>
<pre name="code" class="html">&lt;html&gt;
	&lt;head&gt;
		&lt;title&gt; HelloWorld &lt;/title&gt;
	&lt;/head&gt;
	&lt;body&gt;
		&lt;%
			out.println(&quot;HelloWorld&quot;);
		%&gt;
	&lt;/body&gt;
&lt;/html&gt;</pre>
<p>
<p>
<p><br>
</p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">在</span><span lang="en-US">tomcat</span><span lang="zh-CN">的</span><span lang="en-US">conf</span><span lang="zh-CN">文件中的</span><span lang="en-US">web.xml</span><span lang="zh-CN">中</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN"><br>
</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<pre name="code" class="html">&lt;servlet&gt;
        &lt;servlet-name&gt;jsp&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.apache.jasper.servlet.JspServlet&lt;/servlet-class&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;fork&lt;/param-name&gt;
            &lt;param-value&gt;false&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;xpoweredBy&lt;/param-name&gt;
            &lt;param-value&gt;false&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;load-on-startup&gt;3&lt;/load-on-startup&gt;
    &lt;/servlet&gt;

 &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;jsp&lt;/servlet-name&gt;
        &lt;url-pattern&gt;*.jsp&lt;/url-pattern&gt;
 &lt;/servlet-mapping&gt;

 &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;jsp&lt;/servlet-name&gt;
        &lt;url-pattern&gt;*.jspx&lt;/url-pattern&gt;
 &lt;/servlet-mapping&gt;
</pre><br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="en-US">tomcat</span><span lang="zh-CN">源码中</span><span lang="en-US">JSPServlet</span><span lang="zh-CN">类的实现。</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">这个类主要也是继承HttpServlet。重写了HttpServlet的</span><span lang="en-US">service</span><span lang="zh-CN">方法。</span></span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">如果</span><span lang="en-US">jsp</span><span lang="zh-CN">第一次使用，要将它编译成</span><span lang="en-US">servlet</span><span lang="zh-CN">。编译好后将生成我们相关的文件即HelloWorld_jsp.java</span></span></p>
<br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<pre name="code" class="java"> public void service (HttpServletRequest request, 
    			 HttpServletResponse response)
                throws ServletException, IOException {

        String jspUri = null;

        String jspFile = (String) request.getAttribute(Constants.JSP_FILE);
        if (jspFile != null) {
            // JSP is specified via &lt;jsp-file&gt; in &lt;servlet&gt; declaration
            jspUri = jspFile;
        } else {
            /*
             * Check to see if the requested JSP has been the target of a
             * RequestDispatcher.include()
             */
            jspUri = (String) request.getAttribute(Constants.INC_SERVLET_PATH);
            if (jspUri != null) {
                /*
		 * Requested JSP has been target of
                 * RequestDispatcher.include(). Its path is assembled from the
                 * relevant javax.servlet.include.* request attributes
                 */
                String pathInfo = (String) request.getAttribute(
                                    &quot;javax.servlet.include.path_info&quot;);
                if (pathInfo != null) {
                    jspUri += pathInfo;
                }
            } else {
                /*
                 * Requested JSP has not been the target of a 
                 * RequestDispatcher.include(). Reconstruct its path from the
                 * request&#39;s getServletPath() and getPathInfo()
                 */
                jspUri = request.getServletPath();
                String pathInfo = request.getPathInfo();
                if (pathInfo != null) {
                    jspUri += pathInfo;
                }
            }
        }

        if (log.isDebugEnabled()) {	    
            log.debug(&quot;JspEngine --&gt; &quot; + jspUri);
            log.debug(&quot;\t     ServletPath: &quot; + request.getServletPath());
            log.debug(&quot;\t        PathInfo: &quot; + request.getPathInfo());
            log.debug(&quot;\t        RealPath: &quot; + context.getRealPath(jspUri));
            log.debug(&quot;\t      RequestURI: &quot; + request.getRequestURI());
            log.debug(&quot;\t     QueryString: &quot; + request.getQueryString());
        }

        try {
            boolean precompile = preCompile(request);
            serviceJspFile(request, response, jspUri, null, precompile);
        } catch (RuntimeException e) {
            throw e;
        } catch (ServletException e) {
            throw e;
        } catch (IOException e) {
            throw e;
        } catch (Throwable e) {
            throw new ServletException(e);
        }

    }
</pre><br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">生成的</span><span lang="en-US">servlet</span><span lang="zh-CN">类</span><span lang="en-US">--</span><span lang="zh-CN">HelloWorld_jsp.java</span></span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"><br>
</span></p>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"></span></p>
<pre name="code" class="java">package org.apache.jsp;

import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.jsp.*;

public final class HelloWorld_jsp extends org.apache.jasper.runtime.HttpJspBase
    implements org.apache.jasper.runtime.JspSourceDependent {

  private static java.util.List _jspx_dependants;

  public Object getDependants() {
    return _jspx_dependants;
  }

  public void _jspService(HttpServletRequest request, HttpServletResponse response)
        throws java.io.IOException, ServletException {

    JspFactory _jspxFactory = null;
    PageContext pageContext = null;
    HttpSession session = null;
    ServletContext application = null;
    ServletConfig config = null;
    JspWriter out = null;
    Object page = this;
    JspWriter _jspx_out = null;
    PageContext _jspx_page_context = null;


    try {
      _jspxFactory = JspFactory.getDefaultFactory();
      response.setContentType(&quot;text/html&quot;);
      pageContext = _jspxFactory.getPageContext(this, request, response,
      			null, true, 8192, true);
      _jspx_page_context = pageContext;
      application = pageContext.getServletContext();
      config = pageContext.getServletConfig();
      session = pageContext.getSession();
      out = pageContext.getOut();
      _jspx_out = out;

      out.write(&quot;&lt;html&gt;\r\n&quot;);
      out.write(&quot;\t&lt;head&gt;\r\n&quot;);
      out.write(&quot;\t\t&lt;title&gt;HelloWorld&lt;/title&gt;\r\n&quot;);
      out.write(&quot;\t&lt;/head&gt;\r\n&quot;);
      out.write(&quot;\t&lt;body&gt;\r\n&quot;);
      out.write(&quot;\t\t&quot;);
 out.println(&quot;HelloWorld&quot;);
      out.write(&quot;\r\n&quot;);
      out.write(&quot;\t&lt;/body&gt;\r\n&quot;);
      out.write(&quot;&lt;/html&gt;&quot;);
    } catch (Throwable t) {
      if (!(t instanceof SkipPageException)){
        out = _jspx_out;
        if (out != null &amp;&amp; out.getBufferSize() != 0)
          out.clearBuffer();
        if (_jspx_page_context != null) _jspx_page_context.handlePageException(t);
      }
    } finally {
      if (_jspxFactory != null) _jspxFactory.releasePageContext(_jspx_page_context);
    }
  }
}
</pre><br>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312">我们看到，这个类继承了org.apache.jasper.runtime.HttpJspBase，具体HttpJspBase类的tomcat的源码如下：</span></p>
<p style="margin:0in; font-size:14.0pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">根据时序图，首先调用</span><span lang="en-US">service</span><span lang="zh-CN">方法，然后</span><span lang="en-US">service</span><span lang="zh-CN">方法内部调用_jspService抽象方法，此方法并没有实现，故继承它的HelloWorld_jsp.java类实现。</span></span></p>
<br>
<p style="margin:0in; font-size:14pt"><span lang="zh-CN"></span></p>
<pre name="code" class="java">package org.apache.jasper.runtime;

import java.io.IOException;

import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.jsp.HttpJspPage;
import javax.servlet.jsp.JspFactory;

import org.apache.jasper.compiler.Localizer;

/**
 * This is the super class of all JSP-generated servlets.
 *
 * @author Anil K. Vijendran
 */
public abstract class HttpJspBase 
    extends HttpServlet 
    implements HttpJspPage 
        
    
{
    
    protected HttpJspBase() {
    }

    public final void init(ServletConfig config) 
	throws ServletException 
    {
        super.init(config);
	jspInit();
        _jspInit();
    }
    
    public String getServletInfo() {
	return Localizer.getMessage(&quot;jsp.engine.info&quot;);
    }

    public final void destroy() {
	jspDestroy();
	_jspDestroy();
    }

    /**
     * Entry point into service.
     */
    public final void service(HttpServletRequest request, HttpServletResponse response) 
	throws ServletException, IOException 
    {
        _jspService(request, response);
    }
    
    public void jspInit() {
    }

    public void _jspInit() {
    }

    public void jspDestroy() {
    }

    protected void _jspDestroy() {
    }

    public abstract void _jspService(HttpServletRequest request, 
				     HttpServletResponse response) 
	throws ServletException, IOException;
}
</pre><br>
<p style="margin:0in; font-size:14.0pt"><span lang="zh-CN"><span style="font-family:KaiTi_GB2312"></span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">如果</span><span lang="en-US">:</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN">让jsp既用java代码产生动态数据，又做美化会导致</span><span lang="en-US">jsp</span><span lang="zh-CN">的职责过重且页面难以维护。</span></span></p>
<p style="margin:0in; font-size:14pt"><span style=""><span style="font-family:KaiTi_GB2312">让servlet既产生数据，又在里面嵌套html代码美化数据，同样也会导致程序可读性差，难以维护。</span></span></p>
<p style="margin:0in; font-size:14pt"><span style=""><span style="font-family:KaiTi_GB2312"><br>
</span></span></p>
<p style="margin:0in; font-size:14pt"><span style=""><span style="font-family:KaiTi_GB2312">总结：</span></span></p>
<p style="margin:0in; font-size:14pt"><span style=""><span style="font-family:KaiTi_GB2312">&nbsp;</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN" style="font-size:14pt">&nbsp;</span><span lang="en-US" style="font-size:14pt"></span><span lang="zh-CN" style="font-size:14pt">&nbsp;</span><span lang="en-US" style="font-size:14pt"></span><span lang="zh-CN" style="font-size:14pt">&nbsp;</span><span lang="en-US" style="font-size:14pt"></span><span lang="zh-CN" style="font-size:14pt">不管是</span><span lang="en-US" style="font-size:14pt">JSP</span><span lang="zh-CN" style="font-size:14pt">还是</span><span lang="en-US" style="font-size:14pt">Servlet</span><span lang="zh-CN" style="font-size:14pt">，都可以用于开发动态</span><span lang="en-US" style="font-size:14pt">web</span><span lang="zh-CN" style="font-size:14pt">资源（学习的共同点）。但由于这</span><span lang="en-US" style="font-size:14pt">2</span><span lang="zh-CN" style="font-size:14pt">门技术各自的特点，在长期的软件实践中，人们逐渐把</span><span lang="en-US" style="font-size:14pt">servlet</span><span lang="zh-CN" style="font-size:14pt">作为</span><span lang="en-US" style="font-size:14pt">web</span><span lang="zh-CN" style="font-size:14pt">应用中的控制器组件来使用，而把</span><span lang="en-US" style="font-size:14pt">JSP</span><span lang="zh-CN" style="font-size:14pt">技术作为数据显示模板来使用（不同点，也可以说发挥各自优势！其中，</span><span lang="zh-CN" style="font-size:14.25pt">JSP对于程序员来说省去了在后台手动拼接html代码的过程</span><span lang="zh-CN" style="font-size:14pt">）。</span></span></p>
<p style="margin:0in; font-size:14pt"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN" style="">&nbsp;</span><span lang="en-US" style=""></span><span lang="zh-CN" style="">&nbsp;</span><span lang="en-US" style=""></span><span lang="zh-CN" style="">&nbsp;</span><span lang="en-US" style=""></span><span lang="zh-CN" style="">因此最好的办法就是根据这两门技术的特点，让它们各自负责各的，</span><span lang="en-US" style="">servlet</span><span lang="zh-CN" style="">只负责响应请求产生数据，并把数据通过转发技术带给</span><span lang="en-US" style="">jsp</span><span lang="zh-CN" style="">，数据的显示</span><span lang="en-US" style="">jsp</span><span lang="zh-CN" style="">来做，这样职责单一，容易维护也正符合我们软件设计中的分层与单一职责等思想。</span></span></p>
<p style="margin:0in"><span style="font-family:KaiTi_GB2312"><span lang="zh-CN" style="font-size:14pt">&nbsp;</span><span lang="en-US" style="font-size:14pt"></span><span lang="zh-CN" style="font-size:14pt">&nbsp;</span><span lang="en-US" style="font-size:14pt"></span><span lang="zh-CN" style="font-size:14pt">&nbsp;</span><span lang="en-US" style="font-size:14pt"></span><span lang="zh-CN" style="font-size:14pt">其实我们学习的各类技术以及各种设计模式，它们的</span><span lang="zh-CN" style="font-size:14.25pt">出现</span><span lang="zh-CN" style="font-size:14pt">或</span><span lang="zh-CN" style="font-size:14.25pt">形成</span><span lang="zh-CN" style="font-size:14pt">都是软件设计思想的一种体现！</span></span></p>
<br>
<span style="font-family:KaiTi_GB2312"><br>
</span>
<p><br>
</p>
   
</div><div class="ArcitleLink"><a href='http://blog.csdn.net/hejingyuan6/article/details/32330759'>原文链接</a>